diff --git a/dist/cjs/internal/http/server.js b/dist/cjs/internal/http/server.js
index dac017acd7fe0a4d6a6bcf8f6cb34b2d8f369c73..6997b77c40881c357e60d985130d15990df6fed9 100644
--- a/dist/cjs/internal/http/server.js
+++ b/dist/cjs/internal/http/server.js
@@ -18,6 +18,7 @@ var Socket = /*#__PURE__*/_interopRequireWildcard( /*#__PURE__*/require("@effect
 var Cause = /*#__PURE__*/_interopRequireWildcard( /*#__PURE__*/require("effect/Cause"));
 var Config = /*#__PURE__*/_interopRequireWildcard( /*#__PURE__*/require("effect/Config"));
 var Effect = /*#__PURE__*/_interopRequireWildcard( /*#__PURE__*/require("effect/Effect"));
+var FiberSet = /*#__PURE__*/_interopRequireWildcard( /*#__PURE__*/require("effect/FiberSet"));
 var Layer = /*#__PURE__*/_interopRequireWildcard( /*#__PURE__*/require("effect/Layer"));
 var Option = /*#__PURE__*/_interopRequireWildcard( /*#__PURE__*/require("effect/Option"));
 var Runtime = /*#__PURE__*/_interopRequireWildcard( /*#__PURE__*/require("effect/Runtime"));
@@ -109,8 +110,7 @@ const make = (evaluate, options) => Effect.gen(function* (_) {
 exports.make = make;
 const makeHandler = (httpApp, middleware) => {
   const handledApp = Effect.scoped(middleware ? middleware(App.withDefaultMiddleware(respond(httpApp))) : App.withDefaultMiddleware(respond(httpApp)));
-  return Effect.map(Effect.runtime(), runtime => {
-    const runFork = Runtime.runFork(runtime);
+  return Effect.map(FiberSet.makeRuntime(), runFork => {
     return function handler(nodeRequest, nodeResponse) {
       const fiber = runFork(Effect.provideService(handledApp, ServerRequest.ServerRequest, new ServerRequestImpl(nodeRequest, nodeResponse)));
       nodeResponse.on("close", () => {
diff --git a/dist/cjs/internal/http/server.js.map b/dist/cjs/internal/http/server.js.map
index 706ace313037dbc84959c6622540d27fe34190ff..cbcdf4d6de5ca2de76fdfb2f506adbd5a06381e3 100644
--- a/dist/cjs/internal/http/server.js.map
+++ b/dist/cjs/internal/http/server.js.map
@@ -1 +1 @@
-{"version":3,"file":"server.js","names":["Etag","_interopRequireWildcard","require","MultipartNode","FileSystem","App","Cookies","IncomingMessage","Middleware","Server","Error","ServerRequest","Socket","Cause","Config","Effect","Layer","Option","Runtime","Scope","Stream","Http","_nodeStream","_promises","WS","NodeContext","NodeSink","_incomingMessage","internalPlatform","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","make","evaluate","options","gen","_","scope","server","acquireRelease","sync","async","resume","close","error","die","unit","on","fail","ServeError","listen","address","wss","WebSocketServer","noServer","extend","cached","_tag","path","hostname","port","serve","httpApp","middleware","handler","makeHandler","upgradeHandler","makeUpgradeHandler","addFinalizer","off","pipe","locally","maxBodySize","some","Size","exports","handledApp","scoped","withDefaultMiddleware","respond","map","runtime","runFork","nodeRequest","nodeResponse","fiber","provideService","ServerRequestImpl","writableEnded","headersSent","writeHead","end","interruptAsFork","clientAbortFiberId","lazyWss","socket","head","nodeResponse_","undefined","ServerResponse","assignSocket","upgradeEffect","fromWebSocket","flatMap","handleUpgrade","ws","succeed","res","uninterruptibleMask","restore","request","tapErrorCause","tap","response","preResponseHandler","f","handleResponse","cause","resolvedResponse","isInterruptedOnly","IncomingMessageImpl","source","url","headersOverride","TypeId","constructor","remoteAddressOverride","RequestError","reason","cachedCookies","cookies","parseHeader","headers","cookie","modify","remoteAddress","originalUrl","method","toUpperCase","multipartEffect","multipart","runSync","persisted","multipartStream","stream","upgrade","toString","toJSON","inspect","_id","layerServer","layer","mergeAll","layerWeak","layerConfig","unwrap","suspend","isEmpty","toSet","toSetCookieHeaders","push","status","body","tryPromise","try","signal","pipeline","catch","ResponseError","Response","formData","fromEntries","Readable","fromWeb","once","run","mapError","fromWritable","requestSource","self"],"sources":["../../../../src/internal/http/server.ts"],"sourcesContent":[null],"mappings":";;;;;;AAAA,IAAAA,IAAA,gBAAAC,uBAAA,eAAAC,OAAA;AACA,IAAAC,aAAA,gBAAAF,uBAAA,eAAAC,OAAA;AACA,IAAAE,UAAA,gBAAAH,uBAAA,eAAAC,OAAA;AACA,IAAAG,GAAA,gBAAAJ,uBAAA,eAAAC,OAAA;AACA,IAAAI,OAAA,gBAAAL,uBAAA,eAAAC,OAAA;AAEA,IAAAK,eAAA,gBAAAN,uBAAA,eAAAC,OAAA;AAEA,IAAAM,UAAA,gBAAAP,uBAAA,eAAAC,OAAA;AAEA,IAAAO,MAAA,gBAAAR,uBAAA,eAAAC,OAAA;AACA,IAAAQ,KAAA,gBAAAT,uBAAA,eAAAC,OAAA;AACA,IAAAS,aAAA,gBAAAV,uBAAA,eAAAC,OAAA;AAGA,IAAAU,MAAA,gBAAAX,uBAAA,eAAAC,OAAA;AACA,IAAAW,KAAA,gBAAAZ,uBAAA,eAAAC,OAAA;AACA,IAAAY,MAAA,gBAAAb,uBAAA,eAAAC,OAAA;AACA,IAAAa,MAAA,gBAAAd,uBAAA,eAAAC,OAAA;AAEA,IAAAc,KAAA,gBAAAf,uBAAA,eAAAC,OAAA;AACA,IAAAe,MAAA,gBAAAhB,uBAAA,eAAAC,OAAA;AAEA,IAAAgB,OAAA,gBAAAjB,uBAAA,eAAAC,OAAA;AACA,IAAAiB,KAAA,gBAAAlB,uBAAA,eAAAC,OAAA;AACA,IAAAkB,MAAA,gBAAAnB,uBAAA,eAAAC,OAAA;AACA,IAAAmB,IAAA,gBAAApB,uBAAA,eAAAC,OAAA;AAGA,IAAAoB,WAAA,gBAAApB,OAAA;AACA,IAAAqB,SAAA,gBAAArB,OAAA;AACA,IAAAsB,EAAA,gBAAAvB,uBAAA,eAAAC,OAAA;AACA,IAAAuB,WAAA,gBAAAxB,uBAAA,eAAAC,OAAA;AACA,IAAAwB,QAAA,gBAAAzB,uBAAA,eAAAC,OAAA;AACA,IAAAyB,gBAAA,gBAAAzB,OAAA;AACA,IAAA0B,gBAAA,gBAAA3B,uBAAA,eAAAC,OAAA;AAAiD,SAAA2B,yBAAAC,CAAA;EAAA,yBAAAC,OAAA;EAAA,IAAAC,CAAA,OAAAD,OAAA;IAAAE,CAAA,OAAAF,OAAA;EAAA,QAAAF,wBAAA,YAAAA,CAAAC,CAAA;IAAA,OAAAA,CAAA,GAAAG,CAAA,GAAAD,CAAA;EAAA,GAAAF,CAAA;AAAA;AAAA,SAAA7B,wBAAA6B,CAAA,EAAAE,CAAA;EAAA,KAAAA,CAAA,IAAAF,CAAA,IAAAA,CAAA,CAAAI,UAAA,SAAAJ,CAAA;EAAA,aAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA;IAAAK,OAAA,EAAAL;EAAA;EAAA,IAAAG,CAAA,GAAAJ,wBAAA,CAAAG,CAAA;EAAA,IAAAC,CAAA,IAAAA,CAAA,CAAAG,GAAA,CAAAN,CAAA,UAAAG,CAAA,CAAAI,GAAA,CAAAP,CAAA;EAAA,IAAAQ,CAAA;MAAAC,SAAA;IAAA;IAAAC,CAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA;EAAA,SAAAC,CAAA,IAAAd,CAAA,oBAAAc,CAAA,OAAAC,cAAA,CAAAC,IAAA,CAAAhB,CAAA,EAAAc,CAAA;IAAA,IAAAG,CAAA,GAAAP,CAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAb,CAAA,EAAAc,CAAA;IAAAG,CAAA,KAAAA,CAAA,CAAAV,GAAA,IAAAU,CAAA,CAAAC,GAAA,IAAAP,MAAA,CAAAC,cAAA,CAAAJ,CAAA,EAAAM,CAAA,EAAAG,CAAA,IAAAT,CAAA,CAAAM,CAAA,IAAAd,CAAA,CAAAc,CAAA;EAAA;EAAA,OAAAN,CAAA,CAAAH,OAAA,GAAAL,CAAA,EAAAG,CAAA,IAAAA,CAAA,CAAAe,GAAA,CAAAlB,CAAA,EAAAQ,CAAA,GAAAA,CAAA;AAAA;AAEjD;AACO,MAAMW,IAAI,GAAGA,CAClBC,QAA8B,EAC9BC,OAA0B,KAE1BpC,MAAM,CAACqC,GAAG,CAAC,WAAUC,CAAC;EACpB,MAAMC,KAAK,GAAG,OAAOD,CAAC,CAACtC,MAAM,CAACuC,KAAK,CAAC;EAEpC,MAAMC,MAAM,GAAG,OAAOF,CAAC,CAACtC,MAAM,CAACyC,cAAc,CAC3CzC,MAAM,CAAC0C,IAAI,CAACP,QAAQ,CAAC,EACpBK,MAAM,IACLxC,MAAM,CAAC2C,KAAK,CAAQC,MAAM,IAAI;IAC5BJ,MAAM,CAACK,KAAK,CAAEC,KAAK,IAAI;MACrB,IAAIA,KAAK,EAAE;QACTF,MAAM,CAAC5C,MAAM,CAAC+C,GAAG,CAACD,KAAK,CAAC,CAAC;MAC3B,CAAC,MAAM;QACLF,MAAM,CAAC5C,MAAM,CAACgD,IAAI,CAAC;MACrB;IACF,CAAC,CAAC;EACJ,CAAC,CAAC,CACL,CAAC;EAEF,OAAOV,CAAC,CAACtC,MAAM,CAAC2C,KAAK,CAA0BC,MAAM,IAAI;IACvDJ,MAAM,CAACS,EAAE,CAAC,OAAO,EAAGH,KAAK,IAAI;MAC3BF,MAAM,CAAC5C,MAAM,CAACkD,IAAI,CAAC,IAAIvD,KAAK,CAACwD,UAAU,CAAC;QAAEL;MAAK,CAAE,CAAC,CAAC,CAAC;IACtD,CAAC,CAAC;IACFN,MAAM,CAACY,MAAM,CAAChB,OAAO,EAAE,MAAK;MAC1BQ,MAAM,CAAC5C,MAAM,CAACgD,IAAI,CAAC;IACrB,CAAC,CAAC;EACJ,CAAC,CAAC,CAAC;EAEH,MAAMK,OAAO,GAAGb,MAAM,CAACa,OAAO,EAAG;EAEjC,MAAMC,GAAG,GAAG,OAAOhB,CAAC,CAClBtC,MAAM,CAACyC,cAAc,CACnBzC,MAAM,CAAC0C,IAAI,CAAC,MAAM,IAAIjC,EAAE,CAAC8C,eAAe,CAAC;IAAEC,QAAQ,EAAE;EAAI,CAAE,CAAC,CAAC,EAC5DF,GAAG,IACFtD,MAAM,CAAC2C,KAAK,CAAQC,MAAM,IAAI;IAC5BU,GAAG,CAACT,KAAK,CAAC,MAAMD,MAAM,CAAC5C,MAAM,CAACgD,IAAI,CAAC,CAAC;EACtC,CAAC,CAAC,CACL,EACD5C,KAAK,CAACqD,MAAM,CAAClB,KAAK,CAAC,EACnBvC,MAAM,CAAC0D,MAAM,CACd;EAED,OAAOhE,MAAM,CAACwC,IAAI,CAAC;IACjBmB,OAAO,EAAE,OAAOA,OAAO,KAAK,QAAQ,GAClC;MACEM,IAAI,EAAE,aAAa;MACnBC,IAAI,EAAEP;KACP,GACD;MACEM,IAAI,EAAE,YAAY;MAClBE,QAAQ,EAAER,OAAO,CAACA,OAAO,KAAK,IAAI,GAAG,SAAS,GAAGA,OAAO,CAACA,OAAO;MAChES,IAAI,EAAET,OAAO,CAACS;KACf;IACHC,KAAK,EAAEA,CAACC,OAAO,EAAEC,UAAU,KACzBjE,MAAM,CAACqC,GAAG,CAAC,WAAUC,CAAC;MACpB,MAAM4B,OAAO,GAAG,OAAO5B,CAAC,CAAC6B,WAAW,CAACH,OAAO,EAAEC,UAAW,CAAC,CAAC;MAC3D,MAAMG,cAAc,GAAG,OAAO9B,CAAC,CAAC+B,kBAAkB,CAACf,GAAG,EAAEU,OAAO,EAAEC,UAAW,CAAC,CAAC;MAC9E,OAAO3B,CAAC,CAACtC,MAAM,CAACsE,YAAY,CAAC,MAC3BtE,MAAM,CAAC0C,IAAI,CAAC,MAAK;QACfF,MAAM,CAAC+B,GAAG,CAAC,SAAS,EAAEL,OAAO,CAAC;QAC9B1B,MAAM,CAAC+B,GAAG,CAAC,SAAS,EAAEH,cAAc,CAAC;MACvC,CAAC,CAAC,CACH,CAAC;MACF5B,MAAM,CAACS,EAAE,CAAC,SAAS,EAAEiB,OAAO,CAAC;MAC7B1B,MAAM,CAACS,EAAE,CAAC,SAAS,EAAEmB,cAAc,CAAC;IACtC,CAAC;GACJ,CAAC;AACJ,CAAC,CAAC,CAACI,IAAI,CACLxE,MAAM,CAACyE,OAAO,CACZjF,eAAe,CAACkF,WAAW,EAC3BxE,MAAM,CAACyE,IAAI,CAACtF,UAAU,CAACuF,IAAI,CAAC,IAAI,GAAG,IAAI,GAAG,EAAE,CAAC,CAAC,CAC/C,CACF;AAEH;AAAAC,OAAA,CAAA3C,IAAA,GAAAA,IAAA;AACO,MAAMiC,WAAW,GAcpBA,CAAOH,OAA0B,EAAEC,UAAkC,KAAI;EAC3E,MAAMa,UAAU,GAAG9E,MAAM,CAAC+E,MAAM,CAC9Bd,UAAU,GACNA,UAAU,CAAC3E,GAAG,CAAC0F,qBAAqB,CAACC,OAAO,CAACjB,OAAO,CAAC,CAAC,CAAC,GACvD1E,GAAG,CAAC0F,qBAAqB,CAACC,OAAO,CAACjB,OAAO,CAAC,CAAC,CAChD;EACD,OAAOhE,MAAM,CAACkF,GAAG,CAAClF,MAAM,CAACmF,OAAO,EAAK,EAAGA,OAAO,IAAI;IACjD,MAAMC,OAAO,GAAGjF,OAAO,CAACiF,OAAO,CAACD,OAAO,CAAC;IACxC,OAAO,SAASjB,OAAOA,CACrBmB,WAAiC,EACjCC,YAAiC;MAEjC,MAAMC,KAAK,GAAGH,OAAO,CACnBpF,MAAM,CAACwF,cAAc,CACnBV,UAAU,EACVlF,aAAa,CAACA,aAAa,EAC3B,IAAI6F,iBAAiB,CAACJ,WAAW,EAAEC,YAAY,CAAC,CACjD,CACF;MACDA,YAAY,CAACrC,EAAE,CAAC,OAAO,EAAE,MAAK;QAC5B,IAAI,CAACqC,YAAY,CAACI,aAAa,EAAE;UAC/B,IAAI,CAACJ,YAAY,CAACK,WAAW,EAAE;YAC7BL,YAAY,CAACM,SAAS,CAAC,GAAG,CAAC;UAC7B;UACAN,YAAY,CAACO,GAAG,EAAE;UAClBT,OAAO,CAACG,KAAK,CAACO,eAAe,CAACnG,KAAK,CAACoG,kBAAkB,CAAC,CAAC;QAC1D;MACF,CAAC,CAAC;IACJ,CAAC;EACH,CAAC,CAAC;AACJ,CAAC;AAED;AAAAlB,OAAA,CAAAV,WAAA,GAAAA,WAAA;AACO,MAAME,kBAAkB,GAAGA,CAChC2B,OAA0C,EAC1ChC,OAA0B,EAC1BC,UAAkC,KAChC;EACF,MAAMa,UAAU,GAAG9E,MAAM,CAAC+E,MAAM,CAC9Bd,UAAU,GACNA,UAAU,CAAC3E,GAAG,CAAC0F,qBAAqB,CAACC,OAAO,CAACjB,OAAO,CAAC,CAAC,CAAC,GACvD1E,GAAG,CAAC0F,qBAAqB,CAACC,OAAO,CAACjB,OAAO,CAAC,CAAC,CAChD;EACD,OAAOhE,MAAM,CAACkF,GAAG,CAAClF,MAAM,CAACmF,OAAO,EAAK,EAAGA,OAAO,IAAI;IACjD,MAAMC,OAAO,GAAGjF,OAAO,CAACiF,OAAO,CAACD,OAAO,CAAC;IACxC,OAAO,SAASjB,OAAOA,CACrBmB,WAAiC,EACjCY,MAAc,EACdC,IAAY;MAEZ,IAAIC,aAAa,GAAoCC,SAAS;MAC9D,MAAMd,YAAY,GAAGA,CAAA,KAAK;QACxB,IAAIa,aAAa,KAAKC,SAAS,EAAE;UAC/BD,aAAa,GAAG,IAAI7F,IAAI,CAAC+F,cAAc,CAAChB,WAAW,CAAC;UACpDc,aAAa,CAACG,YAAY,CAACL,MAAa,CAAC;QAC3C;QACA,OAAOE,aAAa;MACtB,CAAC;MACD,MAAMI,aAAa,GAAG1G,MAAM,CAAC2G,aAAa,CAACxG,MAAM,CAACyG,OAAO,CACvDT,OAAO,EACN1C,GAAG,IACFtD,MAAM,CAACyC,cAAc,CACnBzC,MAAM,CAAC2C,KAAK,CAAwBC,MAAM,IACxCU,GAAG,CAACoD,aAAa,CAACrB,WAAW,EAAEY,MAAM,EAAEC,IAAI,EAAGS,EAAE,IAAI;QAClD/D,MAAM,CAAC5C,MAAM,CAAC4G,OAAO,CAACD,EAAS,CAAC,CAAC;MACnC,CAAC,CAAC,CACH,EACAA,EAAE,IAAK3G,MAAM,CAAC0C,IAAI,CAAC,MAAMiE,EAAE,CAAC9D,KAAK,EAAE,CAAC,CACtC,CACJ,CAAC;MACF,MAAM0C,KAAK,GAAGH,OAAO,CACnBpF,MAAM,CAACwF,cAAc,CACnBV,UAAU,EACVlF,aAAa,CAACA,aAAa,EAC3B,IAAI6F,iBAAiB,CAACJ,WAAW,EAAEC,YAAY,EAAEiB,aAAa,CAAC,CAChE,CACF;MACDN,MAAM,CAAChD,EAAE,CAAC,OAAO,EAAE,MAAK;QACtB,MAAM4D,GAAG,GAAGvB,YAAY,EAAE;QAC1B,IAAI,CAACW,MAAM,CAACP,aAAa,EAAE;UACzB,IAAI,CAACmB,GAAG,CAAClB,WAAW,EAAE;YACpBkB,GAAG,CAACjB,SAAS,CAAC,GAAG,CAAC;UACpB;UACAiB,GAAG,CAAChB,GAAG,EAAE;UACTT,OAAO,CAACG,KAAK,CAACO,eAAe,CAACnG,KAAK,CAACoG,kBAAkB,CAAC,CAAC;QAC1D;MACF,CAAC,CAAC;IACJ,CAAC;EACH,CAAC,CAAC;AACJ,CAAC;AAAAlB,OAAA,CAAAR,kBAAA,GAAAA,kBAAA;AAED,MAAMY,OAAO,gBAAGxF,UAAU,CAACyC,IAAI,CAAE8B,OAAO,IACtChE,MAAM,CAAC8G,mBAAmB,CAAEC,OAAO,IACjC/G,MAAM,CAACyG,OAAO,CAAC7G,aAAa,CAACA,aAAa,EAAGoH,OAAO,IAClDhH,MAAM,CAACiH,aAAa,CAClBF,OAAO,CACL/G,MAAM,CAACkH,GAAG,CACRlH,MAAM,CAACyG,OAAO,CACZzC,OAAO,EACNmD,QAAQ,IAAKnH,MAAM,CAACyG,OAAO,CAACnH,GAAG,CAAC8H,kBAAkB,EAAGC,CAAC,IAAKA,CAAC,CAACL,OAAO,EAAEG,QAAQ,CAAC,CAAC,CAClF,EACAA,QAAQ,IAAKG,cAAc,CAACN,OAAO,EAAEG,QAAQ,CAAC,CAChD,CACF,EACAI,KAAK,IACJvH,MAAM,CAAC0C,IAAI,CAAC,MAAK;EACf,MAAM4C,YAAY,GAAI0B,OAA6B,CAACQ,gBAAgB;EACpE,IAAI,CAAClC,YAAY,CAACK,WAAW,EAAE;IAC7BL,YAAY,CAACM,SAAS,CAAC9F,KAAK,CAAC2H,iBAAiB,CAACF,KAAK,CAAC,GAAG,GAAG,GAAG,GAAG,CAAC;EACpE;EACA,IAAI,CAACjC,YAAY,CAACI,aAAa,EAAE;IAC/BJ,YAAY,CAACO,GAAG,EAAE;EACpB;AACF,CAAC,CAAC,CACL,CAAC,CACL,CACF;AAED,MAAMJ,iBAAkB,SAAQ7E,gBAAA,CAAA8G,mBAAuC;EAI1DC,MAAA;EACAR,QAAA;EACDZ,aAAA;EACCqB,GAAA;EACDC,eAAA;EAPD,CAACjI,aAAa,CAACkI,MAAM;EAE9BC,YACWJ,MAA4B,EAC5BR,QAA4D,EAC7DZ,aAAgE,EAC/DqB,GAAA,GAAMD,MAAM,CAACC,GAAI,EAClBC,eAAiC,EACzCG,qBAA8B;IAE9B,KAAK,CAACL,MAAM,EAAGrF,CAAC,IACd,IAAI3C,KAAK,CAACsI,YAAY,CAAC;MACrBjB,OAAO,EAAE,IAAI;MACbkB,MAAM,EAAE,QAAQ;MAChBpF,KAAK,EAAER;KACR,CAAC,EAAE0F,qBAAqB,CAAC;IAZnB,KAAAL,MAAM,GAANA,MAAM;IACN,KAAAR,QAAQ,GAARA,QAAQ;IACT,KAAAZ,aAAa,GAAbA,aAAa;IACZ,KAAAqB,GAAG,GAAHA,GAAG;IACJ,KAAAC,eAAe,GAAfA,eAAe;IASvB,IAAI,CAACjI,aAAa,CAACkI,MAAM,CAAC,GAAGlI,aAAa,CAACkI,MAAM;EACnD;EAEQK,aAAa;EACrB,IAAIC,OAAOA,CAAA;IACT,IAAI,IAAI,CAACD,aAAa,EAAE;MACtB,OAAO,IAAI,CAACA,aAAa;IAC3B;IACA,OAAO,IAAI,CAACA,aAAa,GAAG5I,OAAO,CAAC8I,WAAW,CAAC,IAAI,CAACC,OAAO,CAACC,MAAM,IAAI,EAAE,CAAC;EAC5E;EAEA,IAAIf,gBAAgBA,CAAA;IAClB,OAAO,OAAO,IAAI,CAACL,QAAQ,KAAK,UAAU,GAAG,IAAI,CAACA,QAAQ,EAAE,GAAG,IAAI,CAACA,QAAQ;EAC9E;EAEAqB,MAAMA,CACJpG,OAIC;IAED,OAAO,IAAIqD,iBAAiB,CAC1B,IAAI,CAACkC,MAAM,EACX,IAAI,CAACR,QAAQ,EACb,IAAI,CAACZ,aAAa,EAClBnE,OAAO,CAACwF,GAAG,IAAI,IAAI,CAACA,GAAG,EACvBxF,OAAO,CAACkG,OAAO,IAAI,IAAI,CAACT,eAAe,EACvCzF,OAAO,CAACqG,aAAa,IAAI,IAAI,CAACT,qBAAqB,CACpD;EACH;EAEA,IAAIU,WAAWA,CAAA;IACb,OAAO,IAAI,CAACf,MAAM,CAACC,GAAI;EACzB;EAEA,IAAIe,MAAMA,CAAA;IACR,OAAO,IAAI,CAAChB,MAAM,CAACgB,MAAO,CAACC,WAAW,EAAY;EACpD;EAEA,IAAIN,OAAOA,CAAA;IACT,IAAI,CAACT,eAAe,KAAK,IAAI,CAACF,MAAM,CAACW,OAA0B;IAC/D,OAAO,IAAI,CAACT,eAAe;EAC7B;EAEQgB,eAAe;EAOvB,IAAIC,SAASA,CAAA;IAKX,IAAI,IAAI,CAACD,eAAe,EAAE;MACxB,OAAO,IAAI,CAACA,eAAe;IAC7B;IACA,IAAI,CAACA,eAAe,GAAG7I,MAAM,CAAC+I,OAAO,CAAC/I,MAAM,CAAC0D,MAAM,CACjDtE,aAAa,CAAC4J,SAAS,CAAC,IAAI,CAACrB,MAAM,EAAE,IAAI,CAACA,MAAM,CAACW,OAAO,CAAC,CAC1D,CAAC;IACF,OAAO,IAAI,CAACO,eAAe;EAC7B;EAEA,IAAII,eAAeA,CAAA;IACjB,OAAO7J,aAAa,CAAC8J,MAAM,CAAC,IAAI,CAACvB,MAAM,EAAE,IAAI,CAACA,MAAM,CAACW,OAAO,CAAC;EAC/D;EAEA,IAAIa,OAAOA,CAAA;IACT,OAAO,IAAI,CAAC5C,aAAa,IAAIvG,MAAM,CAACkD,IAAI,CACtC,IAAIvD,KAAK,CAACsI,YAAY,CAAC;MACrBjB,OAAO,EAAE,IAAI;MACbkB,MAAM,EAAE,QAAQ;MAChBpF,KAAK,EAAE;KACR,CAAC,CACH;EACH;EAEAsG,QAAQA,CAAA;IACN,OAAO,iBAAiB,IAAI,CAACT,MAAM,IAAI,IAAI,CAACf,GAAG,GAAG;EACpD;EAEAyB,MAAMA,CAAA;IACJ,OAAO7J,eAAe,CAAC8J,OAAO,CAAC,IAAI,EAAE;MACnCC,GAAG,EAAE,qCAAqC;MAC1CZ,MAAM,EAAE,IAAI,CAACA,MAAM;MACnBf,GAAG,EAAE,IAAI,CAACc;KACX,CAAC;EACJ;;AAGF;AACO,MAAMc,WAAW,GAAGA,CACzBrH,QAA8B,EAC9BC,OAA0B,KACvBnC,KAAK,CAAC8E,MAAM,CAACrF,MAAM,CAACA,MAAM,EAAEwC,IAAI,CAACC,QAAQ,EAAEC,OAAO,CAAC,CAAC;AAEzD;AAAAyC,OAAA,CAAA2E,WAAA,GAAAA,WAAA;AACO,MAAMC,KAAK,GAAGA,CACnBtH,QAA8B,EAC9BC,OAA0B,KAE1BnC,KAAK,CAACyJ,QAAQ,CACZzJ,KAAK,CAAC8E,MAAM,CAACrF,MAAM,CAACA,MAAM,EAAEwC,IAAI,CAACC,QAAQ,EAAEC,OAAO,CAAC,CAAC,EACpDvB,gBAAgB,CAAC4I,KAAK,EACtBxK,IAAI,CAAC0K,SAAS,EACdjJ,WAAW,CAAC+I,KAAK,CAClB;AAEH;AAAA5E,OAAA,CAAA4E,KAAA,GAAAA,KAAA;AACO,MAAMG,WAAW,GAAGA,CACzBzH,QAA8B,EAC9BC,OAA8C,KAE9CnC,KAAK,CAACyJ,QAAQ,CACZzJ,KAAK,CAAC8E,MAAM,CACVrF,MAAM,CAACA,MAAM,EACbM,MAAM,CAACyG,OAAO,CAAC1G,MAAM,CAAC8J,MAAM,CAACzH,OAAO,CAAC,EAAGA,OAAO,IAAKF,IAAI,CAACC,QAAQ,EAAEC,OAAO,CAAC,CAAC,CAC7E,EACDvB,gBAAgB,CAAC4I,KAAK,EACtBxK,IAAI,CAAC0K,SAAS,EACdjJ,WAAW,CAAC+I,KAAK,CAClB;AAAA5E,OAAA,CAAA+E,WAAA,GAAAA,WAAA;AAEH,MAAMtC,cAAc,GAAGA,CAACN,OAAoC,EAAEG,QAAuC,KACnGnH,MAAM,CAAC8J,OAAO,CAAC,MAA+C;EAC5D,MAAMxE,YAAY,GAAI0B,OAA6B,CAACQ,gBAAgB;EACpE,IAAIlC,YAAY,CAACI,aAAa,EAAE;IAC9B,OAAO1F,MAAM,CAACgD,IAAI;EACpB;EAEA,IAAIsF,OAAO,GAA2CnB,QAAQ,CAACmB,OAAO;EACtE,IAAI,CAAC/I,OAAO,CAACwK,OAAO,CAAC5C,QAAQ,CAACiB,OAAO,CAAC,EAAE;IACtCE,OAAO,GAAG;MAAE,GAAGA;IAAO,CAAE;IACxB,MAAM0B,KAAK,GAAGzK,OAAO,CAAC0K,kBAAkB,CAAC9C,QAAQ,CAACiB,OAAO,CAAC;IAC1D,IAAIE,OAAO,CAAC,YAAY,CAAC,KAAKlC,SAAS,EAAE;MACvC4D,KAAK,CAACE,IAAI,CAAC5B,OAAO,CAAC,YAAY,CAAW,CAAC;IAC7C;IACAA,OAAO,CAAC,YAAY,CAAC,GAAG0B,KAAK;EAC/B;EAEA,IAAIhD,OAAO,CAAC2B,MAAM,KAAK,MAAM,EAAE;IAC7BrD,YAAY,CAACM,SAAS,CAACuB,QAAQ,CAACgD,MAAM,EAAE7B,OAAO,CAAC;IAChDhD,YAAY,CAACO,GAAG,EAAE;IAClB,OAAO7F,MAAM,CAACgD,IAAI;EACpB;EACA,MAAMoH,IAAI,GAAGjD,QAAQ,CAACiD,IAAI;EAC1B,QAAQA,IAAI,CAACzG,IAAI;IACf,KAAK,OAAO;MAAE;QACZ2B,YAAY,CAACM,SAAS,CAACuB,QAAQ,CAACgD,MAAM,EAAE7B,OAAO,CAAC;QAChDhD,YAAY,CAACO,GAAG,EAAE;QAClB,OAAO7F,MAAM,CAACgD,IAAI;MACpB;IACA,KAAK,KAAK;MAAE;QACVsC,YAAY,CAACM,SAAS,CAACuB,QAAQ,CAACgD,MAAM,EAAE7B,OAAO,CAAC;QAChD,IACE,OAAO8B,IAAI,CAACA,IAAI,KAAK,QAAQ,IAAIA,IAAI,CAACA,IAAI,KAAK,IAAI,IAAI,MAAM,IAAIA,IAAI,CAACA,IAAI,IAC1E,OAAOA,IAAI,CAACA,IAAI,CAAC5F,IAAI,KAAK,UAAU,EACpC;UACA,OAAOxE,MAAM,CAACqK,UAAU,CAAC;YACvBC,GAAG,EAAGC,MAAM,IAAK,IAAA/J,SAAA,CAAAgK,QAAQ,EAACJ,IAAI,CAACA,IAAW,EAAE9E,YAAY,EAAE;cAAEiF,MAAM;cAAE1E,GAAG,EAAE;YAAI,CAAE,CAAC;YAChF4E,KAAK,EAAG3H,KAAK,IACX,IAAInD,KAAK,CAAC+K,aAAa,CAAC;cACtB1D,OAAO;cACPG,QAAQ;cACRe,MAAM,EAAE,QAAQ;cAChBpF;aACD;WACJ,CAAC;QACJ;QACAwC,YAAY,CAACO,GAAG,CAACuE,IAAI,CAACA,IAAI,CAAC;QAC3B,OAAOpK,MAAM,CAACgD,IAAI;MACpB;IACA,KAAK,YAAY;MAAE;QACjBsC,YAAY,CAACM,SAAS,CAACuB,QAAQ,CAACgD,MAAM,EAAE7B,OAAO,CAAC;QAChDhD,YAAY,CAACO,GAAG,CAACuE,IAAI,CAACA,IAAI,CAAC;QAC3B,OAAOpK,MAAM,CAACgD,IAAI;MACpB;IACA,KAAK,UAAU;MAAE;QACf,OAAOhD,MAAM,CAAC2C,KAAK,CAA6BC,MAAM,IAAI;UACxD,MAAM3B,CAAC,GAAG,IAAI0J,QAAQ,CAACP,IAAI,CAACQ,QAAQ,CAAC;UACrCtF,YAAY,CAACM,SAAS,CAACuB,QAAQ,CAACgD,MAAM,EAAE;YACtC,GAAG7B,OAAO;YACV,GAAG5G,MAAM,CAACmJ,WAAW,CAAC5J,CAAC,CAACqH,OAAO;WAChC,CAAC;UACF/H,WAAA,CAAAuK,QAAQ,CAACC,OAAO,CAAC9J,CAAC,CAACmJ,IAAW,CAAC,CAC5B5F,IAAI,CAACc,YAAY,CAAC,CAClBrC,EAAE,CAAC,OAAO,EAAGH,KAAK,IAAI;YACrBF,MAAM,CAAC5C,MAAM,CAACkD,IAAI,CAChB,IAAIvD,KAAK,CAAC+K,aAAa,CAAC;cACtB1D,OAAO;cACPG,QAAQ;cACRe,MAAM,EAAE,QAAQ;cAChBpF;aACD,CAAC,CACH,CAAC;UACJ,CAAC,CAAC,CACDkI,IAAI,CAAC,QAAQ,EAAE,MAAK;YACnBpI,MAAM,CAAC5C,MAAM,CAACgD,IAAI,CAAC;UACrB,CAAC,CAAC;QACN,CAAC,CAAC;MACJ;IACA,KAAK,QAAQ;MAAE;QACbsC,YAAY,CAACM,SAAS,CAACuB,QAAQ,CAACgD,MAAM,EAAE7B,OAAO,CAAC;QAChD,OAAOjI,MAAM,CAAC4K,GAAG,CACf5K,MAAM,CAAC6K,QAAQ,CACbd,IAAI,CAAClB,MAAM,EACVpG,KAAK,IACJ,IAAInD,KAAK,CAAC+K,aAAa,CAAC;UACtB1D,OAAO;UACPG,QAAQ;UACRe,MAAM,EAAE,QAAQ;UAChBpF;SACD,CAAC,CACL,EACDnC,QAAQ,CAACwK,YAAY,CAAC,MAAM7F,YAAY,EAAGxC,KAAK,IAC9C,IAAInD,KAAK,CAAC+K,aAAa,CAAC;UACtB1D,OAAO;UACPG,QAAQ;UACRe,MAAM,EAAE,QAAQ;UAChBpF;SACD,CAAC,CAAC,CACN;MACH;EACF;AACF,CAAC,CAAC;AAEJ;AACO,MAAMsI,aAAa,GAAIC,IAAiC,IAC5DA,IAA0B,CAAC1D,MAAM;AAAA9C,OAAA,CAAAuG,aAAA,GAAAA,aAAA","ignoreList":[]}
\ No newline at end of file
+{"version":3,"file":"server.js","names":["Etag","_interopRequireWildcard","require","MultipartNode","FileSystem","App","Cookies","IncomingMessage","Middleware","Server","Error","ServerRequest","Socket","Cause","Config","Effect","FiberSet","Layer","Option","Runtime","Scope","Stream","Http","_nodeStream","_promises","WS","NodeContext","NodeSink","_incomingMessage","internalPlatform","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","make","evaluate","options","gen","_","scope","server","acquireRelease","sync","async","resume","close","error","die","unit","on","fail","ServeError","listen","address","wss","WebSocketServer","noServer","extend","cached","_tag","path","hostname","port","serve","httpApp","middleware","handler","makeHandler","upgradeHandler","makeUpgradeHandler","addFinalizer","off","pipe","locally","maxBodySize","some","Size","exports","handledApp","scoped","withDefaultMiddleware","respond","map","makeRuntime","runFork","nodeRequest","nodeResponse","fiber","provideService","ServerRequestImpl","writableEnded","headersSent","writeHead","end","interruptAsFork","clientAbortFiberId","lazyWss","runtime","socket","head","nodeResponse_","undefined","ServerResponse","assignSocket","upgradeEffect","fromWebSocket","flatMap","handleUpgrade","ws","succeed","res","uninterruptibleMask","restore","request","tapErrorCause","tap","response","preResponseHandler","f","handleResponse","cause","resolvedResponse","isInterruptedOnly","IncomingMessageImpl","source","url","headersOverride","TypeId","constructor","remoteAddressOverride","RequestError","reason","cachedCookies","cookies","parseHeader","headers","cookie","modify","remoteAddress","originalUrl","method","toUpperCase","multipartEffect","multipart","runSync","persisted","multipartStream","stream","upgrade","toString","toJSON","inspect","_id","layerServer","layer","mergeAll","layerWeak","layerConfig","unwrap","suspend","isEmpty","toSet","toSetCookieHeaders","push","status","body","tryPromise","try","signal","pipeline","catch","ResponseError","Response","formData","fromEntries","Readable","fromWeb","once","run","mapError","fromWritable","requestSource","self"],"sources":["../../../../src/internal/http/server.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/internal/http/server.js b/dist/esm/internal/http/server.js
index b399734e8f3cc781083bb148772b21c600e334fa..0b51c7e1518ad624239216bee874df6bb225be24 100644
--- a/dist/esm/internal/http/server.js
+++ b/dist/esm/internal/http/server.js
@@ -12,6 +12,7 @@ import * as Socket from "@effect/platform/Socket";
 import * as Cause from "effect/Cause";
 import * as Config from "effect/Config";
 import * as Effect from "effect/Effect";
+import * as FiberSet from "effect/FiberSet";
 import * as Layer from "effect/Layer";
 import * as Option from "effect/Option";
 import * as Runtime from "effect/Runtime";
@@ -77,8 +78,7 @@ export const make = (evaluate, options) => Effect.gen(function* (_) {
 /** @internal */
 export const makeHandler = (httpApp, middleware) => {
   const handledApp = Effect.scoped(middleware ? middleware(App.withDefaultMiddleware(respond(httpApp))) : App.withDefaultMiddleware(respond(httpApp)));
-  return Effect.map(Effect.runtime(), runtime => {
-    const runFork = Runtime.runFork(runtime);
+  return Effect.map(FiberSet.makeRuntime(), runFork => {
     return function handler(nodeRequest, nodeResponse) {
       const fiber = runFork(Effect.provideService(handledApp, ServerRequest.ServerRequest, new ServerRequestImpl(nodeRequest, nodeResponse)));
       nodeResponse.on("close", () => {
diff --git a/dist/esm/internal/http/server.js.map b/dist/esm/internal/http/server.js.map
index 1f3cd5437ecbf9f98bb275d4b1c0a6c04422d446..f49b56fc8c2c9c1167247d4b51c67c517f556a6f 100644
--- a/dist/esm/internal/http/server.js.map
+++ b/dist/esm/internal/http/server.js.map
@@ -1 +1 @@
-{"version":3,"file":"server.js","names":["Etag","MultipartNode","FileSystem","App","Cookies","IncomingMessage","Middleware","Server","Error","ServerRequest","Socket","Cause","Config","Effect","Layer","Option","Runtime","Scope","Stream","Http","Readable","pipeline","WS","NodeContext","NodeSink","IncomingMessageImpl","internalPlatform","make","evaluate","options","gen","_","scope","server","acquireRelease","sync","async","resume","close","error","die","unit","on","fail","ServeError","listen","address","wss","WebSocketServer","noServer","extend","cached","_tag","path","hostname","port","serve","httpApp","middleware","handler","makeHandler","upgradeHandler","makeUpgradeHandler","addFinalizer","off","pipe","locally","maxBodySize","some","Size","handledApp","scoped","withDefaultMiddleware","respond","map","runtime","runFork","nodeRequest","nodeResponse","fiber","provideService","ServerRequestImpl","writableEnded","headersSent","writeHead","end","interruptAsFork","clientAbortFiberId","lazyWss","socket","head","nodeResponse_","undefined","ServerResponse","assignSocket","upgradeEffect","fromWebSocket","flatMap","handleUpgrade","ws","succeed","res","uninterruptibleMask","restore","request","tapErrorCause","tap","response","preResponseHandler","f","handleResponse","cause","resolvedResponse","isInterruptedOnly","source","url","headersOverride","TypeId","constructor","remoteAddressOverride","RequestError","reason","cachedCookies","cookies","parseHeader","headers","cookie","modify","remoteAddress","originalUrl","method","toUpperCase","multipartEffect","multipart","runSync","persisted","multipartStream","stream","upgrade","toString","toJSON","inspect","_id","layerServer","layer","mergeAll","layerWeak","layerConfig","unwrap","suspend","isEmpty","toSet","toSetCookieHeaders","push","status","body","tryPromise","try","signal","catch","ResponseError","r","Response","formData","Object","fromEntries","fromWeb","once","run","mapError","fromWritable","requestSource","self"],"sources":["../../../../src/internal/http/server.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
+{"version":3,"file":"server.js","names":["Etag","MultipartNode","FileSystem","App","Cookies","IncomingMessage","Middleware","Server","Error","ServerRequest","Socket","Cause","Config","Effect","FiberSet","Layer","Option","Runtime","Scope","Stream","Http","Readable","pipeline","WS","NodeContext","NodeSink","IncomingMessageImpl","internalPlatform","make","evaluate","options","gen","_","scope","server","acquireRelease","sync","async","resume","close","error","die","unit","on","fail","ServeError","listen","address","wss","WebSocketServer","noServer","extend","cached","_tag","path","hostname","port","serve","httpApp","middleware","handler","makeHandler","upgradeHandler","makeUpgradeHandler","addFinalizer","off","pipe","locally","maxBodySize","some","Size","handledApp","scoped","withDefaultMiddleware","respond","map","makeRuntime","runFork","nodeRequest","nodeResponse","fiber","provideService","ServerRequestImpl","writableEnded","headersSent","writeHead","end","interruptAsFork","clientAbortFiberId","lazyWss","runtime","socket","head","nodeResponse_","undefined","ServerResponse","assignSocket","upgradeEffect","fromWebSocket","flatMap","handleUpgrade","ws","succeed","res","uninterruptibleMask","restore","request","tapErrorCause","tap","response","preResponseHandler","f","handleResponse","cause","resolvedResponse","isInterruptedOnly","source","url","headersOverride","TypeId","constructor","remoteAddressOverride","RequestError","reason","cachedCookies","cookies","parseHeader","headers","cookie","modify","remoteAddress","originalUrl","method","toUpperCase","multipartEffect","multipart","runSync","persisted","multipartStream","stream","upgrade","toString","toJSON","inspect","_id","layerServer","layer","mergeAll","layerWeak","layerConfig","unwrap","suspend","isEmpty","toSet","toSetCookieHeaders","push","status","body","tryPromise","try","signal","catch","ResponseError","r","Response","formData","Object","fromEntries","fromWeb","once","run","mapError","fromWritable","requestSource","self"],"sources":["../../../../src/internal/http/server.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/package.json b/package.json
index e86fd7105e85649191b89a3b79e7f5d5eee84f7c..0e5e201ec86c03fa8988459b2fa5546402772057 100644
--- a/package.json
+++ b/package.json
@@ -10,10 +10,10 @@
   },
   "sideEffects": [],
   "dependencies": {
+    "@effect/platform-node-shared": "^0.3.27",
     "mime": "^3.0.0",
     "undici": "^6.10.1",
-    "ws": "^8.16.0",
-    "@effect/platform-node-shared": "^0.3.27"
+    "ws": "^8.16.0"
   },
   "peerDependencies": {
     "@effect/platform": "^0.48.27",
diff --git a/src/internal/http/server.ts b/src/internal/http/server.ts
index 9384aa82230679d96d383b10e5d73a0e1f7c2437..9a6c9d8e842c55aa398d3a619ea7420f16bb7f53 100644
--- a/src/internal/http/server.ts
+++ b/src/internal/http/server.ts
@@ -17,6 +17,7 @@ import * as Socket from "@effect/platform/Socket"
 import * as Cause from "effect/Cause"
 import * as Config from "effect/Config"
 import * as Effect from "effect/Effect"
+import * as FiberSet from "effect/FiberSet"
 import { type LazyArg } from "effect/Function"
 import * as Layer from "effect/Layer"
 import * as Option from "effect/Option"
@@ -133,8 +134,7 @@ export const makeHandler: {
       ? middleware(App.withDefaultMiddleware(respond(httpApp)))
       : App.withDefaultMiddleware(respond(httpApp))
   )
-  return Effect.map(Effect.runtime<R>(), (runtime) => {
-    const runFork = Runtime.runFork(runtime)
+  return Effect.map(FiberSet.makeRuntime<R>(), (runFork) => {
     return function handler(
       nodeRequest: Http.IncomingMessage,
       nodeResponse: Http.ServerResponse
