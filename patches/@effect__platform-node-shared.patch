diff --git a/NodeClusterRunnerSocket/package.json b/NodeClusterRunnerSocket/package.json
new file mode 100644
index 0000000000000000000000000000000000000000..d407c963a0810951ff1d3c1a0df2a62226086608
--- /dev/null
+++ b/NodeClusterRunnerSocket/package.json
@@ -0,0 +1,6 @@
+{
+  "main": "../dist/cjs/NodeClusterRunnerSocket.js",
+  "module": "../dist/esm/NodeClusterRunnerSocket.js",
+  "types": "../dist/dts/NodeClusterRunnerSocket.d.ts",
+  "sideEffects": []
+}
diff --git a/NodeClusterShardManagerSocket/package.json b/NodeClusterShardManagerSocket/package.json
new file mode 100644
index 0000000000000000000000000000000000000000..198516bb54b80e96dc2a88dbe8344a7f71bcd212
--- /dev/null
+++ b/NodeClusterShardManagerSocket/package.json
@@ -0,0 +1,6 @@
+{
+  "main": "../dist/cjs/NodeClusterShardManagerSocket.js",
+  "module": "../dist/esm/NodeClusterShardManagerSocket.js",
+  "types": "../dist/dts/NodeClusterShardManagerSocket.d.ts",
+  "sideEffects": []
+}
diff --git a/NodeClusterSocketCommon/package.json b/NodeClusterSocketCommon/package.json
new file mode 100644
index 0000000000000000000000000000000000000000..b11752bdd4cbe1aa275f824b34446288ba0e6cc7
--- /dev/null
+++ b/NodeClusterSocketCommon/package.json
@@ -0,0 +1,6 @@
+{
+  "main": "../dist/cjs/NodeClusterSocketCommon.js",
+  "module": "../dist/esm/NodeClusterSocketCommon.js",
+  "types": "../dist/dts/NodeClusterSocketCommon.d.ts",
+  "sideEffects": []
+}
diff --git a/NodeSocketServer/package.json b/NodeSocketServer/package.json
new file mode 100644
index 0000000000000000000000000000000000000000..f595f81078be0ab1ab14d3ccd16d52b2f4fc6f33
--- /dev/null
+++ b/NodeSocketServer/package.json
@@ -0,0 +1,6 @@
+{
+  "main": "../dist/cjs/NodeSocketServer.js",
+  "module": "../dist/esm/NodeSocketServer.js",
+  "types": "../dist/dts/NodeSocketServer.d.ts",
+  "sideEffects": []
+}
diff --git a/dist/cjs/NodeClusterRunnerSocket.js b/dist/cjs/NodeClusterRunnerSocket.js
new file mode 100644
index 0000000000000000000000000000000000000000..97744ae7d6ded9a0df4b2ff72cc09ac10a6f12c6
--- /dev/null
+++ b/dist/cjs/NodeClusterRunnerSocket.js
@@ -0,0 +1,49 @@
+"use strict";
+
+Object.defineProperty(exports, "__esModule", {
+  value: true
+});
+exports.layerSocketServer = exports.layer = void 0;
+var MessageStorage = _interopRequireWildcard(require("@effect/cluster/MessageStorage"));
+var ShardingConfig = _interopRequireWildcard(require("@effect/cluster/ShardingConfig"));
+var ShardStorage = _interopRequireWildcard(require("@effect/cluster/ShardStorage"));
+var SocketRunner = _interopRequireWildcard(require("@effect/cluster/SocketRunner"));
+var SqlMessageStorage = _interopRequireWildcard(require("@effect/cluster/SqlMessageStorage"));
+var SqlShardStorage = _interopRequireWildcard(require("@effect/cluster/SqlShardStorage"));
+var RpcSerialization = _interopRequireWildcard(require("@effect/rpc/RpcSerialization"));
+var Effect = _interopRequireWildcard(require("effect/Effect"));
+var Layer = _interopRequireWildcard(require("effect/Layer"));
+var Option = _interopRequireWildcard(require("effect/Option"));
+var _NodeClusterSocketCommon = require("./NodeClusterSocketCommon.js");
+var NodeSocketServer = _interopRequireWildcard(require("./NodeSocketServer.js"));
+function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
+function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
+/**
+ * @since 1.0.0
+ */
+
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+const layerSocketServer = exports.layerSocketServer = /*#__PURE__*/Effect.gen(function* () {
+  const config = yield* ShardingConfig.ShardingConfig;
+  if (Option.isNone(config.runnerAddress)) {
+    return yield* Effect.dieMessage("layerSocketServer: ShardingConfig.runnerAddress is None");
+  }
+  return NodeSocketServer.layer(config.runnerAddress.value);
+}).pipe(Layer.unwrapEffect);
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+const layer = options => {
+  const layer = options?.clientOnly
+  // client only
+  ? Layer.provide(SocketRunner.layerClientOnly, _NodeClusterSocketCommon.layerClientProtocol)
+  // with server
+  : Layer.provide(SocketRunner.layer, [layerSocketServer, _NodeClusterSocketCommon.layerClientProtocol]);
+  return layer.pipe(Layer.provide(options?.storage === "sql" ? options.clientOnly ? [SqlMessageStorage.layer] : [SqlMessageStorage.layer, SqlShardStorage.layer] : [MessageStorage.layerNoop, ShardStorage.layerNoop]), Layer.provide(ShardingConfig.layerFromEnv(options?.shardingConfig)), Layer.provide(options?.serialization === "ndjson" ? RpcSerialization.layerNdjson : RpcSerialization.layerMsgPack));
+};
+exports.layer = layer;
+//# sourceMappingURL=NodeClusterRunnerSocket.js.map
\ No newline at end of file
diff --git a/dist/cjs/NodeClusterRunnerSocket.js.map b/dist/cjs/NodeClusterRunnerSocket.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..f21800b9a1830a6b5b409b0ed56d4a5a9972895a
--- /dev/null
+++ b/dist/cjs/NodeClusterRunnerSocket.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"NodeClusterRunnerSocket.js","names":["MessageStorage","_interopRequireWildcard","require","ShardingConfig","ShardStorage","SocketRunner","SqlMessageStorage","SqlShardStorage","RpcSerialization","Effect","Layer","Option","_NodeClusterSocketCommon","NodeSocketServer","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","layerSocketServer","exports","gen","config","isNone","runnerAddress","dieMessage","layer","value","pipe","unwrapEffect","options","clientOnly","provide","layerClientOnly","layerClientProtocol","storage","layerNoop","layerFromEnv","shardingConfig","serialization","layerNdjson","layerMsgPack"],"sources":["../../src/NodeClusterRunnerSocket.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/cjs/NodeClusterShardManagerSocket.js b/dist/cjs/NodeClusterShardManagerSocket.js
new file mode 100644
index 0000000000000000000000000000000000000000..0b448c1bbe90377830524634783066b82ca5fd88
--- /dev/null
+++ b/dist/cjs/NodeClusterShardManagerSocket.js
@@ -0,0 +1,38 @@
+"use strict";
+
+Object.defineProperty(exports, "__esModule", {
+  value: true
+});
+exports.layerSocketServer = exports.layer = void 0;
+var RunnerHealth = _interopRequireWildcard(require("@effect/cluster/RunnerHealth"));
+var ShardingConfig = _interopRequireWildcard(require("@effect/cluster/ShardingConfig"));
+var ShardManager = _interopRequireWildcard(require("@effect/cluster/ShardManager"));
+var ShardStorage = _interopRequireWildcard(require("@effect/cluster/ShardStorage"));
+var SocketShardManager = _interopRequireWildcard(require("@effect/cluster/SocketShardManager"));
+var SqlShardStorage = _interopRequireWildcard(require("@effect/cluster/SqlShardStorage"));
+var RpcSerialization = _interopRequireWildcard(require("@effect/rpc/RpcSerialization"));
+var Effect = _interopRequireWildcard(require("effect/Effect"));
+var Layer = _interopRequireWildcard(require("effect/Layer"));
+var _NodeClusterSocketCommon = require("./NodeClusterSocketCommon.js");
+var NodeSocketServer = _interopRequireWildcard(require("./NodeSocketServer.js"));
+function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
+function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
+/**
+ * @since 1.0.0
+ */
+
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+const layerSocketServer = exports.layerSocketServer = /*#__PURE__*/Effect.gen(function* () {
+  const config = yield* ShardingConfig.ShardingConfig;
+  return NodeSocketServer.layer(config.shardManagerAddress);
+}).pipe(Layer.unwrapEffect);
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+const layer = options => SocketShardManager.layer.pipe(Layer.provide([RunnerHealth.layerRpc, layerSocketServer, ShardManager.layerConfigFromEnv]), Layer.provide(_NodeClusterSocketCommon.layerClientProtocol), Layer.provide(options?.storage === "sql" ? SqlShardStorage.layer : ShardStorage.layerNoop), Layer.provide([options?.serialization === "ndjson" ? RpcSerialization.layerNdjson : RpcSerialization.layerMsgPack, ShardingConfig.layerFromEnv(options?.shardingConfig)]));
+exports.layer = layer;
+//# sourceMappingURL=NodeClusterShardManagerSocket.js.map
\ No newline at end of file
diff --git a/dist/cjs/NodeClusterShardManagerSocket.js.map b/dist/cjs/NodeClusterShardManagerSocket.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..9e072ffd400ec032deff8aa2a874caeac74fbc76
--- /dev/null
+++ b/dist/cjs/NodeClusterShardManagerSocket.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"NodeClusterShardManagerSocket.js","names":["RunnerHealth","_interopRequireWildcard","require","ShardingConfig","ShardManager","ShardStorage","SocketShardManager","SqlShardStorage","RpcSerialization","Effect","Layer","_NodeClusterSocketCommon","NodeSocketServer","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","layerSocketServer","exports","gen","config","layer","shardManagerAddress","pipe","unwrapEffect","options","provide","layerRpc","layerConfigFromEnv","layerClientProtocol","storage","layerNoop","serialization","layerNdjson","layerMsgPack","layerFromEnv","shardingConfig"],"sources":["../../src/NodeClusterShardManagerSocket.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/cjs/NodeClusterSocketCommon.js b/dist/cjs/NodeClusterSocketCommon.js
new file mode 100644
index 0000000000000000000000000000000000000000..e93bc5d9ef85781f4fe5563a25f2cef7e2661aaa
--- /dev/null
+++ b/dist/cjs/NodeClusterSocketCommon.js
@@ -0,0 +1,34 @@
+"use strict";
+
+Object.defineProperty(exports, "__esModule", {
+  value: true
+});
+exports.layerClientProtocol = void 0;
+var Runners = _interopRequireWildcard(require("@effect/cluster/Runners"));
+var _Socket = require("@effect/platform/Socket");
+var RpcClient = _interopRequireWildcard(require("@effect/rpc/RpcClient"));
+var RpcSerialization = _interopRequireWildcard(require("@effect/rpc/RpcSerialization"));
+var Effect = _interopRequireWildcard(require("effect/Effect"));
+var Layer = _interopRequireWildcard(require("effect/Layer"));
+var NodeSocket = _interopRequireWildcard(require("./NodeSocket.js"));
+function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
+function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
+/**
+ * @since 1.0.0
+ */
+
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+const layerClientProtocol = exports.layerClientProtocol = /*#__PURE__*/Layer.effect(Runners.RpcClientProtocol, /*#__PURE__*/Effect.gen(function* () {
+  const serialization = yield* RpcSerialization.RpcSerialization;
+  return Effect.fnUntraced(function* (address) {
+    const socket = yield* NodeSocket.makeNet({
+      host: address.host,
+      port: address.port
+    });
+    return yield* RpcClient.makeProtocolSocket.pipe(Effect.provideService(_Socket.Socket, socket), Effect.provideService(RpcSerialization.RpcSerialization, serialization));
+  }, Effect.orDie);
+}));
+//# sourceMappingURL=NodeClusterSocketCommon.js.map
\ No newline at end of file
diff --git a/dist/cjs/NodeClusterSocketCommon.js.map b/dist/cjs/NodeClusterSocketCommon.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..82a09e728488819312b31b3159ec9ec92782115d
--- /dev/null
+++ b/dist/cjs/NodeClusterSocketCommon.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"NodeClusterSocketCommon.js","names":["Runners","_interopRequireWildcard","require","_Socket","RpcClient","RpcSerialization","Effect","Layer","NodeSocket","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","layerClientProtocol","exports","effect","RpcClientProtocol","gen","serialization","fnUntraced","address","socket","makeNet","host","port","makeProtocolSocket","pipe","provideService","Socket","orDie"],"sources":["../../src/NodeClusterSocketCommon.ts"],"sourcesContent":[null],"mappings":";;;;;;AAGA,IAAAA,OAAA,GAAAC,uBAAA,CAAAC,OAAA;AACA,IAAAC,OAAA,GAAAD,OAAA;AACA,IAAAE,SAAA,GAAAH,uBAAA,CAAAC,OAAA;AACA,IAAAG,gBAAA,GAAAJ,uBAAA,CAAAC,OAAA;AACA,IAAAI,MAAA,GAAAL,uBAAA,CAAAC,OAAA;AACA,IAAAK,KAAA,GAAAN,uBAAA,CAAAC,OAAA;AACA,IAAAM,UAAA,GAAAP,uBAAA,CAAAC,OAAA;AAA6C,SAAAO,yBAAAC,CAAA,6BAAAC,OAAA,mBAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,CAAA,WAAAA,CAAA,GAAAG,CAAA,GAAAD,CAAA,KAAAF,CAAA;AAAA,SAAAT,wBAAAS,CAAA,EAAAE,CAAA,SAAAA,CAAA,IAAAF,CAAA,IAAAA,CAAA,CAAAI,UAAA,SAAAJ,CAAA,eAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,WAAAK,OAAA,EAAAL,CAAA,QAAAG,CAAA,GAAAJ,wBAAA,CAAAG,CAAA,OAAAC,CAAA,IAAAA,CAAA,CAAAG,GAAA,CAAAN,CAAA,UAAAG,CAAA,CAAAI,GAAA,CAAAP,CAAA,OAAAQ,CAAA,KAAAC,SAAA,UAAAC,CAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,CAAA,IAAAd,CAAA,oBAAAc,CAAA,OAAAC,cAAA,CAAAC,IAAA,CAAAhB,CAAA,EAAAc,CAAA,SAAAG,CAAA,GAAAP,CAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAb,CAAA,EAAAc,CAAA,UAAAG,CAAA,KAAAA,CAAA,CAAAV,GAAA,IAAAU,CAAA,CAAAC,GAAA,IAAAP,MAAA,CAAAC,cAAA,CAAAJ,CAAA,EAAAM,CAAA,EAAAG,CAAA,IAAAT,CAAA,CAAAM,CAAA,IAAAd,CAAA,CAAAc,CAAA,YAAAN,CAAA,CAAAH,OAAA,GAAAL,CAAA,EAAAG,CAAA,IAAAA,CAAA,CAAAe,GAAA,CAAAlB,CAAA,EAAAQ,CAAA,GAAAA,CAAA;AAT7C;;;;AAWA;;;;AAIO,MAAMW,mBAAmB,GAAAC,OAAA,CAAAD,mBAAA,gBAI5BtB,KAAK,CAACwB,MAAM,CACd/B,OAAO,CAACgC,iBAAiB,eACzB1B,MAAM,CAAC2B,GAAG,CAAC,aAAS;EAClB,MAAMC,aAAa,GAAG,OAAO7B,gBAAgB,CAACA,gBAAgB;EAC9D,OAAOC,MAAM,CAAC6B,UAAU,CAAC,WAAUC,OAAO;IACxC,MAAMC,MAAM,GAAG,OAAO7B,UAAU,CAAC8B,OAAO,CAAC;MACvCC,IAAI,EAAEH,OAAO,CAACG,IAAI;MAClBC,IAAI,EAAEJ,OAAO,CAACI;KACf,CAAC;IACF,OAAO,OAAOpC,SAAS,CAACqC,kBAAkB,CAACC,IAAI,CAC7CpC,MAAM,CAACqC,cAAc,CAACC,cAAM,EAAEP,MAAM,CAAC,EACrC/B,MAAM,CAACqC,cAAc,CAACtC,gBAAgB,CAACA,gBAAgB,EAAE6B,aAAa,CAAC,CACxE;EACH,CAAC,EAAE5B,MAAM,CAACuC,KAAK,CAAC;AAClB,CAAC,CAAC,CACH","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/cjs/NodeSocket.js b/dist/cjs/NodeSocket.js
index 66a9d36cf9933115823be1a68aab374bcdb50e20..fd975f14e1911791cd978c7c6938e9723622b5f7 100644
--- a/dist/cjs/NodeSocket.js
+++ b/dist/cjs/NodeSocket.js
@@ -35,6 +35,7 @@ const makeNet = options => fromDuplex(Effect.acquireRelease(Effect.async(resume
     resume(Effect.succeed(conn));
   });
   conn.on("error", cause => {
+    conn.removeAllListeners();
     resume(Effect.fail(new Socket.SocketGenericError({
       reason: "Open",
       cause
@@ -63,7 +64,7 @@ const fromDuplex = open => Effect.withFiberRuntime(fiber => {
   let currentSocket;
   const latch = Effect.unsafeMakeLatch(false);
   const openContext = fiber.currentContext;
-  const run = handler => Effect.scopedWith(scope => Effect.gen(function* () {
+  const run = handler => Effect.scopedWith(Effect.fnUntraced(function* (scope) {
     const fiberSet = yield* FiberSet.make().pipe(Scope.extend(scope));
     const conn = yield* Scope.extend(open, scope);
     const run = yield* Effect.provideService(FiberSet.runtime(fiberSet)(), NetSocket, conn);
diff --git a/dist/cjs/NodeSocket.js.map b/dist/cjs/NodeSocket.js.map
index 6aaed7b782088e21a6d0ed5ff8a1a2017f4ff4ec..1ccd39fe99371fd4b3beb659aa88e05d7ef40d2c 100644
--- a/dist/cjs/NodeSocket.js.map
+++ b/dist/cjs/NodeSocket.js.map
@@ -1 +1 @@
-{"version":3,"file":"NodeSocket.js","names":["Socket","_interopRequireWildcard","require","Channel","Context","Deferred","Effect","FiberSet","Layer","Scope","Net","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","NetSocket","exports","GenericTag","makeNet","options","fromDuplex","acquireRelease","async","resume","conn","createConnection","on","removeAllListeners","succeed","cause","fail","SocketGenericError","reason","sync","destroy","closed","destroySoon","open","withFiberRuntime","fiber","currentSocket","latch","unsafeMakeLatch","openContext","currentContext","run","handler","scopedWith","scope","gen","fiberSet","make","pipe","extend","provideService","runtime","onData","chunk","result","isEffect","onEnd","unsafeDone","deferred","void","onError","onClose","hadError","SocketCloseError","code","addFinalizer","off","join","mapInputContext","input","merge","ensuring","unsafeClose","undefined","interruptible","write","whenOpen","isCloseEvent","Error","writer","writableEnded","end","of","TypeId","runRaw","makeNetChannel","unwrapScoped","map","toChannelWith","layerNet","effect"],"sources":["../../src/NodeSocket.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
+{"version":3,"file":"NodeSocket.js","names":["Socket","_interopRequireWildcard","require","Channel","Context","Deferred","Effect","FiberSet","Layer","Scope","Net","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","NetSocket","exports","GenericTag","makeNet","options","fromDuplex","acquireRelease","async","resume","conn","createConnection","on","removeAllListeners","succeed","cause","fail","SocketGenericError","reason","sync","destroy","closed","destroySoon","open","withFiberRuntime","fiber","currentSocket","latch","unsafeMakeLatch","openContext","currentContext","run","handler","scopedWith","fnUntraced","scope","fiberSet","make","pipe","extend","provideService","runtime","onData","chunk","result","isEffect","onEnd","unsafeDone","deferred","void","onError","onClose","hadError","SocketCloseError","code","addFinalizer","off","join","mapInputContext","input","merge","ensuring","unsafeClose","undefined","interruptible","write","whenOpen","isCloseEvent","Error","writer","writableEnded","end","of","TypeId","runRaw","makeNetChannel","unwrapScoped","map","toChannelWith","layerNet","effect"],"sources":["../../src/NodeSocket.ts"],"sourcesContent":[null],"mappings":";;;;;;AAGA,IAAAA,MAAA,GAAAC,uBAAA,CAAAC,OAAA;AACA,IAAAC,OAAA,GAAAF,uBAAA,CAAAC,OAAA;AAEA,IAAAE,OAAA,GAAAH,uBAAA,CAAAC,OAAA;AACA,IAAAG,QAAA,GAAAJ,uBAAA,CAAAC,OAAA;AACA,IAAAI,MAAA,GAAAL,uBAAA,CAAAC,OAAA;AACA,IAAAK,QAAA,GAAAN,uBAAA,CAAAC,OAAA;AACA,IAAAM,KAAA,GAAAP,uBAAA,CAAAC,OAAA;AACA,IAAAO,KAAA,GAAAR,uBAAA,CAAAC,OAAA;AACA,IAAAQ,GAAA,GAAAT,uBAAA,CAAAC,OAAA;AAA+B,SAAAS,yBAAAC,CAAA,6BAAAC,OAAA,mBAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,CAAA,WAAAA,CAAA,GAAAG,CAAA,GAAAD,CAAA,KAAAF,CAAA;AAAA,SAAAX,wBAAAW,CAAA,EAAAE,CAAA,SAAAA,CAAA,IAAAF,CAAA,IAAAA,CAAA,CAAAI,UAAA,SAAAJ,CAAA,eAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,WAAAK,OAAA,EAAAL,CAAA,QAAAG,CAAA,GAAAJ,wBAAA,CAAAG,CAAA,OAAAC,CAAA,IAAAA,CAAA,CAAAG,GAAA,CAAAN,CAAA,UAAAG,CAAA,CAAAI,GAAA,CAAAP,CAAA,OAAAQ,CAAA,KAAAC,SAAA,UAAAC,CAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,CAAA,IAAAd,CAAA,oBAAAc,CAAA,OAAAC,cAAA,CAAAC,IAAA,CAAAhB,CAAA,EAAAc,CAAA,SAAAG,CAAA,GAAAP,CAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAb,CAAA,EAAAc,CAAA,UAAAG,CAAA,KAAAA,CAAA,CAAAV,GAAA,IAAAU,CAAA,CAAAC,GAAA,IAAAP,MAAA,CAAAC,cAAA,CAAAJ,CAAA,EAAAM,CAAA,EAAAG,CAAA,IAAAT,CAAA,CAAAM,CAAA,IAAAd,CAAA,CAAAc,CAAA,YAAAN,CAAA,CAAAH,OAAA,GAAAL,CAAA,EAAAG,CAAA,IAAAA,CAAA,CAAAe,GAAA,CAAAlB,CAAA,EAAAQ,CAAA,GAAAA,CAAA;AAZ/B;;;;AAuBA;;;;AAIO,MAAMW,SAAS,GAAAC,OAAA,CAAAD,SAAA,gBAAuC3B,OAAO,CAAC6B,UAAU,CAC7E,4CAA4C,CAC7C;AAED;;;;AAIO,MAAMC,OAAO,GAClBC,OAA2B,IAE3BC,UAAU,CACR9B,MAAM,CAAC+B,cAAc,CACnB/B,MAAM,CAACgC,KAAK,CAAyCC,MAAM,IAAI;EAC7D,MAAMC,IAAI,GAAG9B,GAAG,CAAC+B,gBAAgB,CAACN,OAAO,CAAC;EAC1CK,IAAI,CAACE,EAAE,CAAC,SAAS,EAAE,MAAK;IACtBF,IAAI,CAACG,kBAAkB,EAAE;IACzBJ,MAAM,CAACjC,MAAM,CAACsC,OAAO,CAACJ,IAAI,CAAC,CAAC;EAC9B,CAAC,CAAC;EACFA,IAAI,CAACE,EAAE,CAAC,OAAO,EAAGG,KAAK,IAAI;IACzBL,IAAI,CAACG,kBAAkB,EAAE;IACzBJ,MAAM,CAACjC,MAAM,CAACwC,IAAI,CAAC,IAAI9C,MAAM,CAAC+C,kBAAkB,CAAC;MAAEC,MAAM,EAAE,MAAM;MAAEH;IAAK,CAAE,CAAC,CAAC,CAAC;EAC/E,CAAC,CAAC;EACF,OAAOvC,MAAM,CAAC2C,IAAI,CAAC,MAAK;IACtBT,IAAI,CAACU,OAAO,EAAE;EAChB,CAAC,CAAC;AACJ,CAAC,CAAC,EACDV,IAAI,IACHlC,MAAM,CAAC2C,IAAI,CAAC,MAAK;EACf,IAAIT,IAAI,CAACW,MAAM,KAAK,KAAK,EAAE;IACzB,IAAI,aAAa,IAAIX,IAAI,EAAE;MACzBA,IAAI,CAACY,WAAW,EAAE;IACpB,CAAC,MAAM;MACL;MAAEZ,IAAmB,CAACU,OAAO,EAAE;IACjC;EACF;EACAV,IAAI,CAACG,kBAAkB,EAAE;AAC3B,CAAC,CAAC,CACL,CACF;AAEH;;;;AAAAX,OAAA,CAAAE,OAAA,GAAAA,OAAA;AAIO,MAAME,UAAU,GACrBiB,IAAmD,IAEnD/C,MAAM,CAACgD,gBAAgB,CAAkDC,KAAK,IAAI;EAChF,IAAIC,aAAiC;EACrC,MAAMC,KAAK,GAAGnD,MAAM,CAACoD,eAAe,CAAC,KAAK,CAAC;EAC3C,MAAMC,WAAW,GAAGJ,KAAK,CAACK,cAAqC;EAC/D,MAAMC,GAAG,GAAaC,OAAyD,IAC7ExD,MAAM,CAACyD,UAAU,CAACzD,MAAM,CAAC0D,UAAU,CAAC,WAAUC,KAAK;IACjD,MAAMC,QAAQ,GAAG,OAAO3D,QAAQ,CAAC4D,IAAI,EAA+B,CAACC,IAAI,CACvE3D,KAAK,CAAC4D,MAAM,CAACJ,KAAK,CAAC,CACpB;IACD,MAAMzB,IAAI,GAAG,OAAO/B,KAAK,CAAC4D,MAAM,CAAChB,IAAI,EAAEY,KAAK,CAAC;IAC7C,MAAMJ,GAAG,GAAG,OAAOvD,MAAM,CAACgE,cAAc,CAAC/D,QAAQ,CAACgE,OAAO,CAACL,QAAQ,CAAC,EAAK,EAAEnC,SAAS,EAAES,IAAkB,CAAC;IAExG,SAASgC,MAAMA,CAACC,KAAiB;MAC/B,MAAMC,MAAM,GAAGZ,OAAO,CAACW,KAAK,CAAC;MAC7B,IAAInE,MAAM,CAACqE,QAAQ,CAACD,MAAM,CAAC,EAAE;QAC3Bb,GAAG,CAACa,MAAM,CAAC;MACb;IACF;IACA,SAASE,KAAKA,CAAA;MACZvE,QAAQ,CAACwE,UAAU,CAACX,QAAQ,CAACY,QAAQ,EAAExE,MAAM,CAACyE,IAAI,CAAC;IACrD;IACA,SAASC,OAAOA,CAACnC,KAAY;MAC3BxC,QAAQ,CAACwE,UAAU,CACjBX,QAAQ,CAACY,QAAQ,EACjBxE,MAAM,CAACwC,IAAI,CAAC,IAAI9C,MAAM,CAAC+C,kBAAkB,CAAC;QAAEC,MAAM,EAAE,MAAM;QAAEH;MAAK,CAAE,CAAC,CAAC,CACtE;IACH;IACA,SAASoC,OAAOA,CAACC,QAAiB;MAChC7E,QAAQ,CAACwE,UAAU,CACjBX,QAAQ,CAACY,QAAQ,EACjBxE,MAAM,CAACwC,IAAI,CACT,IAAI9C,MAAM,CAACmF,gBAAgB,CAAC;QAC1BnC,MAAM,EAAE,OAAO;QACfoC,IAAI,EAAEF,QAAQ,GAAG,IAAI,GAAG;OACzB,CAAC,CACH,CACF;IACH;IACA,OAAOzE,KAAK,CAAC4E,YAAY,CACvBpB,KAAK,EACL3D,MAAM,CAAC2C,IAAI,CAAC,MAAK;MACfT,IAAI,CAAC8C,GAAG,CAAC,MAAM,EAAEd,MAAM,CAAC;MACxBhC,IAAI,CAAC8C,GAAG,CAAC,KAAK,EAAEV,KAAK,CAAC;MACtBpC,IAAI,CAAC8C,GAAG,CAAC,OAAO,EAAEN,OAAO,CAAC;MAC1BxC,IAAI,CAAC8C,GAAG,CAAC,OAAO,EAAEL,OAAO,CAAC;IAC5B,CAAC,CAAC,CACH;IACDzC,IAAI,CAACE,EAAE,CAAC,MAAM,EAAE8B,MAAM,CAAC;IACvBhC,IAAI,CAACE,EAAE,CAAC,KAAK,EAAEkC,KAAK,CAAC;IACrBpC,IAAI,CAACE,EAAE,CAAC,OAAO,EAAEsC,OAAO,CAAC;IACzBxC,IAAI,CAACE,EAAE,CAAC,OAAO,EAAEuC,OAAO,CAAC;IAEzBzB,aAAa,GAAGhB,IAAI;IACpB,OAAOiB,KAAK,CAACJ,IAAI;IAEjB,OAAO,OAAO9C,QAAQ,CAACgF,IAAI,CAACrB,QAAQ,CAAC;EACvC,CAAC,CAAC,CAAC,CAACE,IAAI,CACN9D,MAAM,CAACkF,eAAe,CAAEC,KAAyB,IAAKrF,OAAO,CAACsF,KAAK,CAAC/B,WAAW,EAAE8B,KAAK,CAAC,CAAC,EACxFnF,MAAM,CAACqF,QAAQ,CAACrF,MAAM,CAAC2C,IAAI,CAAC,MAAK;IAC/BQ,KAAK,CAACmC,WAAW,EAAE;IACnBpC,aAAa,GAAGqC,SAAS;EAC3B,CAAC,CAAC,CAAC,EACHvF,MAAM,CAACwF,aAAa,CACrB;EAEH,MAAMC,KAAK,GAAItB,KAA8C,IAC3DhB,KAAK,CAACuC,QAAQ,CAAC1F,MAAM,CAACgC,KAAK,CAA4BC,MAAM,IAAI;IAC/D,MAAMC,IAAI,GAAGgB,aAAc;IAC3B,IAAIxD,MAAM,CAACiG,YAAY,CAACxB,KAAK,CAAC,EAAE;MAC9BjC,IAAI,CAACU,OAAO,CAACuB,KAAK,CAACW,IAAI,GAAG,IAAI,GAAG,IAAIc,KAAK,CAAC,oBAAoBzB,KAAK,CAACW,IAAI,EAAE,CAAC,GAAGS,SAAS,CAAC;MACzF,OAAOtD,MAAM,CAACjC,MAAM,CAACyE,IAAI,CAAC;IAC5B;IACAvB,aAAc,CAACuC,KAAK,CAACtB,KAAK,EAAG5B,KAAK,IAAI;MACpCN,MAAM,CACJM,KAAK,GACDvC,MAAM,CAACwC,IAAI,CAAC,IAAI9C,MAAM,CAAC+C,kBAAkB,CAAC;QAAEC,MAAM,EAAE,OAAO;QAAEH;MAAK,CAAE,CAAC,CAAC,GACtEvC,MAAM,CAACyE,IAAI,CAChB;IACH,CAAC,CAAC;EACJ,CAAC,CAAC,CAAC;EAEL,MAAMoB,MAAM,GAAG7F,MAAM,CAAC+B,cAAc,CAClC/B,MAAM,CAACsC,OAAO,CAACmD,KAAK,CAAC,EACrB,MACEzF,MAAM,CAAC2C,IAAI,CAAC,MAAK;IACf,IAAI,CAACO,aAAa,IAAIA,aAAa,CAAC4C,aAAa,EAAE;IACnD5C,aAAa,CAAC6C,GAAG,EAAE;EACrB,CAAC,CAAC,CACL;EAED,OAAO/F,MAAM,CAACsC,OAAO,CAAC5C,MAAM,CAACA,MAAM,CAACsG,EAAE,CAAC;IACrC,CAACtG,MAAM,CAACuG,MAAM,GAAGvG,MAAM,CAACuG,MAAM;IAC9B1C,GAAG;IACH2C,MAAM,EAAE3C,GAAG;IACXsC;GACD,CAAC,CAAC;AACL,CAAC,CAAC;AAEJ;;;;AAAAnE,OAAA,CAAAI,UAAA,GAAAA,UAAA;AAIO,MAAMqE,cAAc,GACzBtE,OAA2B,IAS3BhC,OAAO,CAACuG,YAAY,CAClBpG,MAAM,CAACqG,GAAG,CAACzE,OAAO,CAACC,OAAO,CAAC,EAAEnC,MAAM,CAAC4G,aAAa,EAAM,CAAC,CACzD;AAEH;;;;AAAA5E,OAAA,CAAAyE,cAAA,GAAAA,cAAA;AAIO,MAAMI,QAAQ,GAAI1E,OAA2B,IAClD3B,KAAK,CAACsG,MAAM,CAAC9G,MAAM,CAACA,MAAM,EAAEkC,OAAO,CAACC,OAAO,CAAC,CAAC;AAAAH,OAAA,CAAA6E,QAAA,GAAAA,QAAA","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/cjs/NodeSocketServer.js b/dist/cjs/NodeSocketServer.js
new file mode 100644
index 0000000000000000000000000000000000000000..7311eb71b30d0cdca54cc2592641fae6a64e4279
--- /dev/null
+++ b/dist/cjs/NodeSocketServer.js
@@ -0,0 +1,149 @@
+"use strict";
+
+Object.defineProperty(exports, "__esModule", {
+  value: true
+});
+exports.makeWebSocket = exports.make = exports.layerWebSocket = exports.layer = exports.IncomingMessage = void 0;
+var Socket = _interopRequireWildcard(require("@effect/platform/Socket"));
+var SocketServer = _interopRequireWildcard(require("@effect/platform/SocketServer"));
+var Context = _interopRequireWildcard(require("effect/Context"));
+var Effect = _interopRequireWildcard(require("effect/Effect"));
+var Exit = _interopRequireWildcard(require("effect/Exit"));
+var FiberRef = _interopRequireWildcard(require("effect/FiberRef"));
+var FiberSet = _interopRequireWildcard(require("effect/FiberSet"));
+var _Function = require("effect/Function");
+var Layer = _interopRequireWildcard(require("effect/Layer"));
+var Scope = _interopRequireWildcard(require("effect/Scope"));
+var Net = _interopRequireWildcard(require("node:net"));
+var WS = _interopRequireWildcard(require("ws"));
+var NodeSocket = _interopRequireWildcard(require("./NodeSocket.js"));
+function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
+function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
+/**
+ * @since 1.0.0
+ */
+
+/**
+ * @since 1.0.0
+ * @category tags
+ */
+class IncomingMessage extends /*#__PURE__*/Context.Tag("@effect/platform-node-shared/NodeSocketServer/IncomingMessage")() {}
+/**
+ * @since 1.0.0
+ * @category constructors
+ */
+exports.IncomingMessage = IncomingMessage;
+const make = exports.make = /*#__PURE__*/Effect.fnUntraced(function* (options) {
+  const server = yield* Effect.acquireRelease(Effect.sync(() => Net.createServer(options)), server => Effect.async(resume => {
+    server.close(() => resume(Effect.void));
+  }));
+  yield* Effect.async(resume => {
+    server.once("error", cause => {
+      resume(Effect.fail(new SocketServer.SocketServerError({
+        reason: "Open",
+        cause
+      })));
+    });
+    server.listen(options, () => {
+      resume(Effect.void);
+    });
+  });
+  const run = Effect.fnUntraced(function* (handler) {
+    const scope = yield* Scope.make();
+    const fiberSet = yield* FiberSet.make().pipe(Scope.extend(scope));
+    const run = yield* FiberSet.runtime(fiberSet)();
+    function onConnection(conn) {
+      (0, _Function.pipe)(NodeSocket.fromDuplex(Effect.acquireRelease(Effect.succeed(conn), conn => Effect.sync(() => {
+        if (conn.closed === false) {
+          conn.destroySoon();
+        }
+      }))), Effect.flatMap(handler), Effect.catchAllCause(reportUnhandledError), Effect.provideService(NodeSocket.NetSocket, conn), run);
+    }
+    return yield* Effect.async(_resume => {
+      server.on("connection", onConnection);
+      return Effect.sync(() => {
+        server.off("connection", onConnection);
+      });
+    }).pipe(Effect.ensuring(Scope.close(scope, Exit.void)));
+  });
+  const address = server.address();
+  return SocketServer.SocketServer.of({
+    address: typeof address === "string" ? {
+      _tag: "UnixAddress",
+      path: address
+    } : {
+      _tag: "TcpAddress",
+      hostname: address.address,
+      port: address.port
+    },
+    run
+  });
+});
+/**
+ * @since 1.0.0
+ * @category layers
+ */
+const layer = options => Layer.scoped(SocketServer.SocketServer, make(options));
+/**
+ * @since 1.0.0
+ * @category constructors
+ */
+exports.layer = layer;
+const makeWebSocket = exports.makeWebSocket = /*#__PURE__*/Effect.fnUntraced(function* (options) {
+  const server = yield* Effect.acquireRelease(Effect.sync(() => new WS.WebSocketServer(options)), server => Effect.async(resume => {
+    server.close(() => resume(Effect.void));
+  }));
+  yield* Effect.async(resume => {
+    server.once("error", error => {
+      resume(Effect.fail(new SocketServer.SocketServerError({
+        reason: "Open",
+        cause: error
+      })));
+    });
+    server.once("listening", () => {
+      resume(Effect.void);
+    });
+  });
+  const run = Effect.fnUntraced(function* (handler) {
+    const scope = yield* Scope.make();
+    const fiberSet = yield* FiberSet.make().pipe(Scope.extend(scope));
+    const run = yield* FiberSet.runtime(fiberSet)();
+    function onConnection(conn, req) {
+      (0, _Function.pipe)(Socket.fromWebSocket(Effect.acquireRelease(Effect.succeed(conn), conn => Effect.sync(() => {
+        conn.close();
+      }))), Effect.flatMap(handler), Effect.catchAllCause(reportUnhandledError), Effect.provideService(Socket.WebSocket, conn), Effect.provideService(IncomingMessage, req), run);
+    }
+    return yield* Effect.async(_resume => {
+      server.on("connection", onConnection);
+      return Effect.sync(() => {
+        server.off("connection", onConnection);
+      });
+    }).pipe(Effect.ensuring(Scope.close(scope, Exit.void)));
+  });
+  const address = server.address();
+  return SocketServer.SocketServer.of({
+    address: typeof address === "string" ? {
+      _tag: "UnixAddress",
+      path: address
+    } : {
+      _tag: "TcpAddress",
+      hostname: address.address,
+      port: address.port
+    },
+    run
+  });
+});
+/**
+ * @since 1.0.0
+ * @category layers
+ */
+const layerWebSocket = options => Layer.scoped(SocketServer.SocketServer, makeWebSocket(options));
+exports.layerWebSocket = layerWebSocket;
+const reportUnhandledError = cause => Effect.withFiberRuntime(fiber => {
+  const unhandledLogLevel = fiber.getFiberRef(FiberRef.unhandledErrorLogLevel);
+  if (unhandledLogLevel._tag === "Some") {
+    return Effect.logWithLevel(unhandledLogLevel.value, cause, "Unhandled error in SocketServer");
+  }
+  return Effect.void;
+});
+//# sourceMappingURL=NodeSocketServer.js.map
\ No newline at end of file
diff --git a/dist/cjs/NodeSocketServer.js.map b/dist/cjs/NodeSocketServer.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..12c88bae10fcee00c961bf92982f24e00fca5345
--- /dev/null
+++ b/dist/cjs/NodeSocketServer.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"NodeSocketServer.js","names":["Socket","_interopRequireWildcard","require","SocketServer","Context","Effect","Exit","FiberRef","FiberSet","_Function","Layer","Scope","Net","WS","NodeSocket","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","IncomingMessage","Tag","exports","make","fnUntraced","options","server","acquireRelease","sync","createServer","async","resume","close","void","once","cause","fail","SocketServerError","reason","listen","run","handler","scope","fiberSet","pipe","extend","runtime","onConnection","conn","fromDuplex","succeed","closed","destroySoon","flatMap","catchAllCause","reportUnhandledError","provideService","NetSocket","_resume","on","off","ensuring","address","of","_tag","path","hostname","port","layer","scoped","makeWebSocket","WebSocketServer","error","req","fromWebSocket","WebSocket","layerWebSocket","withFiberRuntime","fiber","unhandledLogLevel","getFiberRef","unhandledErrorLogLevel","logWithLevel","value"],"sources":["../../src/NodeSocketServer.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/dts/NodeClusterRunnerSocket.d.ts b/dist/dts/NodeClusterRunnerSocket.d.ts
new file mode 100644
index 0000000000000000000000000000000000000000..15eb51ab5cab443b2711f2431419ced98316e96f
--- /dev/null
+++ b/dist/dts/NodeClusterRunnerSocket.d.ts
@@ -0,0 +1,24 @@
+import type * as Runners from "@effect/cluster/Runners";
+import type { Sharding } from "@effect/cluster/Sharding";
+import * as ShardingConfig from "@effect/cluster/ShardingConfig";
+import type * as SocketServer from "@effect/platform/SocketServer";
+import type { SqlClient } from "@effect/sql/SqlClient";
+import type { SqlError } from "@effect/sql/SqlError";
+import type { ConfigError } from "effect/ConfigError";
+import * as Layer from "effect/Layer";
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+export declare const layerSocketServer: Layer.Layer<SocketServer.SocketServer, SocketServer.SocketServerError, ShardingConfig.ShardingConfig>;
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+export declare const layer: <const ClientOnly extends boolean = false, const Storage extends "noop" | "sql" = "noop">(options?: {
+    readonly serialization?: "msgpack" | "ndjson" | undefined;
+    readonly clientOnly?: ClientOnly | undefined;
+    readonly storage?: Storage | undefined;
+    readonly shardingConfig?: Partial<ShardingConfig.ShardingConfig["Type"]> | undefined;
+}) => ClientOnly extends true ? Layer.Layer<Sharding | Runners.Runners, ConfigError, Storage extends "sql" ? SqlClient : never> : Layer.Layer<Sharding | Runners.Runners, SocketServer.SocketServerError | ConfigError | (Storage extends "sql" ? SqlError : never), Storage extends "sql" ? SqlClient : never>;
+//# sourceMappingURL=NodeClusterRunnerSocket.d.ts.map
\ No newline at end of file
diff --git a/dist/dts/NodeClusterRunnerSocket.d.ts.map b/dist/dts/NodeClusterRunnerSocket.d.ts.map
new file mode 100644
index 0000000000000000000000000000000000000000..7a58669d6b3224eb837eccd687b06cde653c4941
--- /dev/null
+++ b/dist/dts/NodeClusterRunnerSocket.d.ts.map
@@ -0,0 +1 @@
+{"version":3,"file":"NodeClusterRunnerSocket.d.ts","sourceRoot":"","sources":["../../src/NodeClusterRunnerSocket.ts"],"names":[],"mappings":"AAIA,OAAO,KAAK,KAAK,OAAO,MAAM,yBAAyB,CAAA;AACvD,OAAO,KAAK,EAAE,QAAQ,EAAE,MAAM,0BAA0B,CAAA;AACxD,OAAO,KAAK,cAAc,MAAM,gCAAgC,CAAA;AAKhE,OAAO,KAAK,KAAK,YAAY,MAAM,+BAA+B,CAAA;AAElE,OAAO,KAAK,EAAE,SAAS,EAAE,MAAM,uBAAuB,CAAA;AACtD,OAAO,KAAK,EAAE,QAAQ,EAAE,MAAM,sBAAsB,CAAA;AACpD,OAAO,KAAK,EAAE,WAAW,EAAE,MAAM,oBAAoB,CAAA;AAErD,OAAO,KAAK,KAAK,MAAM,cAAc,CAAA;AAKrC;;;GAGG;AACH,eAAO,MAAM,iBAAiB,EAAE,KAAK,CAAC,KAAK,CACzC,YAAY,CAAC,YAAY,EACzB,YAAY,CAAC,iBAAiB,EAC9B,cAAc,CAAC,cAAc,CAOJ,CAAA;AAE3B;;;GAGG;AACH,eAAO,MAAM,KAAK,SAAU,UAAU,SAAS,OAAO,gBAAgB,OAAO,SAAS,MAAM,GAAG,KAAK,qBACxF;IACR,QAAQ,CAAC,aAAa,CAAC,EAAE,SAAS,GAAG,QAAQ,GAAG,SAAS,CAAA;IACzD,QAAQ,CAAC,UAAU,CAAC,EAAE,UAAU,GAAG,SAAS,CAAA;IAC5C,QAAQ,CAAC,OAAO,CAAC,EAAE,OAAO,GAAG,SAAS,CAAA;IACtC,QAAQ,CAAC,cAAc,CAAC,EAAE,OAAO,CAAC,cAAc,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC,GAAG,SAAS,CAAA;CACrF,KACA,UAAU,SAAS,IAAI,GAAG,KAAK,CAAC,KAAK,CACpC,QAAQ,GAAG,OAAO,CAAC,OAAO,EAC1B,WAAW,EACX,OAAO,SAAS,KAAK,GAAG,SAAS,GAAG,KAAK,CAC1C,GACD,KAAK,CAAC,KAAK,CACT,QAAQ,GAAG,OAAO,CAAC,OAAO,EAC1B,YAAY,CAAC,iBAAiB,GAAG,WAAW,GAAG,CAAC,OAAO,SAAS,KAAK,GAAG,QAAQ,GAAG,KAAK,CAAC,EACzF,OAAO,SAAS,KAAK,GAAG,SAAS,GAAG,KAAK,CAoB5C,CAAA"}
\ No newline at end of file
diff --git a/dist/dts/NodeClusterShardManagerSocket.d.ts b/dist/dts/NodeClusterShardManagerSocket.d.ts
new file mode 100644
index 0000000000000000000000000000000000000000..4aeb0ad22a2d98242cd57fdda9a382f042869510
--- /dev/null
+++ b/dist/dts/NodeClusterShardManagerSocket.d.ts
@@ -0,0 +1,22 @@
+import * as ShardingConfig from "@effect/cluster/ShardingConfig";
+import * as ShardManager from "@effect/cluster/ShardManager";
+import type * as SocketServer from "@effect/platform/SocketServer";
+import type { SqlClient } from "@effect/sql/SqlClient";
+import type { SqlError } from "@effect/sql/SqlError";
+import type { ConfigError } from "effect/ConfigError";
+import * as Layer from "effect/Layer";
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+export declare const layerSocketServer: Layer.Layer<SocketServer.SocketServer, SocketServer.SocketServerError, ShardingConfig.ShardingConfig>;
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+export declare const layer: <const Storage extends "sql" | "noop" = "noop">(options?: {
+    readonly serialization?: "msgpack" | "ndjson" | undefined;
+    readonly shardingConfig?: Partial<ShardingConfig.ShardingConfig["Type"]> | undefined;
+    readonly storage?: Storage | undefined;
+}) => Layer.Layer<ShardManager.ShardManager, SocketServer.SocketServerError | ConfigError | (Storage extends "sql" ? SqlError : never), Storage extends "sql" ? SqlClient : never>;
+//# sourceMappingURL=NodeClusterShardManagerSocket.d.ts.map
\ No newline at end of file
diff --git a/dist/dts/NodeClusterShardManagerSocket.d.ts.map b/dist/dts/NodeClusterShardManagerSocket.d.ts.map
new file mode 100644
index 0000000000000000000000000000000000000000..1a498f4af3e67e1dce7f7f1a325aaf748c75ce24
--- /dev/null
+++ b/dist/dts/NodeClusterShardManagerSocket.d.ts.map
@@ -0,0 +1 @@
+{"version":3,"file":"NodeClusterShardManagerSocket.d.ts","sourceRoot":"","sources":["../../src/NodeClusterShardManagerSocket.ts"],"names":[],"mappings":"AAIA,OAAO,KAAK,cAAc,MAAM,gCAAgC,CAAA;AAChE,OAAO,KAAK,YAAY,MAAM,8BAA8B,CAAA;AAI5D,OAAO,KAAK,KAAK,YAAY,MAAM,+BAA+B,CAAA;AAElE,OAAO,KAAK,EAAE,SAAS,EAAE,MAAM,uBAAuB,CAAA;AACtD,OAAO,KAAK,EAAE,QAAQ,EAAE,MAAM,sBAAsB,CAAA;AACpD,OAAO,KAAK,EAAE,WAAW,EAAE,MAAM,oBAAoB,CAAA;AAErD,OAAO,KAAK,KAAK,MAAM,cAAc,CAAA;AAIrC;;;GAGG;AACH,eAAO,MAAM,iBAAiB,EAAE,KAAK,CAAC,KAAK,CACzC,YAAY,CAAC,YAAY,EACzB,YAAY,CAAC,iBAAiB,EAC9B,cAAc,CAAC,cAAc,CAIJ,CAAA;AAE3B;;;GAGG;AACH,eAAO,MAAM,KAAK,SAAU,OAAO,SAAS,KAAK,GAAG,MAAM,qBAAqB;IAC7E,QAAQ,CAAC,aAAa,CAAC,EAAE,SAAS,GAAG,QAAQ,GAAG,SAAS,CAAA;IACzD,QAAQ,CAAC,cAAc,CAAC,EAAE,OAAO,CAAC,cAAc,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC,GAAG,SAAS,CAAA;IACpF,QAAQ,CAAC,OAAO,CAAC,EAAE,OAAO,GAAG,SAAS,CAAA;CACvC,KAAG,KAAK,CAAC,KAAK,CACb,YAAY,CAAC,YAAY,EACzB,YAAY,CAAC,iBAAiB,GAAG,WAAW,GAAG,CAAC,OAAO,SAAS,KAAK,GAAG,QAAQ,GAAG,KAAK,CAAC,EACzF,OAAO,SAAS,KAAK,GAAG,SAAS,GAAG,KAAK,CAUjC,CAAA"}
\ No newline at end of file
diff --git a/dist/dts/NodeClusterSocketCommon.d.ts b/dist/dts/NodeClusterSocketCommon.d.ts
new file mode 100644
index 0000000000000000000000000000000000000000..ceacbc1e12ee6302a83c51fa8260a324bee5b567
--- /dev/null
+++ b/dist/dts/NodeClusterSocketCommon.d.ts
@@ -0,0 +1,12 @@
+/**
+ * @since 1.0.0
+ */
+import * as Runners from "@effect/cluster/Runners";
+import * as RpcSerialization from "@effect/rpc/RpcSerialization";
+import * as Layer from "effect/Layer";
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+export declare const layerClientProtocol: Layer.Layer<Runners.RpcClientProtocol, never, RpcSerialization.RpcSerialization>;
+//# sourceMappingURL=NodeClusterSocketCommon.d.ts.map
\ No newline at end of file
diff --git a/dist/dts/NodeClusterSocketCommon.d.ts.map b/dist/dts/NodeClusterSocketCommon.d.ts.map
new file mode 100644
index 0000000000000000000000000000000000000000..434b24c6b555f61e21d67e4a45cc7b408ddddd69
--- /dev/null
+++ b/dist/dts/NodeClusterSocketCommon.d.ts.map
@@ -0,0 +1 @@
+{"version":3,"file":"NodeClusterSocketCommon.d.ts","sourceRoot":"","sources":["../../src/NodeClusterSocketCommon.ts"],"names":[],"mappings":"AAAA;;GAEG;AACH,OAAO,KAAK,OAAO,MAAM,yBAAyB,CAAA;AAGlD,OAAO,KAAK,gBAAgB,MAAM,8BAA8B,CAAA;AAEhE,OAAO,KAAK,KAAK,MAAM,cAAc,CAAA;AAGrC;;;GAGG;AACH,eAAO,MAAM,mBAAmB,EAAE,KAAK,CAAC,KAAK,CAC3C,OAAO,CAAC,iBAAiB,EACzB,KAAK,EACL,gBAAgB,CAAC,gBAAgB,CAgBlC,CAAA"}
\ No newline at end of file
diff --git a/dist/dts/NodeSocket.d.ts.map b/dist/dts/NodeSocket.d.ts.map
index 3902db2672b97c998839ab5e2618bddbc3330a8a..89d03302ca5d01b8b1c9cdeb52c7dad6990ae0fc 100644
--- a/dist/dts/NodeSocket.d.ts.map
+++ b/dist/dts/NodeSocket.d.ts.map
@@ -1 +1 @@
-{"version":3,"file":"NodeSocket.d.ts","sourceRoot":"","sources":["../../src/NodeSocket.ts"],"names":[],"mappings":"AAAA;;GAEG;AACH,OAAO,KAAK,MAAM,MAAM,yBAAyB,CAAA;AACjD,OAAO,KAAK,OAAO,MAAM,gBAAgB,CAAA;AACzC,OAAO,KAAK,KAAK,KAAK,MAAM,cAAc,CAAA;AAC1C,OAAO,KAAK,OAAO,MAAM,gBAAgB,CAAA;AAEzC,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AAEvC,OAAO,KAAK,KAAK,MAAM,cAAc,CAAA;AACrC,OAAO,KAAK,KAAK,MAAM,cAAc,CAAA;AACrC,OAAO,KAAK,GAAG,MAAM,UAAU,CAAA;AAC/B,OAAO,KAAK,EAAE,MAAM,EAAE,MAAM,aAAa,CAAA;AAEzC;;;GAGG;AACH,MAAM,WAAW,SAAS;IACxB,QAAQ,CAAC,CAAC,EAAE,OAAO,MAAM,CAAA;CAC1B;AAED;;;GAGG;AACH,eAAO,MAAM,SAAS,EAAE,OAAO,CAAC,GAAG,CAAC,SAAS,EAAE,GAAG,CAAC,MAAM,CAExD,CAAA;AAED;;;GAGG;AACH,eAAO,MAAM,OAAO,YACT,GAAG,CAAC,cAAc,KAC1B,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,MAAM,EAAE,MAAM,CAAC,WAAW,CA4B/C,CAAA;AAEH;;;GAGG;AACH,eAAO,MAAM,UAAU,GAAI,EAAE,QACrB,MAAM,CAAC,MAAM,CAAC,MAAM,EAAE,MAAM,CAAC,WAAW,EAAE,EAAE,CAAC,KAClD,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,MAAM,EAAE,KAAK,EAAE,OAAO,CAAC,EAAE,EAAE,KAAK,CAAC,KAAK,CAAC,CAmG3D,CAAA;AAEJ;;;GAGG;AACH,eAAO,MAAM,cAAc,GAAI,EAAE,mBACtB,GAAG,CAAC,cAAc,KAC1B,OAAO,CAAC,OAAO,CAChB,KAAK,CAAC,KAAK,CAAC,UAAU,CAAC,EACvB,KAAK,CAAC,KAAK,CAAC,UAAU,GAAG,MAAM,GAAG,MAAM,CAAC,UAAU,CAAC,EACpD,MAAM,CAAC,WAAW,GAAG,EAAE,EACvB,EAAE,EACF,IAAI,EACJ,OAAO,CAIN,CAAA;AAEH;;;GAGG;AACH,eAAO,MAAM,QAAQ,YAAa,GAAG,CAAC,cAAc,KAAG,KAAK,CAAC,KAAK,CAAC,MAAM,CAAC,MAAM,EAAE,MAAM,CAAC,WAAW,CACrD,CAAA"}
\ No newline at end of file
+{"version":3,"file":"NodeSocket.d.ts","sourceRoot":"","sources":["../../src/NodeSocket.ts"],"names":[],"mappings":"AAAA;;GAEG;AACH,OAAO,KAAK,MAAM,MAAM,yBAAyB,CAAA;AACjD,OAAO,KAAK,OAAO,MAAM,gBAAgB,CAAA;AACzC,OAAO,KAAK,KAAK,KAAK,MAAM,cAAc,CAAA;AAC1C,OAAO,KAAK,OAAO,MAAM,gBAAgB,CAAA;AAEzC,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AAEvC,OAAO,KAAK,KAAK,MAAM,cAAc,CAAA;AACrC,OAAO,KAAK,KAAK,MAAM,cAAc,CAAA;AACrC,OAAO,KAAK,GAAG,MAAM,UAAU,CAAA;AAC/B,OAAO,KAAK,EAAE,MAAM,EAAE,MAAM,aAAa,CAAA;AAEzC;;;GAGG;AACH,MAAM,WAAW,SAAS;IACxB,QAAQ,CAAC,CAAC,EAAE,OAAO,MAAM,CAAA;CAC1B;AAED;;;GAGG;AACH,eAAO,MAAM,SAAS,EAAE,OAAO,CAAC,GAAG,CAAC,SAAS,EAAE,GAAG,CAAC,MAAM,CAExD,CAAA;AAED;;;GAGG;AACH,eAAO,MAAM,OAAO,YACT,GAAG,CAAC,cAAc,KAC1B,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,MAAM,EAAE,MAAM,CAAC,WAAW,CA6B/C,CAAA;AAEH;;;GAGG;AACH,eAAO,MAAM,UAAU,GAAI,EAAE,QACrB,MAAM,CAAC,MAAM,CAAC,MAAM,EAAE,MAAM,CAAC,WAAW,EAAE,EAAE,CAAC,KAClD,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,MAAM,EAAE,KAAK,EAAE,OAAO,CAAC,EAAE,EAAE,KAAK,CAAC,KAAK,CAAC,CAiG3D,CAAA;AAEJ;;;GAGG;AACH,eAAO,MAAM,cAAc,GAAI,EAAE,mBACtB,GAAG,CAAC,cAAc,KAC1B,OAAO,CAAC,OAAO,CAChB,KAAK,CAAC,KAAK,CAAC,UAAU,CAAC,EACvB,KAAK,CAAC,KAAK,CAAC,UAAU,GAAG,MAAM,GAAG,MAAM,CAAC,UAAU,CAAC,EACpD,MAAM,CAAC,WAAW,GAAG,EAAE,EACvB,EAAE,EACF,IAAI,EACJ,OAAO,CAIN,CAAA;AAEH;;;GAGG;AACH,eAAO,MAAM,QAAQ,YAAa,GAAG,CAAC,cAAc,KAAG,KAAK,CAAC,KAAK,CAAC,MAAM,CAAC,MAAM,EAAE,MAAM,CAAC,WAAW,CACrD,CAAA"}
\ No newline at end of file
diff --git a/dist/dts/NodeSocketServer.d.ts b/dist/dts/NodeSocketServer.d.ts
new file mode 100644
index 0000000000000000000000000000000000000000..1a048539a73949e822583d53b22b266a4986dd32
--- /dev/null
+++ b/dist/dts/NodeSocketServer.d.ts
@@ -0,0 +1,44 @@
+/**
+ * @since 1.0.0
+ */
+import * as Socket from "@effect/platform/Socket";
+import * as SocketServer from "@effect/platform/SocketServer";
+import * as Context from "effect/Context";
+import * as Effect from "effect/Effect";
+import * as Layer from "effect/Layer";
+import * as Scope from "effect/Scope";
+import type * as Http from "node:http";
+import * as Net from "node:net";
+import * as WS from "ws";
+declare const IncomingMessage_base: Context.TagClass<IncomingMessage, "@effect/platform-node-shared/NodeSocketServer/IncomingMessage", Http.IncomingMessage>;
+/**
+ * @since 1.0.0
+ * @category tags
+ */
+export declare class IncomingMessage extends IncomingMessage_base {
+}
+/**
+ * @since 1.0.0
+ * @category constructors
+ */
+export declare const make: (options: Net.ServerOpts & Net.ListenOptions) => Effect.Effect<{
+    readonly address: SocketServer.Address;
+    readonly run: <R, E, _>(handler: (socket: Socket.Socket) => Effect.Effect<_, E, R>) => Effect.Effect<never, SocketServer.SocketServerError, R>;
+}, SocketServer.SocketServerError, Scope.Scope>;
+/**
+ * @since 1.0.0
+ * @category layers
+ */
+export declare const layer: (options: Net.ServerOpts & Net.ListenOptions) => Layer.Layer<SocketServer.SocketServer, SocketServer.SocketServerError>;
+/**
+ * @since 1.0.0
+ * @category constructors
+ */
+export declare const makeWebSocket: (options: WS.ServerOptions<typeof WS.WebSocket, typeof Http.IncomingMessage>) => Effect.Effect<SocketServer.SocketServer["Type"], SocketServer.SocketServerError, Scope.Scope>;
+/**
+ * @since 1.0.0
+ * @category layers
+ */
+export declare const layerWebSocket: (options: WS.ServerOptions) => Layer.Layer<SocketServer.SocketServer, SocketServer.SocketServerError>;
+export {};
+//# sourceMappingURL=NodeSocketServer.d.ts.map
\ No newline at end of file
diff --git a/dist/dts/NodeSocketServer.d.ts.map b/dist/dts/NodeSocketServer.d.ts.map
new file mode 100644
index 0000000000000000000000000000000000000000..f01c1b449c63b843a4c07ce4972f01fe32d02929
--- /dev/null
+++ b/dist/dts/NodeSocketServer.d.ts.map
@@ -0,0 +1 @@
+{"version":3,"file":"NodeSocketServer.d.ts","sourceRoot":"","sources":["../../src/NodeSocketServer.ts"],"names":[],"mappings":"AAAA;;GAEG;AACH,OAAO,KAAK,MAAM,MAAM,yBAAyB,CAAA;AACjD,OAAO,KAAK,YAAY,MAAM,+BAA+B,CAAA;AAE7D,OAAO,KAAK,OAAO,MAAM,gBAAgB,CAAA;AACzC,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AAKvC,OAAO,KAAK,KAAK,MAAM,cAAc,CAAA;AACrC,OAAO,KAAK,KAAK,MAAM,cAAc,CAAA;AACrC,OAAO,KAAK,KAAK,IAAI,MAAM,WAAW,CAAA;AACtC,OAAO,KAAK,GAAG,MAAM,UAAU,CAAA;AAC/B,OAAO,KAAK,EAAE,MAAM,IAAI,CAAA;;AAGxB;;;GAGG;AACH,qBAAa,eAAgB,SAAQ,oBAGlC;CAAG;AAEN;;;GAGG;AACH,eAAO,MAAM,IAAI;;8CAvBmB,OACpC,MAAM,KAAI,OAAQ,MAAM,cAAa,OACpC,MAAM;+CA+FL,CAAA;AAEF;;;GAGG;AACH,eAAO,MAAM,KAAK,YACP,GAAG,CAAC,UAAU,GAAG,GAAG,CAAC,aAAa,KAC1C,KAAK,CAAC,KAAK,CAAC,YAAY,CAAC,YAAY,EAAE,YAAY,CAAC,iBAAiB,CAIrE,CAAA;AAEH;;;GAGG;AACH,eAAO,MAAM,aAAa,EAAE,CAC1B,OAAO,EAAE,EAAE,CAAC,aAAa,CAAC,OAAO,EAAE,CAAC,SAAS,EAAE,OAAO,IAAI,CAAC,eAAe,CAAC,KACxE,MAAM,CAAC,MAAM,CAChB,YAAY,CAAC,YAAY,CAAC,MAAM,CAAC,EACjC,YAAY,CAAC,iBAAiB,EAC9B,KAAK,CAAC,KAAK,CA0EX,CAAA;AAEF;;;GAGG;AACH,eAAO,MAAM,cAAc,YAChB,EAAE,CAAC,aAAa,KACxB,KAAK,CAAC,KAAK,CAAC,YAAY,CAAC,YAAY,EAAE,YAAY,CAAC,iBAAiB,CAIrE,CAAA"}
\ No newline at end of file
diff --git a/dist/esm/NodeClusterRunnerSocket.js b/dist/esm/NodeClusterRunnerSocket.js
new file mode 100644
index 0000000000000000000000000000000000000000..54fda698154ee338869796ae6a66de4944ef070c
--- /dev/null
+++ b/dist/esm/NodeClusterRunnerSocket.js
@@ -0,0 +1,39 @@
+/**
+ * @since 1.0.0
+ */
+import * as MessageStorage from "@effect/cluster/MessageStorage";
+import * as ShardingConfig from "@effect/cluster/ShardingConfig";
+import * as ShardStorage from "@effect/cluster/ShardStorage";
+import * as SocketRunner from "@effect/cluster/SocketRunner";
+import * as SqlMessageStorage from "@effect/cluster/SqlMessageStorage";
+import * as SqlShardStorage from "@effect/cluster/SqlShardStorage";
+import * as RpcSerialization from "@effect/rpc/RpcSerialization";
+import * as Effect from "effect/Effect";
+import * as Layer from "effect/Layer";
+import * as Option from "effect/Option";
+import { layerClientProtocol } from "./NodeClusterSocketCommon.js";
+import * as NodeSocketServer from "./NodeSocketServer.js";
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+export const layerSocketServer = /*#__PURE__*/Effect.gen(function* () {
+  const config = yield* ShardingConfig.ShardingConfig;
+  if (Option.isNone(config.runnerAddress)) {
+    return yield* Effect.dieMessage("layerSocketServer: ShardingConfig.runnerAddress is None");
+  }
+  return NodeSocketServer.layer(config.runnerAddress.value);
+}).pipe(Layer.unwrapEffect);
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+export const layer = options => {
+  const layer = options?.clientOnly
+  // client only
+  ? Layer.provide(SocketRunner.layerClientOnly, layerClientProtocol)
+  // with server
+  : Layer.provide(SocketRunner.layer, [layerSocketServer, layerClientProtocol]);
+  return layer.pipe(Layer.provide(options?.storage === "sql" ? options.clientOnly ? [SqlMessageStorage.layer] : [SqlMessageStorage.layer, SqlShardStorage.layer] : [MessageStorage.layerNoop, ShardStorage.layerNoop]), Layer.provide(ShardingConfig.layerFromEnv(options?.shardingConfig)), Layer.provide(options?.serialization === "ndjson" ? RpcSerialization.layerNdjson : RpcSerialization.layerMsgPack));
+};
+//# sourceMappingURL=NodeClusterRunnerSocket.js.map
\ No newline at end of file
diff --git a/dist/esm/NodeClusterRunnerSocket.js.map b/dist/esm/NodeClusterRunnerSocket.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..205d6e03896bcb19fab6d9a0be26170113dcaa8d
--- /dev/null
+++ b/dist/esm/NodeClusterRunnerSocket.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"NodeClusterRunnerSocket.js","names":["MessageStorage","ShardingConfig","ShardStorage","SocketRunner","SqlMessageStorage","SqlShardStorage","RpcSerialization","Effect","Layer","Option","layerClientProtocol","NodeSocketServer","layerSocketServer","gen","config","isNone","runnerAddress","dieMessage","layer","value","pipe","unwrapEffect","options","clientOnly","provide","layerClientOnly","storage","layerNoop","layerFromEnv","shardingConfig","serialization","layerNdjson","layerMsgPack"],"sources":["../../src/NodeClusterRunnerSocket.ts"],"sourcesContent":[null],"mappings":"AAAA;;;AAGA,OAAO,KAAKA,cAAc,MAAM,gCAAgC;AAGhE,OAAO,KAAKC,cAAc,MAAM,gCAAgC;AAChE,OAAO,KAAKC,YAAY,MAAM,8BAA8B;AAC5D,OAAO,KAAKC,YAAY,MAAM,8BAA8B;AAC5D,OAAO,KAAKC,iBAAiB,MAAM,mCAAmC;AACtE,OAAO,KAAKC,eAAe,MAAM,iCAAiC;AAElE,OAAO,KAAKC,gBAAgB,MAAM,8BAA8B;AAIhE,OAAO,KAAKC,MAAM,MAAM,eAAe;AACvC,OAAO,KAAKC,KAAK,MAAM,cAAc;AACrC,OAAO,KAAKC,MAAM,MAAM,eAAe;AACvC,SAASC,mBAAmB,QAAQ,8BAA8B;AAClE,OAAO,KAAKC,gBAAgB,MAAM,uBAAuB;AAEzD;;;;AAIA,OAAO,MAAMC,iBAAiB,gBAI1BL,MAAM,CAACM,GAAG,CAAC,aAAS;EACtB,MAAMC,MAAM,GAAG,OAAOb,cAAc,CAACA,cAAc;EACnD,IAAIQ,MAAM,CAACM,MAAM,CAACD,MAAM,CAACE,aAAa,CAAC,EAAE;IACvC,OAAO,OAAOT,MAAM,CAACU,UAAU,CAAC,yDAAyD,CAAC;EAC5F;EACA,OAAON,gBAAgB,CAACO,KAAK,CAACJ,MAAM,CAACE,aAAa,CAACG,KAAK,CAAC;AAC3D,CAAC,CAAC,CAACC,IAAI,CAACZ,KAAK,CAACa,YAAY,CAAC;AAE3B;;;;AAIA,OAAO,MAAMH,KAAK,GAChBI,OAKC,IAUG;EAEJ,MAAMJ,KAAK,GAA+BI,OAAO,EAAEC;EACjD;EAAA,EACEf,KAAK,CAACgB,OAAO,CAACrB,YAAY,CAACsB,eAAe,EAAEf,mBAAmB;EACjE;EAAA,EACEF,KAAK,CAACgB,OAAO,CAACrB,YAAY,CAACe,KAAK,EAAE,CAACN,iBAAiB,EAAEF,mBAAmB,CAAC,CAAC;EAE/E,OAAOQ,KAAK,CAACE,IAAI,CACfZ,KAAK,CAACgB,OAAO,CACXF,OAAO,EAAEI,OAAO,KAAK,KAAK,GACtBJ,OAAO,CAACC,UAAU,GAAG,CAACnB,iBAAiB,CAACc,KAAK,CAAC,GAAG,CAACd,iBAAiB,CAACc,KAAK,EAAEb,eAAe,CAACa,KAAK,CAAC,GACjG,CAAClB,cAAc,CAAC2B,SAAS,EAAEzB,YAAY,CAACyB,SAAS,CAAC,CACvD,EACDnB,KAAK,CAACgB,OAAO,CAACvB,cAAc,CAAC2B,YAAY,CAACN,OAAO,EAAEO,cAAc,CAAC,CAAC,EACnErB,KAAK,CAACgB,OAAO,CACXF,OAAO,EAAEQ,aAAa,KAAK,QAAQ,GAAGxB,gBAAgB,CAACyB,WAAW,GAAGzB,gBAAgB,CAAC0B,YAAY,CACnG,CACK;AACV,CAAC","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/NodeClusterShardManagerSocket.js b/dist/esm/NodeClusterShardManagerSocket.js
new file mode 100644
index 0000000000000000000000000000000000000000..59b7bc011031beda375a2a1ac2ca1ba8d03aee53
--- /dev/null
+++ b/dist/esm/NodeClusterShardManagerSocket.js
@@ -0,0 +1,28 @@
+/**
+ * @since 1.0.0
+ */
+import * as RunnerHealth from "@effect/cluster/RunnerHealth";
+import * as ShardingConfig from "@effect/cluster/ShardingConfig";
+import * as ShardManager from "@effect/cluster/ShardManager";
+import * as ShardStorage from "@effect/cluster/ShardStorage";
+import * as SocketShardManager from "@effect/cluster/SocketShardManager";
+import * as SqlShardStorage from "@effect/cluster/SqlShardStorage";
+import * as RpcSerialization from "@effect/rpc/RpcSerialization";
+import * as Effect from "effect/Effect";
+import * as Layer from "effect/Layer";
+import { layerClientProtocol } from "./NodeClusterSocketCommon.js";
+import * as NodeSocketServer from "./NodeSocketServer.js";
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+export const layerSocketServer = /*#__PURE__*/Effect.gen(function* () {
+  const config = yield* ShardingConfig.ShardingConfig;
+  return NodeSocketServer.layer(config.shardManagerAddress);
+}).pipe(Layer.unwrapEffect);
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+export const layer = options => SocketShardManager.layer.pipe(Layer.provide([RunnerHealth.layerRpc, layerSocketServer, ShardManager.layerConfigFromEnv]), Layer.provide(layerClientProtocol), Layer.provide(options?.storage === "sql" ? SqlShardStorage.layer : ShardStorage.layerNoop), Layer.provide([options?.serialization === "ndjson" ? RpcSerialization.layerNdjson : RpcSerialization.layerMsgPack, ShardingConfig.layerFromEnv(options?.shardingConfig)]));
+//# sourceMappingURL=NodeClusterShardManagerSocket.js.map
\ No newline at end of file
diff --git a/dist/esm/NodeClusterShardManagerSocket.js.map b/dist/esm/NodeClusterShardManagerSocket.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..3135dda3f1ce6c5d8931e46798c1b1a9813e66bf
--- /dev/null
+++ b/dist/esm/NodeClusterShardManagerSocket.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"NodeClusterShardManagerSocket.js","names":["RunnerHealth","ShardingConfig","ShardManager","ShardStorage","SocketShardManager","SqlShardStorage","RpcSerialization","Effect","Layer","layerClientProtocol","NodeSocketServer","layerSocketServer","gen","config","layer","shardManagerAddress","pipe","unwrapEffect","options","provide","layerRpc","layerConfigFromEnv","storage","layerNoop","serialization","layerNdjson","layerMsgPack","layerFromEnv","shardingConfig"],"sources":["../../src/NodeClusterShardManagerSocket.ts"],"sourcesContent":[null],"mappings":"AAAA;;;AAGA,OAAO,KAAKA,YAAY,MAAM,8BAA8B;AAC5D,OAAO,KAAKC,cAAc,MAAM,gCAAgC;AAChE,OAAO,KAAKC,YAAY,MAAM,8BAA8B;AAC5D,OAAO,KAAKC,YAAY,MAAM,8BAA8B;AAC5D,OAAO,KAAKC,kBAAkB,MAAM,oCAAoC;AACxE,OAAO,KAAKC,eAAe,MAAM,iCAAiC;AAElE,OAAO,KAAKC,gBAAgB,MAAM,8BAA8B;AAIhE,OAAO,KAAKC,MAAM,MAAM,eAAe;AACvC,OAAO,KAAKC,KAAK,MAAM,cAAc;AACrC,SAASC,mBAAmB,QAAQ,8BAA8B;AAClE,OAAO,KAAKC,gBAAgB,MAAM,uBAAuB;AAEzD;;;;AAIA,OAAO,MAAMC,iBAAiB,gBAI1BJ,MAAM,CAACK,GAAG,CAAC,aAAS;EACtB,MAAMC,MAAM,GAAG,OAAOZ,cAAc,CAACA,cAAc;EACnD,OAAOS,gBAAgB,CAACI,KAAK,CAACD,MAAM,CAACE,mBAAmB,CAAC;AAC3D,CAAC,CAAC,CAACC,IAAI,CAACR,KAAK,CAACS,YAAY,CAAC;AAE3B;;;;AAIA,OAAO,MAAMH,KAAK,GAAmDI,OAIpE,IAKCd,kBAAkB,CAACU,KAAK,CAACE,IAAI,CAC3BR,KAAK,CAACW,OAAO,CAAC,CAACnB,YAAY,CAACoB,QAAQ,EAAET,iBAAiB,EAAET,YAAY,CAACmB,kBAAkB,CAAC,CAAC,EAC1Fb,KAAK,CAACW,OAAO,CAACV,mBAAmB,CAAC,EAClCD,KAAK,CAACW,OAAO,CAACD,OAAO,EAAEI,OAAO,KAAK,KAAK,GAAGjB,eAAe,CAACS,KAAK,GAAGX,YAAY,CAACoB,SAAS,CAAC,EAC1Ff,KAAK,CAACW,OAAO,CAAC,CACZD,OAAO,EAAEM,aAAa,KAAK,QAAQ,GAAGlB,gBAAgB,CAACmB,WAAW,GAAGnB,gBAAgB,CAACoB,YAAY,EAClGzB,cAAc,CAAC0B,YAAY,CAACT,OAAO,EAAEU,cAAc,CAAC,CACrD,CAAC,CACI","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/NodeClusterSocketCommon.js b/dist/esm/NodeClusterSocketCommon.js
new file mode 100644
index 0000000000000000000000000000000000000000..5f9036ed0fbb0628f4a1af06ce187ca9e474c699
--- /dev/null
+++ b/dist/esm/NodeClusterSocketCommon.js
@@ -0,0 +1,25 @@
+/**
+ * @since 1.0.0
+ */
+import * as Runners from "@effect/cluster/Runners";
+import { Socket } from "@effect/platform/Socket";
+import * as RpcClient from "@effect/rpc/RpcClient";
+import * as RpcSerialization from "@effect/rpc/RpcSerialization";
+import * as Effect from "effect/Effect";
+import * as Layer from "effect/Layer";
+import * as NodeSocket from "./NodeSocket.js";
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+export const layerClientProtocol = /*#__PURE__*/Layer.effect(Runners.RpcClientProtocol, /*#__PURE__*/Effect.gen(function* () {
+  const serialization = yield* RpcSerialization.RpcSerialization;
+  return Effect.fnUntraced(function* (address) {
+    const socket = yield* NodeSocket.makeNet({
+      host: address.host,
+      port: address.port
+    });
+    return yield* RpcClient.makeProtocolSocket.pipe(Effect.provideService(Socket, socket), Effect.provideService(RpcSerialization.RpcSerialization, serialization));
+  }, Effect.orDie);
+}));
+//# sourceMappingURL=NodeClusterSocketCommon.js.map
\ No newline at end of file
diff --git a/dist/esm/NodeClusterSocketCommon.js.map b/dist/esm/NodeClusterSocketCommon.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..2e5c7f6065204b04f655e2015ab6cd167833e79a
--- /dev/null
+++ b/dist/esm/NodeClusterSocketCommon.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"NodeClusterSocketCommon.js","names":["Runners","Socket","RpcClient","RpcSerialization","Effect","Layer","NodeSocket","layerClientProtocol","effect","RpcClientProtocol","gen","serialization","fnUntraced","address","socket","makeNet","host","port","makeProtocolSocket","pipe","provideService","orDie"],"sources":["../../src/NodeClusterSocketCommon.ts"],"sourcesContent":[null],"mappings":"AAAA;;;AAGA,OAAO,KAAKA,OAAO,MAAM,yBAAyB;AAClD,SAASC,MAAM,QAAQ,yBAAyB;AAChD,OAAO,KAAKC,SAAS,MAAM,uBAAuB;AAClD,OAAO,KAAKC,gBAAgB,MAAM,8BAA8B;AAChE,OAAO,KAAKC,MAAM,MAAM,eAAe;AACvC,OAAO,KAAKC,KAAK,MAAM,cAAc;AACrC,OAAO,KAAKC,UAAU,MAAM,iBAAiB;AAE7C;;;;AAIA,OAAO,MAAMC,mBAAmB,gBAI5BF,KAAK,CAACG,MAAM,CACdR,OAAO,CAACS,iBAAiB,eACzBL,MAAM,CAACM,GAAG,CAAC,aAAS;EAClB,MAAMC,aAAa,GAAG,OAAOR,gBAAgB,CAACA,gBAAgB;EAC9D,OAAOC,MAAM,CAACQ,UAAU,CAAC,WAAUC,OAAO;IACxC,MAAMC,MAAM,GAAG,OAAOR,UAAU,CAACS,OAAO,CAAC;MACvCC,IAAI,EAAEH,OAAO,CAACG,IAAI;MAClBC,IAAI,EAAEJ,OAAO,CAACI;KACf,CAAC;IACF,OAAO,OAAOf,SAAS,CAACgB,kBAAkB,CAACC,IAAI,CAC7Cf,MAAM,CAACgB,cAAc,CAACnB,MAAM,EAAEa,MAAM,CAAC,EACrCV,MAAM,CAACgB,cAAc,CAACjB,gBAAgB,CAACA,gBAAgB,EAAEQ,aAAa,CAAC,CACxE;EACH,CAAC,EAAEP,MAAM,CAACiB,KAAK,CAAC;AAClB,CAAC,CAAC,CACH","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/NodeSocket.js b/dist/esm/NodeSocket.js
index 7f02e78a16c83384e5f55d0fe587c034efe4748f..22e88af47008bd3bcb4e9edcef43cdbb3cbae1bb 100644
--- a/dist/esm/NodeSocket.js
+++ b/dist/esm/NodeSocket.js
@@ -26,6 +26,7 @@ export const makeNet = options => fromDuplex(Effect.acquireRelease(Effect.async(
     resume(Effect.succeed(conn));
   });
   conn.on("error", cause => {
+    conn.removeAllListeners();
     resume(Effect.fail(new Socket.SocketGenericError({
       reason: "Open",
       cause
@@ -53,7 +54,7 @@ export const fromDuplex = open => Effect.withFiberRuntime(fiber => {
   let currentSocket;
   const latch = Effect.unsafeMakeLatch(false);
   const openContext = fiber.currentContext;
-  const run = handler => Effect.scopedWith(scope => Effect.gen(function* () {
+  const run = handler => Effect.scopedWith(Effect.fnUntraced(function* (scope) {
     const fiberSet = yield* FiberSet.make().pipe(Scope.extend(scope));
     const conn = yield* Scope.extend(open, scope);
     const run = yield* Effect.provideService(FiberSet.runtime(fiberSet)(), NetSocket, conn);
diff --git a/dist/esm/NodeSocket.js.map b/dist/esm/NodeSocket.js.map
index cb30ac9b83f8e5c0266c2aaf05be2e9c870c0c76..1894ebba39d2225a8ffc35d28d18aa5a1acf7dc5 100644
--- a/dist/esm/NodeSocket.js.map
+++ b/dist/esm/NodeSocket.js.map
@@ -1 +1 @@
-{"version":3,"file":"NodeSocket.js","names":["Socket","Channel","Context","Deferred","Effect","FiberSet","Layer","Scope","Net","NetSocket","GenericTag","makeNet","options","fromDuplex","acquireRelease","async","resume","conn","createConnection","on","removeAllListeners","succeed","cause","fail","SocketGenericError","reason","sync","destroy","closed","destroySoon","open","withFiberRuntime","fiber","currentSocket","latch","unsafeMakeLatch","openContext","currentContext","run","handler","scopedWith","scope","gen","fiberSet","make","pipe","extend","provideService","runtime","onData","chunk","result","isEffect","onEnd","unsafeDone","deferred","void","onError","onClose","hadError","SocketCloseError","code","addFinalizer","off","join","mapInputContext","input","merge","ensuring","unsafeClose","undefined","interruptible","write","whenOpen","isCloseEvent","Error","writer","writableEnded","end","of","TypeId","runRaw","makeNetChannel","unwrapScoped","map","toChannelWith","layerNet","effect"],"sources":["../../src/NodeSocket.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
+{"version":3,"file":"NodeSocket.js","names":["Socket","Channel","Context","Deferred","Effect","FiberSet","Layer","Scope","Net","NetSocket","GenericTag","makeNet","options","fromDuplex","acquireRelease","async","resume","conn","createConnection","on","removeAllListeners","succeed","cause","fail","SocketGenericError","reason","sync","destroy","closed","destroySoon","open","withFiberRuntime","fiber","currentSocket","latch","unsafeMakeLatch","openContext","currentContext","run","handler","scopedWith","fnUntraced","scope","fiberSet","make","pipe","extend","provideService","runtime","onData","chunk","result","isEffect","onEnd","unsafeDone","deferred","void","onError","onClose","hadError","SocketCloseError","code","addFinalizer","off","join","mapInputContext","input","merge","ensuring","unsafeClose","undefined","interruptible","write","whenOpen","isCloseEvent","Error","writer","writableEnded","end","of","TypeId","runRaw","makeNetChannel","unwrapScoped","map","toChannelWith","layerNet","effect"],"sources":["../../src/NodeSocket.ts"],"sourcesContent":[null],"mappings":"AAAA;;;AAGA,OAAO,KAAKA,MAAM,MAAM,yBAAyB;AACjD,OAAO,KAAKC,OAAO,MAAM,gBAAgB;AAEzC,OAAO,KAAKC,OAAO,MAAM,gBAAgB;AACzC,OAAO,KAAKC,QAAQ,MAAM,iBAAiB;AAC3C,OAAO,KAAKC,MAAM,MAAM,eAAe;AACvC,OAAO,KAAKC,QAAQ,MAAM,iBAAiB;AAC3C,OAAO,KAAKC,KAAK,MAAM,cAAc;AACrC,OAAO,KAAKC,KAAK,MAAM,cAAc;AACrC,OAAO,KAAKC,GAAG,MAAM,UAAU;AAW/B;;;;AAIA,OAAO,MAAMC,SAAS,gBAAuCP,OAAO,CAACQ,UAAU,CAC7E,4CAA4C,CAC7C;AAED;;;;AAIA,OAAO,MAAMC,OAAO,GAClBC,OAA2B,IAE3BC,UAAU,CACRT,MAAM,CAACU,cAAc,CACnBV,MAAM,CAACW,KAAK,CAAyCC,MAAM,IAAI;EAC7D,MAAMC,IAAI,GAAGT,GAAG,CAACU,gBAAgB,CAACN,OAAO,CAAC;EAC1CK,IAAI,CAACE,EAAE,CAAC,SAAS,EAAE,MAAK;IACtBF,IAAI,CAACG,kBAAkB,EAAE;IACzBJ,MAAM,CAACZ,MAAM,CAACiB,OAAO,CAACJ,IAAI,CAAC,CAAC;EAC9B,CAAC,CAAC;EACFA,IAAI,CAACE,EAAE,CAAC,OAAO,EAAGG,KAAK,IAAI;IACzBL,IAAI,CAACG,kBAAkB,EAAE;IACzBJ,MAAM,CAACZ,MAAM,CAACmB,IAAI,CAAC,IAAIvB,MAAM,CAACwB,kBAAkB,CAAC;MAAEC,MAAM,EAAE,MAAM;MAAEH;IAAK,CAAE,CAAC,CAAC,CAAC;EAC/E,CAAC,CAAC;EACF,OAAOlB,MAAM,CAACsB,IAAI,CAAC,MAAK;IACtBT,IAAI,CAACU,OAAO,EAAE;EAChB,CAAC,CAAC;AACJ,CAAC,CAAC,EACDV,IAAI,IACHb,MAAM,CAACsB,IAAI,CAAC,MAAK;EACf,IAAIT,IAAI,CAACW,MAAM,KAAK,KAAK,EAAE;IACzB,IAAI,aAAa,IAAIX,IAAI,EAAE;MACzBA,IAAI,CAACY,WAAW,EAAE;IACpB,CAAC,MAAM;MACL;MAAEZ,IAAmB,CAACU,OAAO,EAAE;IACjC;EACF;EACAV,IAAI,CAACG,kBAAkB,EAAE;AAC3B,CAAC,CAAC,CACL,CACF;AAEH;;;;AAIA,OAAO,MAAMP,UAAU,GACrBiB,IAAmD,IAEnD1B,MAAM,CAAC2B,gBAAgB,CAAkDC,KAAK,IAAI;EAChF,IAAIC,aAAiC;EACrC,MAAMC,KAAK,GAAG9B,MAAM,CAAC+B,eAAe,CAAC,KAAK,CAAC;EAC3C,MAAMC,WAAW,GAAGJ,KAAK,CAACK,cAAqC;EAC/D,MAAMC,GAAG,GAAaC,OAAyD,IAC7EnC,MAAM,CAACoC,UAAU,CAACpC,MAAM,CAACqC,UAAU,CAAC,WAAUC,KAAK;IACjD,MAAMC,QAAQ,GAAG,OAAOtC,QAAQ,CAACuC,IAAI,EAA+B,CAACC,IAAI,CACvEtC,KAAK,CAACuC,MAAM,CAACJ,KAAK,CAAC,CACpB;IACD,MAAMzB,IAAI,GAAG,OAAOV,KAAK,CAACuC,MAAM,CAAChB,IAAI,EAAEY,KAAK,CAAC;IAC7C,MAAMJ,GAAG,GAAG,OAAOlC,MAAM,CAAC2C,cAAc,CAAC1C,QAAQ,CAAC2C,OAAO,CAACL,QAAQ,CAAC,EAAK,EAAElC,SAAS,EAAEQ,IAAkB,CAAC;IAExG,SAASgC,MAAMA,CAACC,KAAiB;MAC/B,MAAMC,MAAM,GAAGZ,OAAO,CAACW,KAAK,CAAC;MAC7B,IAAI9C,MAAM,CAACgD,QAAQ,CAACD,MAAM,CAAC,EAAE;QAC3Bb,GAAG,CAACa,MAAM,CAAC;MACb;IACF;IACA,SAASE,KAAKA,CAAA;MACZlD,QAAQ,CAACmD,UAAU,CAACX,QAAQ,CAACY,QAAQ,EAAEnD,MAAM,CAACoD,IAAI,CAAC;IACrD;IACA,SAASC,OAAOA,CAACnC,KAAY;MAC3BnB,QAAQ,CAACmD,UAAU,CACjBX,QAAQ,CAACY,QAAQ,EACjBnD,MAAM,CAACmB,IAAI,CAAC,IAAIvB,MAAM,CAACwB,kBAAkB,CAAC;QAAEC,MAAM,EAAE,MAAM;QAAEH;MAAK,CAAE,CAAC,CAAC,CACtE;IACH;IACA,SAASoC,OAAOA,CAACC,QAAiB;MAChCxD,QAAQ,CAACmD,UAAU,CACjBX,QAAQ,CAACY,QAAQ,EACjBnD,MAAM,CAACmB,IAAI,CACT,IAAIvB,MAAM,CAAC4D,gBAAgB,CAAC;QAC1BnC,MAAM,EAAE,OAAO;QACfoC,IAAI,EAAEF,QAAQ,GAAG,IAAI,GAAG;OACzB,CAAC,CACH,CACF;IACH;IACA,OAAOpD,KAAK,CAACuD,YAAY,CACvBpB,KAAK,EACLtC,MAAM,CAACsB,IAAI,CAAC,MAAK;MACfT,IAAI,CAAC8C,GAAG,CAAC,MAAM,EAAEd,MAAM,CAAC;MACxBhC,IAAI,CAAC8C,GAAG,CAAC,KAAK,EAAEV,KAAK,CAAC;MACtBpC,IAAI,CAAC8C,GAAG,CAAC,OAAO,EAAEN,OAAO,CAAC;MAC1BxC,IAAI,CAAC8C,GAAG,CAAC,OAAO,EAAEL,OAAO,CAAC;IAC5B,CAAC,CAAC,CACH;IACDzC,IAAI,CAACE,EAAE,CAAC,MAAM,EAAE8B,MAAM,CAAC;IACvBhC,IAAI,CAACE,EAAE,CAAC,KAAK,EAAEkC,KAAK,CAAC;IACrBpC,IAAI,CAACE,EAAE,CAAC,OAAO,EAAEsC,OAAO,CAAC;IACzBxC,IAAI,CAACE,EAAE,CAAC,OAAO,EAAEuC,OAAO,CAAC;IAEzBzB,aAAa,GAAGhB,IAAI;IACpB,OAAOiB,KAAK,CAACJ,IAAI;IAEjB,OAAO,OAAOzB,QAAQ,CAAC2D,IAAI,CAACrB,QAAQ,CAAC;EACvC,CAAC,CAAC,CAAC,CAACE,IAAI,CACNzC,MAAM,CAAC6D,eAAe,CAAEC,KAAyB,IAAKhE,OAAO,CAACiE,KAAK,CAAC/B,WAAW,EAAE8B,KAAK,CAAC,CAAC,EACxF9D,MAAM,CAACgE,QAAQ,CAAChE,MAAM,CAACsB,IAAI,CAAC,MAAK;IAC/BQ,KAAK,CAACmC,WAAW,EAAE;IACnBpC,aAAa,GAAGqC,SAAS;EAC3B,CAAC,CAAC,CAAC,EACHlE,MAAM,CAACmE,aAAa,CACrB;EAEH,MAAMC,KAAK,GAAItB,KAA8C,IAC3DhB,KAAK,CAACuC,QAAQ,CAACrE,MAAM,CAACW,KAAK,CAA4BC,MAAM,IAAI;IAC/D,MAAMC,IAAI,GAAGgB,aAAc;IAC3B,IAAIjC,MAAM,CAAC0E,YAAY,CAACxB,KAAK,CAAC,EAAE;MAC9BjC,IAAI,CAACU,OAAO,CAACuB,KAAK,CAACW,IAAI,GAAG,IAAI,GAAG,IAAIc,KAAK,CAAC,oBAAoBzB,KAAK,CAACW,IAAI,EAAE,CAAC,GAAGS,SAAS,CAAC;MACzF,OAAOtD,MAAM,CAACZ,MAAM,CAACoD,IAAI,CAAC;IAC5B;IACAvB,aAAc,CAACuC,KAAK,CAACtB,KAAK,EAAG5B,KAAK,IAAI;MACpCN,MAAM,CACJM,KAAK,GACDlB,MAAM,CAACmB,IAAI,CAAC,IAAIvB,MAAM,CAACwB,kBAAkB,CAAC;QAAEC,MAAM,EAAE,OAAO;QAAEH;MAAK,CAAE,CAAC,CAAC,GACtElB,MAAM,CAACoD,IAAI,CAChB;IACH,CAAC,CAAC;EACJ,CAAC,CAAC,CAAC;EAEL,MAAMoB,MAAM,GAAGxE,MAAM,CAACU,cAAc,CAClCV,MAAM,CAACiB,OAAO,CAACmD,KAAK,CAAC,EACrB,MACEpE,MAAM,CAACsB,IAAI,CAAC,MAAK;IACf,IAAI,CAACO,aAAa,IAAIA,aAAa,CAAC4C,aAAa,EAAE;IACnD5C,aAAa,CAAC6C,GAAG,EAAE;EACrB,CAAC,CAAC,CACL;EAED,OAAO1E,MAAM,CAACiB,OAAO,CAACrB,MAAM,CAACA,MAAM,CAAC+E,EAAE,CAAC;IACrC,CAAC/E,MAAM,CAACgF,MAAM,GAAGhF,MAAM,CAACgF,MAAM;IAC9B1C,GAAG;IACH2C,MAAM,EAAE3C,GAAG;IACXsC;GACD,CAAC,CAAC;AACL,CAAC,CAAC;AAEJ;;;;AAIA,OAAO,MAAMM,cAAc,GACzBtE,OAA2B,IAS3BX,OAAO,CAACkF,YAAY,CAClB/E,MAAM,CAACgF,GAAG,CAACzE,OAAO,CAACC,OAAO,CAAC,EAAEZ,MAAM,CAACqF,aAAa,EAAM,CAAC,CACzD;AAEH;;;;AAIA,OAAO,MAAMC,QAAQ,GAAI1E,OAA2B,IAClDN,KAAK,CAACiF,MAAM,CAACvF,MAAM,CAACA,MAAM,EAAEW,OAAO,CAACC,OAAO,CAAC,CAAC","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/NodeSocketServer.js b/dist/esm/NodeSocketServer.js
new file mode 100644
index 0000000000000000000000000000000000000000..ca4db24ffca9f89988476e9b36f1558d110ae138
--- /dev/null
+++ b/dist/esm/NodeSocketServer.js
@@ -0,0 +1,137 @@
+/**
+ * @since 1.0.0
+ */
+import * as Socket from "@effect/platform/Socket";
+import * as SocketServer from "@effect/platform/SocketServer";
+import * as Context from "effect/Context";
+import * as Effect from "effect/Effect";
+import * as Exit from "effect/Exit";
+import * as FiberRef from "effect/FiberRef";
+import * as FiberSet from "effect/FiberSet";
+import { pipe } from "effect/Function";
+import * as Layer from "effect/Layer";
+import * as Scope from "effect/Scope";
+import * as Net from "node:net";
+import * as WS from "ws";
+import * as NodeSocket from "./NodeSocket.js";
+/**
+ * @since 1.0.0
+ * @category tags
+ */
+export class IncomingMessage extends /*#__PURE__*/Context.Tag("@effect/platform-node-shared/NodeSocketServer/IncomingMessage")() {}
+/**
+ * @since 1.0.0
+ * @category constructors
+ */
+export const make = /*#__PURE__*/Effect.fnUntraced(function* (options) {
+  const server = yield* Effect.acquireRelease(Effect.sync(() => Net.createServer(options)), server => Effect.async(resume => {
+    server.close(() => resume(Effect.void));
+  }));
+  yield* Effect.async(resume => {
+    server.once("error", cause => {
+      resume(Effect.fail(new SocketServer.SocketServerError({
+        reason: "Open",
+        cause
+      })));
+    });
+    server.listen(options, () => {
+      resume(Effect.void);
+    });
+  });
+  const run = Effect.fnUntraced(function* (handler) {
+    const scope = yield* Scope.make();
+    const fiberSet = yield* FiberSet.make().pipe(Scope.extend(scope));
+    const run = yield* FiberSet.runtime(fiberSet)();
+    function onConnection(conn) {
+      pipe(NodeSocket.fromDuplex(Effect.acquireRelease(Effect.succeed(conn), conn => Effect.sync(() => {
+        if (conn.closed === false) {
+          conn.destroySoon();
+        }
+      }))), Effect.flatMap(handler), Effect.catchAllCause(reportUnhandledError), Effect.provideService(NodeSocket.NetSocket, conn), run);
+    }
+    return yield* Effect.async(_resume => {
+      server.on("connection", onConnection);
+      return Effect.sync(() => {
+        server.off("connection", onConnection);
+      });
+    }).pipe(Effect.ensuring(Scope.close(scope, Exit.void)));
+  });
+  const address = server.address();
+  return SocketServer.SocketServer.of({
+    address: typeof address === "string" ? {
+      _tag: "UnixAddress",
+      path: address
+    } : {
+      _tag: "TcpAddress",
+      hostname: address.address,
+      port: address.port
+    },
+    run
+  });
+});
+/**
+ * @since 1.0.0
+ * @category layers
+ */
+export const layer = options => Layer.scoped(SocketServer.SocketServer, make(options));
+/**
+ * @since 1.0.0
+ * @category constructors
+ */
+export const makeWebSocket = /*#__PURE__*/Effect.fnUntraced(function* (options) {
+  const server = yield* Effect.acquireRelease(Effect.sync(() => new WS.WebSocketServer(options)), server => Effect.async(resume => {
+    server.close(() => resume(Effect.void));
+  }));
+  yield* Effect.async(resume => {
+    server.once("error", error => {
+      resume(Effect.fail(new SocketServer.SocketServerError({
+        reason: "Open",
+        cause: error
+      })));
+    });
+    server.once("listening", () => {
+      resume(Effect.void);
+    });
+  });
+  const run = Effect.fnUntraced(function* (handler) {
+    const scope = yield* Scope.make();
+    const fiberSet = yield* FiberSet.make().pipe(Scope.extend(scope));
+    const run = yield* FiberSet.runtime(fiberSet)();
+    function onConnection(conn, req) {
+      pipe(Socket.fromWebSocket(Effect.acquireRelease(Effect.succeed(conn), conn => Effect.sync(() => {
+        conn.close();
+      }))), Effect.flatMap(handler), Effect.catchAllCause(reportUnhandledError), Effect.provideService(Socket.WebSocket, conn), Effect.provideService(IncomingMessage, req), run);
+    }
+    return yield* Effect.async(_resume => {
+      server.on("connection", onConnection);
+      return Effect.sync(() => {
+        server.off("connection", onConnection);
+      });
+    }).pipe(Effect.ensuring(Scope.close(scope, Exit.void)));
+  });
+  const address = server.address();
+  return SocketServer.SocketServer.of({
+    address: typeof address === "string" ? {
+      _tag: "UnixAddress",
+      path: address
+    } : {
+      _tag: "TcpAddress",
+      hostname: address.address,
+      port: address.port
+    },
+    run
+  });
+});
+/**
+ * @since 1.0.0
+ * @category layers
+ */
+export const layerWebSocket = options => Layer.scoped(SocketServer.SocketServer, makeWebSocket(options));
+const reportUnhandledError = cause => Effect.withFiberRuntime(fiber => {
+  const unhandledLogLevel = fiber.getFiberRef(FiberRef.unhandledErrorLogLevel);
+  if (unhandledLogLevel._tag === "Some") {
+    return Effect.logWithLevel(unhandledLogLevel.value, cause, "Unhandled error in SocketServer");
+  }
+  return Effect.void;
+});
+//# sourceMappingURL=NodeSocketServer.js.map
\ No newline at end of file
diff --git a/dist/esm/NodeSocketServer.js.map b/dist/esm/NodeSocketServer.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..3e0ff011bb9465c5dda785acd5a77a39995a842e
--- /dev/null
+++ b/dist/esm/NodeSocketServer.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"NodeSocketServer.js","names":["Socket","SocketServer","Context","Effect","Exit","FiberRef","FiberSet","pipe","Layer","Scope","Net","WS","NodeSocket","IncomingMessage","Tag","make","fnUntraced","options","server","acquireRelease","sync","createServer","async","resume","close","void","once","cause","fail","SocketServerError","reason","listen","run","handler","scope","fiberSet","extend","runtime","onConnection","conn","fromDuplex","succeed","closed","destroySoon","flatMap","catchAllCause","reportUnhandledError","provideService","NetSocket","_resume","on","off","ensuring","address","of","_tag","path","hostname","port","layer","scoped","makeWebSocket","WebSocketServer","error","req","fromWebSocket","WebSocket","layerWebSocket","withFiberRuntime","fiber","unhandledLogLevel","getFiberRef","unhandledErrorLogLevel","logWithLevel","value"],"sources":["../../src/NodeSocketServer.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/package.json b/package.json
index 591800cfccbec3603f3ee44a2883cd3485c2b9a1..0c33ccf95790e7eb20459e0637b47703f9860f91 100644
--- a/package.json
+++ b/package.json
@@ -11,10 +11,14 @@
   "sideEffects": [],
   "dependencies": {
     "@parcel/watcher": "^2.4.1",
-    "multipasta": "^0.2.5"
+    "multipasta": "^0.2.5",
+    "ws": "^8.18.0"
   },
   "peerDependencies": {
+    "@effect/cluster": "*",
     "@effect/platform": "^0.79.2",
+    "@effect/rpc": "*",
+    "@effect/sql": "*",
     "effect": "^3.13.11"
   },
   "publishConfig": {
@@ -22,6 +26,21 @@
   },
   "exports": {
     "./package.json": "./package.json",
+    "./NodeClusterRunnerSocket": {
+      "types": "./dist/dts/NodeClusterRunnerSocket.d.ts",
+      "import": "./dist/esm/NodeClusterRunnerSocket.js",
+      "default": "./dist/cjs/NodeClusterRunnerSocket.js"
+    },
+    "./NodeClusterShardManagerSocket": {
+      "types": "./dist/dts/NodeClusterShardManagerSocket.d.ts",
+      "import": "./dist/esm/NodeClusterShardManagerSocket.js",
+      "default": "./dist/cjs/NodeClusterShardManagerSocket.js"
+    },
+    "./NodeClusterSocketCommon": {
+      "types": "./dist/dts/NodeClusterSocketCommon.d.ts",
+      "import": "./dist/esm/NodeClusterSocketCommon.js",
+      "default": "./dist/cjs/NodeClusterSocketCommon.js"
+    },
     "./NodeCommandExecutor": {
       "types": "./dist/dts/NodeCommandExecutor.d.ts",
       "import": "./dist/esm/NodeCommandExecutor.js",
@@ -67,6 +86,11 @@
       "import": "./dist/esm/NodeSocket.js",
       "default": "./dist/cjs/NodeSocket.js"
     },
+    "./NodeSocketServer": {
+      "types": "./dist/dts/NodeSocketServer.d.ts",
+      "import": "./dist/esm/NodeSocketServer.js",
+      "default": "./dist/cjs/NodeSocketServer.js"
+    },
     "./NodeStream": {
       "types": "./dist/dts/NodeStream.d.ts",
       "import": "./dist/esm/NodeStream.js",
@@ -80,6 +104,15 @@
   },
   "typesVersions": {
     "*": {
+      "NodeClusterRunnerSocket": [
+        "./dist/dts/NodeClusterRunnerSocket.d.ts"
+      ],
+      "NodeClusterShardManagerSocket": [
+        "./dist/dts/NodeClusterShardManagerSocket.d.ts"
+      ],
+      "NodeClusterSocketCommon": [
+        "./dist/dts/NodeClusterSocketCommon.d.ts"
+      ],
       "NodeCommandExecutor": [
         "./dist/dts/NodeCommandExecutor.d.ts"
       ],
@@ -107,6 +140,9 @@
       "NodeSocket": [
         "./dist/dts/NodeSocket.d.ts"
       ],
+      "NodeSocketServer": [
+        "./dist/dts/NodeSocketServer.d.ts"
+      ],
       "NodeStream": [
         "./dist/dts/NodeStream.d.ts"
       ],
diff --git a/src/NodeClusterRunnerSocket.ts b/src/NodeClusterRunnerSocket.ts
new file mode 100644
index 0000000000000000000000000000000000000000..d9bfc5099dc997f9e212485be46d07a9c1850222
--- /dev/null
+++ b/src/NodeClusterRunnerSocket.ts
@@ -0,0 +1,78 @@
+/**
+ * @since 1.0.0
+ */
+import * as MessageStorage from "@effect/cluster/MessageStorage"
+import type * as Runners from "@effect/cluster/Runners"
+import type { Sharding } from "@effect/cluster/Sharding"
+import * as ShardingConfig from "@effect/cluster/ShardingConfig"
+import * as ShardStorage from "@effect/cluster/ShardStorage"
+import * as SocketRunner from "@effect/cluster/SocketRunner"
+import * as SqlMessageStorage from "@effect/cluster/SqlMessageStorage"
+import * as SqlShardStorage from "@effect/cluster/SqlShardStorage"
+import type * as SocketServer from "@effect/platform/SocketServer"
+import * as RpcSerialization from "@effect/rpc/RpcSerialization"
+import type { SqlClient } from "@effect/sql/SqlClient"
+import type { SqlError } from "@effect/sql/SqlError"
+import type { ConfigError } from "effect/ConfigError"
+import * as Effect from "effect/Effect"
+import * as Layer from "effect/Layer"
+import * as Option from "effect/Option"
+import { layerClientProtocol } from "./NodeClusterSocketCommon.js"
+import * as NodeSocketServer from "./NodeSocketServer.js"
+
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+export const layerSocketServer: Layer.Layer<
+  SocketServer.SocketServer,
+  SocketServer.SocketServerError,
+  ShardingConfig.ShardingConfig
+> = Effect.gen(function*() {
+  const config = yield* ShardingConfig.ShardingConfig
+  if (Option.isNone(config.runnerAddress)) {
+    return yield* Effect.dieMessage("layerSocketServer: ShardingConfig.runnerAddress is None")
+  }
+  return NodeSocketServer.layer(config.runnerAddress.value)
+}).pipe(Layer.unwrapEffect)
+
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+export const layer = <const ClientOnly extends boolean = false, const Storage extends "noop" | "sql" = "noop">(
+  options?: {
+    readonly serialization?: "msgpack" | "ndjson" | undefined
+    readonly clientOnly?: ClientOnly | undefined
+    readonly storage?: Storage | undefined
+    readonly shardingConfig?: Partial<ShardingConfig.ShardingConfig["Type"]> | undefined
+  }
+): ClientOnly extends true ? Layer.Layer<
+    Sharding | Runners.Runners,
+    ConfigError,
+    Storage extends "sql" ? SqlClient : never
+  > :
+  Layer.Layer<
+    Sharding | Runners.Runners,
+    SocketServer.SocketServerError | ConfigError | (Storage extends "sql" ? SqlError : never),
+    Storage extends "sql" ? SqlClient : never
+  > =>
+{
+  const layer: Layer.Layer<any, any, any> = options?.clientOnly
+    // client only
+    ? Layer.provide(SocketRunner.layerClientOnly, layerClientProtocol)
+    // with server
+    : Layer.provide(SocketRunner.layer, [layerSocketServer, layerClientProtocol])
+
+  return layer.pipe(
+    Layer.provide(
+      options?.storage === "sql"
+        ? options.clientOnly ? [SqlMessageStorage.layer] : [SqlMessageStorage.layer, SqlShardStorage.layer]
+        : [MessageStorage.layerNoop, ShardStorage.layerNoop]
+    ),
+    Layer.provide(ShardingConfig.layerFromEnv(options?.shardingConfig)),
+    Layer.provide(
+      options?.serialization === "ndjson" ? RpcSerialization.layerNdjson : RpcSerialization.layerMsgPack
+    )
+  ) as any
+}
diff --git a/src/NodeClusterShardManagerSocket.ts b/src/NodeClusterShardManagerSocket.ts
new file mode 100644
index 0000000000000000000000000000000000000000..da9225168b0756cd89b4c2fdfde7585abb72aa14
--- /dev/null
+++ b/src/NodeClusterShardManagerSocket.ts
@@ -0,0 +1,54 @@
+/**
+ * @since 1.0.0
+ */
+import * as RunnerHealth from "@effect/cluster/RunnerHealth"
+import * as ShardingConfig from "@effect/cluster/ShardingConfig"
+import * as ShardManager from "@effect/cluster/ShardManager"
+import * as ShardStorage from "@effect/cluster/ShardStorage"
+import * as SocketShardManager from "@effect/cluster/SocketShardManager"
+import * as SqlShardStorage from "@effect/cluster/SqlShardStorage"
+import type * as SocketServer from "@effect/platform/SocketServer"
+import * as RpcSerialization from "@effect/rpc/RpcSerialization"
+import type { SqlClient } from "@effect/sql/SqlClient"
+import type { SqlError } from "@effect/sql/SqlError"
+import type { ConfigError } from "effect/ConfigError"
+import * as Effect from "effect/Effect"
+import * as Layer from "effect/Layer"
+import { layerClientProtocol } from "./NodeClusterSocketCommon.js"
+import * as NodeSocketServer from "./NodeSocketServer.js"
+
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+export const layerSocketServer: Layer.Layer<
+  SocketServer.SocketServer,
+  SocketServer.SocketServerError,
+  ShardingConfig.ShardingConfig
+> = Effect.gen(function*() {
+  const config = yield* ShardingConfig.ShardingConfig
+  return NodeSocketServer.layer(config.shardManagerAddress)
+}).pipe(Layer.unwrapEffect)
+
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+export const layer = <const Storage extends "sql" | "noop" = "noop">(options?: {
+  readonly serialization?: "msgpack" | "ndjson" | undefined
+  readonly shardingConfig?: Partial<ShardingConfig.ShardingConfig["Type"]> | undefined
+  readonly storage?: Storage | undefined
+}): Layer.Layer<
+  ShardManager.ShardManager,
+  SocketServer.SocketServerError | ConfigError | (Storage extends "sql" ? SqlError : never),
+  Storage extends "sql" ? SqlClient : never
+> =>
+  SocketShardManager.layer.pipe(
+    Layer.provide([RunnerHealth.layerRpc, layerSocketServer, ShardManager.layerConfigFromEnv]),
+    Layer.provide(layerClientProtocol),
+    Layer.provide(options?.storage === "sql" ? SqlShardStorage.layer : ShardStorage.layerNoop),
+    Layer.provide([
+      options?.serialization === "ndjson" ? RpcSerialization.layerNdjson : RpcSerialization.layerMsgPack,
+      ShardingConfig.layerFromEnv(options?.shardingConfig)
+    ])
+  ) as any
diff --git a/src/NodeClusterSocketCommon.ts b/src/NodeClusterSocketCommon.ts
new file mode 100644
index 0000000000000000000000000000000000000000..a998b9a87a2d0838970ca74446c79b90cd025669
--- /dev/null
+++ b/src/NodeClusterSocketCommon.ts
@@ -0,0 +1,35 @@
+/**
+ * @since 1.0.0
+ */
+import * as Runners from "@effect/cluster/Runners"
+import { Socket } from "@effect/platform/Socket"
+import * as RpcClient from "@effect/rpc/RpcClient"
+import * as RpcSerialization from "@effect/rpc/RpcSerialization"
+import * as Effect from "effect/Effect"
+import * as Layer from "effect/Layer"
+import * as NodeSocket from "./NodeSocket.js"
+
+/**
+ * @since 1.0.0
+ * @category Layers
+ */
+export const layerClientProtocol: Layer.Layer<
+  Runners.RpcClientProtocol,
+  never,
+  RpcSerialization.RpcSerialization
+> = Layer.effect(
+  Runners.RpcClientProtocol,
+  Effect.gen(function*() {
+    const serialization = yield* RpcSerialization.RpcSerialization
+    return Effect.fnUntraced(function*(address) {
+      const socket = yield* NodeSocket.makeNet({
+        host: address.host,
+        port: address.port
+      })
+      return yield* RpcClient.makeProtocolSocket.pipe(
+        Effect.provideService(Socket, socket),
+        Effect.provideService(RpcSerialization.RpcSerialization, serialization)
+      )
+    }, Effect.orDie)
+  })
+)
diff --git a/src/NodeSocket.ts b/src/NodeSocket.ts
index c7abf23a1503c691695321814388493bfc0f18ec..7aa90abdd191cc7d622afd92f91c5bc2dab96365 100644
--- a/src/NodeSocket.ts
+++ b/src/NodeSocket.ts
@@ -45,6 +45,7 @@ export const makeNet = (
           resume(Effect.succeed(conn))
         })
         conn.on("error", (cause) => {
+          conn.removeAllListeners()
           resume(Effect.fail(new Socket.SocketGenericError({ reason: "Open", cause })))
         })
         return Effect.sync(() => {
@@ -77,60 +78,58 @@ export const fromDuplex = <RO>(
     const latch = Effect.unsafeMakeLatch(false)
     const openContext = fiber.currentContext as Context.Context<RO>
     const run = <R, E, _>(handler: (_: Uint8Array) => Effect.Effect<_, E, R> | void) =>
-      Effect.scopedWith((scope) =>
-        Effect.gen(function*() {
-          const fiberSet = yield* FiberSet.make<any, E | Socket.SocketError>().pipe(
-            Scope.extend(scope)
-          )
-          const conn = yield* Scope.extend(open, scope)
-          const run = yield* Effect.provideService(FiberSet.runtime(fiberSet)<R>(), NetSocket, conn as Net.Socket)
+      Effect.scopedWith(Effect.fnUntraced(function*(scope) {
+        const fiberSet = yield* FiberSet.make<any, E | Socket.SocketError>().pipe(
+          Scope.extend(scope)
+        )
+        const conn = yield* Scope.extend(open, scope)
+        const run = yield* Effect.provideService(FiberSet.runtime(fiberSet)<R>(), NetSocket, conn as Net.Socket)
 
-          function onData(chunk: Uint8Array) {
-            const result = handler(chunk)
-            if (Effect.isEffect(result)) {
-              run(result)
-            }
-          }
-          function onEnd() {
-            Deferred.unsafeDone(fiberSet.deferred, Effect.void)
+        function onData(chunk: Uint8Array) {
+          const result = handler(chunk)
+          if (Effect.isEffect(result)) {
+            run(result)
           }
-          function onError(cause: Error) {
-            Deferred.unsafeDone(
-              fiberSet.deferred,
-              Effect.fail(new Socket.SocketGenericError({ reason: "Read", cause }))
-            )
-          }
-          function onClose(hadError: boolean) {
-            Deferred.unsafeDone(
-              fiberSet.deferred,
-              Effect.fail(
-                new Socket.SocketCloseError({
-                  reason: "Close",
-                  code: hadError ? 1006 : 1000
-                })
-              )
+        }
+        function onEnd() {
+          Deferred.unsafeDone(fiberSet.deferred, Effect.void)
+        }
+        function onError(cause: Error) {
+          Deferred.unsafeDone(
+            fiberSet.deferred,
+            Effect.fail(new Socket.SocketGenericError({ reason: "Read", cause }))
+          )
+        }
+        function onClose(hadError: boolean) {
+          Deferred.unsafeDone(
+            fiberSet.deferred,
+            Effect.fail(
+              new Socket.SocketCloseError({
+                reason: "Close",
+                code: hadError ? 1006 : 1000
+              })
             )
-          }
-          yield* Scope.addFinalizer(
-            scope,
-            Effect.sync(() => {
-              conn.off("data", onData)
-              conn.off("end", onEnd)
-              conn.off("error", onError)
-              conn.off("close", onClose)
-            })
           )
-          conn.on("data", onData)
-          conn.on("end", onEnd)
-          conn.on("error", onError)
-          conn.on("close", onClose)
+        }
+        yield* Scope.addFinalizer(
+          scope,
+          Effect.sync(() => {
+            conn.off("data", onData)
+            conn.off("end", onEnd)
+            conn.off("error", onError)
+            conn.off("close", onClose)
+          })
+        )
+        conn.on("data", onData)
+        conn.on("end", onEnd)
+        conn.on("error", onError)
+        conn.on("close", onClose)
 
-          currentSocket = conn
-          yield* latch.open
+        currentSocket = conn
+        yield* latch.open
 
-          return yield* FiberSet.join(fiberSet)
-        })
-      ).pipe(
+        return yield* FiberSet.join(fiberSet)
+      })).pipe(
         Effect.mapInputContext((input: Context.Context<R>) => Context.merge(openContext, input)),
         Effect.ensuring(Effect.sync(() => {
           latch.unsafeClose()
diff --git a/src/NodeSocketServer.ts b/src/NodeSocketServer.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9136b429d4487fbd5760d0f40abe9216a6f60d85
--- /dev/null
+++ b/src/NodeSocketServer.ts
@@ -0,0 +1,225 @@
+/**
+ * @since 1.0.0
+ */
+import * as Socket from "@effect/platform/Socket"
+import * as SocketServer from "@effect/platform/SocketServer"
+import type { Cause } from "effect/Cause"
+import * as Context from "effect/Context"
+import * as Effect from "effect/Effect"
+import * as Exit from "effect/Exit"
+import * as FiberRef from "effect/FiberRef"
+import * as FiberSet from "effect/FiberSet"
+import { pipe } from "effect/Function"
+import * as Layer from "effect/Layer"
+import * as Scope from "effect/Scope"
+import type * as Http from "node:http"
+import * as Net from "node:net"
+import * as WS from "ws"
+import * as NodeSocket from "./NodeSocket.js"
+
+/**
+ * @since 1.0.0
+ * @category tags
+ */
+export class IncomingMessage extends Context.Tag("@effect/platform-node-shared/NodeSocketServer/IncomingMessage")<
+  IncomingMessage,
+  Http.IncomingMessage
+>() {}
+
+/**
+ * @since 1.0.0
+ * @category constructors
+ */
+export const make = Effect.fnUntraced(function*(
+  options: Net.ServerOpts & Net.ListenOptions
+) {
+  const server = yield* Effect.acquireRelease(
+    Effect.sync(() => Net.createServer(options)),
+    (server) =>
+      Effect.async<void>((resume) => {
+        server.close(() => resume(Effect.void))
+      })
+  )
+
+  yield* Effect.async<void, SocketServer.SocketServerError>((resume) => {
+    server.once("error", (cause) => {
+      resume(Effect.fail(
+        new SocketServer.SocketServerError({
+          reason: "Open",
+          cause
+        })
+      ))
+    })
+    server.listen(options, () => {
+      resume(Effect.void)
+    })
+  })
+
+  const run = Effect.fnUntraced(function*<R, E, _>(handler: (socket: Socket.Socket) => Effect.Effect<_, E, R>) {
+    const scope = yield* Scope.make()
+    const fiberSet = yield* FiberSet.make().pipe(
+      Scope.extend(scope)
+    )
+    const run = yield* FiberSet.runtime(fiberSet)<R>()
+    function onConnection(conn: Net.Socket) {
+      pipe(
+        NodeSocket.fromDuplex(
+          Effect.acquireRelease(
+            Effect.succeed(conn),
+            (conn) =>
+              Effect.sync(() => {
+                if (conn.closed === false) {
+                  conn.destroySoon()
+                }
+              })
+          )
+        ),
+        Effect.flatMap(handler),
+        Effect.catchAllCause(reportUnhandledError),
+        Effect.provideService(NodeSocket.NetSocket, conn),
+        run
+      )
+    }
+    return yield* Effect.async<never>((_resume) => {
+      server.on("connection", onConnection)
+      return Effect.sync(() => {
+        server.off("connection", onConnection)
+      })
+    }).pipe(
+      Effect.ensuring(Scope.close(scope, Exit.void))
+    )
+  })
+
+  const address = server.address()!
+  return SocketServer.SocketServer.of({
+    address: typeof address === "string" ?
+      {
+        _tag: "UnixAddress",
+        path: address
+      } :
+      {
+        _tag: "TcpAddress",
+        hostname: address.address,
+        port: address.port
+      },
+    run
+  })
+})
+
+/**
+ * @since 1.0.0
+ * @category layers
+ */
+export const layer = (
+  options: Net.ServerOpts & Net.ListenOptions
+): Layer.Layer<SocketServer.SocketServer, SocketServer.SocketServerError> =>
+  Layer.scoped(
+    SocketServer.SocketServer,
+    make(options)
+  )
+
+/**
+ * @since 1.0.0
+ * @category constructors
+ */
+export const makeWebSocket: (
+  options: WS.ServerOptions<typeof WS.WebSocket, typeof Http.IncomingMessage>
+) => Effect.Effect<
+  SocketServer.SocketServer["Type"],
+  SocketServer.SocketServerError,
+  Scope.Scope
+> = Effect.fnUntraced(function*(
+  options: WS.ServerOptions
+) {
+  const server = yield* Effect.acquireRelease(
+    Effect.sync(() => new WS.WebSocketServer(options)),
+    (server) =>
+      Effect.async<void>((resume) => {
+        server.close(() => resume(Effect.void))
+      })
+  )
+
+  yield* Effect.async<void, SocketServer.SocketServerError>((resume) => {
+    server.once("error", (error) => {
+      resume(Effect.fail(
+        new SocketServer.SocketServerError({
+          reason: "Open",
+          cause: error
+        })
+      ))
+    })
+    server.once("listening", () => {
+      resume(Effect.void)
+    })
+  })
+
+  const run = Effect.fnUntraced(function*<R, E, _>(handler: (socket: Socket.Socket) => Effect.Effect<_, E, R>) {
+    const scope = yield* Scope.make()
+    const fiberSet = yield* FiberSet.make().pipe(
+      Scope.extend(scope)
+    )
+    const run = yield* FiberSet.runtime(fiberSet)<R>()
+    function onConnection(conn: Net.Socket, req: Http.IncomingMessage) {
+      pipe(
+        Socket.fromWebSocket(
+          Effect.acquireRelease(
+            Effect.succeed(conn as unknown as globalThis.WebSocket),
+            (conn) =>
+              Effect.sync(() => {
+                conn.close()
+              })
+          )
+        ),
+        Effect.flatMap(handler),
+        Effect.catchAllCause(reportUnhandledError),
+        Effect.provideService(Socket.WebSocket, conn as any),
+        Effect.provideService(IncomingMessage, req),
+        run
+      )
+    }
+    return yield* Effect.async<never>((_resume) => {
+      server.on("connection", onConnection)
+      return Effect.sync(() => {
+        server.off("connection", onConnection)
+      })
+    }).pipe(
+      Effect.ensuring(Scope.close(scope, Exit.void))
+    )
+  })
+
+  const address = server.address()!
+  return SocketServer.SocketServer.of({
+    address: typeof address === "string" ?
+      {
+        _tag: "UnixAddress",
+        path: address
+      } :
+      {
+        _tag: "TcpAddress",
+        hostname: address.address,
+        port: address.port
+      },
+    run
+  })
+})
+
+/**
+ * @since 1.0.0
+ * @category layers
+ */
+export const layerWebSocket = (
+  options: WS.ServerOptions
+): Layer.Layer<SocketServer.SocketServer, SocketServer.SocketServerError> =>
+  Layer.scoped(
+    SocketServer.SocketServer,
+    makeWebSocket(options)
+  )
+
+const reportUnhandledError = <E>(cause: Cause<E>) =>
+  Effect.withFiberRuntime<void>((fiber) => {
+    const unhandledLogLevel = fiber.getFiberRef(FiberRef.unhandledErrorLogLevel)
+    if (unhandledLogLevel._tag === "Some") {
+      return Effect.logWithLevel(unhandledLogLevel.value, cause, "Unhandled error in SocketServer")
+    }
+    return Effect.void
+  })
