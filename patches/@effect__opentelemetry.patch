diff --git a/dist/cjs/internal/tracer.js b/dist/cjs/internal/tracer.js
index 86afd35f21356d8fe8f32151a384c1186a5c0023..e0d87dd1f95a9620d5c84b505dfe135685716f2a 100644
--- a/dist/cjs/internal/tracer.js
+++ b/dist/cjs/internal/tracer.js
@@ -24,10 +24,19 @@ const kindMap = {
   "producer": OtelApi.SpanKind.PRODUCER,
   "consumer": OtelApi.SpanKind.CONSUMER
 };
+const getOtelParent = (tracer, otelContext, context) => {
+  const active = tracer.getSpan(otelContext);
+  const otelParent = active ? active.spanContext() : undefined;
+  return otelParent ? Option.some(EffectTracer.externalSpan({
+    spanId: otelParent.spanId,
+    traceId: otelParent.traceId,
+    sampled: (otelParent.traceFlags & 1) === 1,
+    context
+  })) : Option.none();
+};
 /** @internal */
 class OtelSpan {
   name;
-  parent;
   context;
   links;
   kind;
@@ -38,15 +47,16 @@ class OtelSpan {
   traceId;
   attributes = /*#__PURE__*/new Map();
   sampled;
+  parent;
   status;
-  constructor(contextApi, tracer, name, parent, context, links, startTime, kind) {
+  constructor(contextApi, traceApi, tracer, name, effectParent, context, links, startTime, kind, options) {
     this.name = name;
-    this.parent = parent;
     this.context = context;
     this.links = links;
     this.kind = kind;
     this[OtelSpanTypeId] = OtelSpanTypeId;
     const active = contextApi.active();
+    this.parent = effectParent._tag === "Some" ? effectParent : options?.root !== true ? getOtelParent(traceApi, active, context) : Option.none();
     this.span = tracer.startSpan(name, {
       startTime: (0, _utils.nanosToHrTime)(startTime),
       links: links.length > 0 ? links.map(link => ({
@@ -54,7 +64,7 @@ class OtelSpan {
         attributes: (0, _utils.recordToAttributes)(link.attributes)
       })) : undefined,
       kind: kindMap[this.kind]
-    }, parent._tag === "Some" ? populateContext(active, parent.value, context) : OtelApi.trace.deleteSpan(active));
+    }, this.parent._tag === "Some" ? populateContext(active, this.parent.value, context) : OtelApi.trace.deleteSpan(active));
     const spanContext = this.span.spanContext();
     this.spanId = spanContext.spanId;
     this.traceId = spanContext.traceId;
@@ -128,8 +138,8 @@ const TracerProvider = exports.TracerProvider = /*#__PURE__*/Context.GenericTag(
 const Tracer = exports.Tracer = /*#__PURE__*/Context.GenericTag("@effect/opentelemetry/Tracer/OtelTracer");
 /** @internal */
 const make = exports.make = /*#__PURE__*/Effect.map(Tracer, tracer => EffectTracer.make({
-  span(name, parent, context, links, startTime, kind) {
-    return new OtelSpan(OtelApi.context, tracer, name, parent, context, links.slice(), startTime, kind);
+  span(name, parent, context, links, startTime, kind, options) {
+    return new OtelSpan(OtelApi.context, OtelApi.trace, tracer, name, parent, context, links.slice(), startTime, kind, options);
   },
   context(execution, fiber) {
     const currentSpan = fiber.currentSpan;
diff --git a/dist/cjs/internal/tracer.js.map b/dist/cjs/internal/tracer.js.map
index ae9a2d572d2e2c38bfeee8ff5a8560de255583bb..7e642db6f849ceba48e7cc41fe08f72854b6bece 100644
--- a/dist/cjs/internal/tracer.js.map
+++ b/dist/cjs/internal/tracer.js.map
@@ -1 +1 @@
-{"version":3,"file":"tracer.js","names":["OtelApi","_interopRequireWildcard","require","OtelSemConv","Cause","Context","Effect","_Function","Layer","Option","EffectTracer","_Resource","_utils","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","OtelSpanTypeId","Symbol","for","kindMap","SpanKind","INTERNAL","CLIENT","SERVER","PRODUCER","CONSUMER","OtelSpan","name","parent","context","links","kind","_tag","span","spanId","traceId","attributes","Map","sampled","status","constructor","contextApi","tracer","startTime","active","startSpan","nanosToHrTime","length","map","link","makeSpanContext","recordToAttributes","undefined","populateContext","value","trace","deleteSpan","spanContext","traceFlags","TraceFlags","SAMPLED","attribute","key","setAttribute","unknownToAttributeValue","addLinks","push","end","endTime","exit","hrTime","setStatus","code","SpanStatusCode","OK","isInterruptedOnly","cause","message","pretty","firstError","prettyErrors","stack","renderErrorCause","recordException","ERROR","event","addEvent","exports","TracerProvider","GenericTag","Tracer","make","slice","execution","fiber","currentSpan","with","traceFlagsTag","traceStateTag","makeExternalSpan","options","empty","add","traceState","match","createTraceState","onNone","onSome","currentOtelSpan","flatMap","succeed","fail","NoSuchElementException","layerGlobalProvider","sync","getTracerProvider","layerTracer","effect","zip","Resource","resource","provider","getTracer","ATTR_SERVICE_NAME","ATTR_SERVICE_VERSION","layerGlobalTracer","pipe","provide","layerGlobal","unwrapEffect","setTracer","provideMerge","layerWithoutOtelTracer","layer","liftThrowable","otelContext","setSpan","setSpanContext","isRemote","getOrElse","extractTraceTag","getOption","getOrUndefined","tag","orElse","withSpanContext","dual","withParentSpan"],"sources":["../../../src/internal/tracer.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
+{"version":3,"file":"tracer.js","names":["OtelApi","_interopRequireWildcard","require","OtelSemConv","Cause","Context","Effect","_Function","Layer","Option","EffectTracer","_Resource","_utils","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","OtelSpanTypeId","Symbol","for","kindMap","SpanKind","INTERNAL","CLIENT","SERVER","PRODUCER","CONSUMER","getOtelParent","tracer","otelContext","context","active","getSpan","otelParent","spanContext","undefined","some","externalSpan","spanId","traceId","sampled","traceFlags","none","OtelSpan","name","links","kind","_tag","span","attributes","Map","parent","status","constructor","contextApi","traceApi","effectParent","startTime","options","root","startSpan","nanosToHrTime","length","map","link","makeSpanContext","recordToAttributes","populateContext","value","trace","deleteSpan","TraceFlags","SAMPLED","attribute","key","setAttribute","unknownToAttributeValue","addLinks","push","end","endTime","exit","hrTime","setStatus","code","SpanStatusCode","OK","isInterruptedOnly","cause","message","pretty","firstError","prettyErrors","stack","renderErrorCause","recordException","ERROR","event","addEvent","exports","TracerProvider","GenericTag","Tracer","make","slice","execution","fiber","currentSpan","with","traceFlagsTag","traceStateTag","makeExternalSpan","empty","add","traceState","match","createTraceState","onNone","onSome","currentOtelSpan","flatMap","succeed","fail","NoSuchElementException","layerGlobalProvider","sync","getTracerProvider","layerTracer","effect","zip","Resource","resource","provider","getTracer","ATTR_SERVICE_NAME","ATTR_SERVICE_VERSION","layerGlobalTracer","pipe","provide","layerGlobal","unwrapEffect","setTracer","provideMerge","layerWithoutOtelTracer","layer","liftThrowable","setSpan","setSpanContext","isRemote","getOrElse","extractTraceTag","getOption","getOrUndefined","tag","orElse","withSpanContext","dual","withParentSpan"],"sources":["../../../src/internal/tracer.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/internal/tracer.js b/dist/esm/internal/tracer.js
index fb0a41941cd01089e5fa5f93db1f440e12fe4e89..889b52301b5aa9da9dc50f248fe2e3d2d77f8286 100644
--- a/dist/esm/internal/tracer.js
+++ b/dist/esm/internal/tracer.js
@@ -17,10 +17,19 @@ const kindMap = {
   "producer": OtelApi.SpanKind.PRODUCER,
   "consumer": OtelApi.SpanKind.CONSUMER
 };
+const getOtelParent = (tracer, otelContext, context) => {
+  const active = tracer.getSpan(otelContext);
+  const otelParent = active ? active.spanContext() : undefined;
+  return otelParent ? Option.some(EffectTracer.externalSpan({
+    spanId: otelParent.spanId,
+    traceId: otelParent.traceId,
+    sampled: (otelParent.traceFlags & 1) === 1,
+    context
+  })) : Option.none();
+};
 /** @internal */
 export class OtelSpan {
   name;
-  parent;
   context;
   links;
   kind;
@@ -31,15 +40,16 @@ export class OtelSpan {
   traceId;
   attributes = /*#__PURE__*/new Map();
   sampled;
+  parent;
   status;
-  constructor(contextApi, tracer, name, parent, context, links, startTime, kind) {
+  constructor(contextApi, traceApi, tracer, name, effectParent, context, links, startTime, kind, options) {
     this.name = name;
-    this.parent = parent;
     this.context = context;
     this.links = links;
     this.kind = kind;
     this[OtelSpanTypeId] = OtelSpanTypeId;
     const active = contextApi.active();
+    this.parent = effectParent._tag === "Some" ? effectParent : options?.root !== true ? getOtelParent(traceApi, active, context) : Option.none();
     this.span = tracer.startSpan(name, {
       startTime: nanosToHrTime(startTime),
       links: links.length > 0 ? links.map(link => ({
@@ -47,7 +57,7 @@ export class OtelSpan {
         attributes: recordToAttributes(link.attributes)
       })) : undefined,
       kind: kindMap[this.kind]
-    }, parent._tag === "Some" ? populateContext(active, parent.value, context) : OtelApi.trace.deleteSpan(active));
+    }, this.parent._tag === "Some" ? populateContext(active, this.parent.value, context) : OtelApi.trace.deleteSpan(active));
     const spanContext = this.span.spanContext();
     this.spanId = spanContext.spanId;
     this.traceId = spanContext.traceId;
@@ -120,8 +130,8 @@ export const TracerProvider = /*#__PURE__*/Context.GenericTag("@effect/opentelem
 export const Tracer = /*#__PURE__*/Context.GenericTag("@effect/opentelemetry/Tracer/OtelTracer");
 /** @internal */
 export const make = /*#__PURE__*/Effect.map(Tracer, tracer => EffectTracer.make({
-  span(name, parent, context, links, startTime, kind) {
-    return new OtelSpan(OtelApi.context, tracer, name, parent, context, links.slice(), startTime, kind);
+  span(name, parent, context, links, startTime, kind, options) {
+    return new OtelSpan(OtelApi.context, OtelApi.trace, tracer, name, parent, context, links.slice(), startTime, kind, options);
   },
   context(execution, fiber) {
     const currentSpan = fiber.currentSpan;
diff --git a/dist/esm/internal/tracer.js.map b/dist/esm/internal/tracer.js.map
index d1c956067e759827dff509cbe478ac5d3f482d48..4c7f9d2618781382260675a411bc5f59df4a16e2 100644
--- a/dist/esm/internal/tracer.js.map
+++ b/dist/esm/internal/tracer.js.map
@@ -1 +1 @@
-{"version":3,"file":"tracer.js","names":["OtelApi","OtelSemConv","Cause","Context","Effect","dual","Layer","Option","EffectTracer","Resource","nanosToHrTime","recordToAttributes","unknownToAttributeValue","OtelSpanTypeId","Symbol","for","kindMap","SpanKind","INTERNAL","CLIENT","SERVER","PRODUCER","CONSUMER","OtelSpan","name","parent","context","links","kind","_tag","span","spanId","traceId","attributes","Map","sampled","status","constructor","contextApi","tracer","startTime","active","startSpan","length","map","link","makeSpanContext","undefined","populateContext","value","trace","deleteSpan","spanContext","traceFlags","TraceFlags","SAMPLED","attribute","key","setAttribute","set","addLinks","push","end","endTime","exit","hrTime","setStatus","code","SpanStatusCode","OK","isInterruptedOnly","cause","message","pretty","firstError","prettyErrors","stack","renderErrorCause","recordException","ERROR","event","addEvent","TracerProvider","GenericTag","Tracer","make","slice","execution","fiber","currentSpan","with","traceFlagsTag","traceStateTag","makeExternalSpan","options","empty","add","traceState","match","createTraceState","onNone","onSome","currentOtelSpan","flatMap","succeed","fail","NoSuchElementException","layerGlobalProvider","sync","getTracerProvider","layerTracer","effect","zip","resource","provider","getTracer","ATTR_SERVICE_NAME","ATTR_SERVICE_VERSION","layerGlobalTracer","pipe","provide","layerGlobal","unwrapEffect","setTracer","provideMerge","layerWithoutOtelTracer","layer","liftThrowable","otelContext","setSpan","setSpanContext","isRemote","getOrElse","extractTraceTag","getOption","getOrUndefined","tag","orElse","withSpanContext","withParentSpan"],"sources":["../../../src/internal/tracer.ts"],"sourcesContent":[null],"mappings":"AAAA,OAAO,KAAKA,OAAO,MAAM,oBAAoB;AAC7C,OAAO,KAAKC,WAAW,MAAM,qCAAqC;AAClE,OAAO,KAAKC,KAAK,MAAM,cAAc;AACrC,OAAO,KAAKC,OAAO,MAAM,gBAAgB;AACzC,OAAO,KAAKC,MAAM,MAAM,eAAe;AAEvC,SAASC,IAAI,QAAQ,iBAAiB;AACtC,OAAO,KAAKC,KAAK,MAAM,cAAc;AACrC,OAAO,KAAKC,MAAM,MAAM,eAAe;AACvC,OAAO,KAAKC,YAAY,MAAM,eAAe;AAC7C,SAASC,QAAQ,QAAQ,gBAAgB;AAEzC,SAASC,aAAa,EAAEC,kBAAkB,EAAEC,uBAAuB,QAAQ,YAAY;AAEvF,MAAMC,cAAc,gBAAGC,MAAM,CAACC,GAAG,CAAC,uCAAuC,CAAC;AAE1E,MAAMC,OAAO,GAAG;EACd,UAAU,EAAEhB,OAAO,CAACiB,QAAQ,CAACC,QAAQ;EACrC,QAAQ,EAAElB,OAAO,CAACiB,QAAQ,CAACE,MAAM;EACjC,QAAQ,EAAEnB,OAAO,CAACiB,QAAQ,CAACG,MAAM;EACjC,UAAU,EAAEpB,OAAO,CAACiB,QAAQ,CAACI,QAAQ;EACrC,UAAU,EAAErB,OAAO,CAACiB,QAAQ,CAACK;CAC9B;AAED;AACA,OAAM,MAAOC,QAAQ;EAcRC,IAAA;EACAC,MAAA;EACAC,OAAA;EACAC,KAAA;EAEAC,IAAA;EAlBF,CAACf,cAAc;EACfgB,IAAI,GAAG,MAAM;EAEbC,IAAI;EACJC,MAAM;EACNC,OAAO;EACPC,UAAU,gBAAG,IAAIC,GAAG,EAAmB;EACvCC,OAAO;EAChBC,MAAM;EAENC,YACEC,UAA8B,EAC9BC,MAAsB,EACbf,IAAY,EACZC,MAA2C,EAC3CC,OAA+B,EAC/BC,KAAmC,EAC5Ca,SAAiB,EACRZ,IAA2B;IAL3B,KAAAJ,IAAI,GAAJA,IAAI;IACJ,KAAAC,MAAM,GAANA,MAAM;IACN,KAAAC,OAAO,GAAPA,OAAO;IACP,KAAAC,KAAK,GAALA,KAAK;IAEL,KAAAC,IAAI,GAAJA,IAAI;IAEb,IAAI,CAACf,cAAc,CAAC,GAAGA,cAAc;IACrC,MAAM4B,MAAM,GAAGH,UAAU,CAACG,MAAM,EAAE;IAClC,IAAI,CAACX,IAAI,GAAGS,MAAM,CAACG,SAAS,CAC1BlB,IAAI,EACJ;MACEgB,SAAS,EAAE9B,aAAa,CAAC8B,SAAS,CAAC;MACnCb,KAAK,EAAEA,KAAK,CAACgB,MAAM,GAAG,CAAC,GACnBhB,KAAK,CAACiB,GAAG,CAAEC,IAAI,KAAM;QACrBnB,OAAO,EAAEoB,eAAe,CAACD,IAAI,CAACf,IAAI,CAAC;QACnCG,UAAU,EAAEtB,kBAAkB,CAACkC,IAAI,CAACZ,UAAU;OAC/C,CAAC,CAAC,GACDc,SAAgB;MACpBnB,IAAI,EAAEZ,OAAO,CAAC,IAAI,CAACY,IAAI;KACxB,EACDH,MAAM,CAACI,IAAI,KAAK,MAAM,GAClBmB,eAAe,CAACP,MAAM,EAAEhB,MAAM,CAACwB,KAAK,EAAEvB,OAAO,CAAC,GAC9C1B,OAAO,CAACkD,KAAK,CAACC,UAAU,CAACV,MAAM,CAAC,CACrC;IACD,MAAMW,WAAW,GAAG,IAAI,CAACtB,IAAI,CAACsB,WAAW,EAAE;IAC3C,IAAI,CAACrB,MAAM,GAAGqB,WAAW,CAACrB,MAAM;IAChC,IAAI,CAACC,OAAO,GAAGoB,WAAW,CAACpB,OAAO;IAClC,IAAI,CAACI,MAAM,GAAG;MACZP,IAAI,EAAE,SAAS;MACfW;KACD;IACD,IAAI,CAACL,OAAO,GAAG,CAACiB,WAAW,CAACC,UAAU,GAAGrD,OAAO,CAACsD,UAAU,CAACC,OAAO,MAAMvD,OAAO,CAACsD,UAAU,CAACC,OAAO;EACrG;EAEAC,SAASA,CAACC,GAAW,EAAER,KAAc;IACnC,IAAI,CAACnB,IAAI,CAAC4B,YAAY,CAACD,GAAG,EAAE7C,uBAAuB,CAACqC,KAAK,CAAC,CAAC;IAC3D,IAAI,CAAChB,UAAU,CAAC0B,GAAG,CAACF,GAAG,EAAER,KAAK,CAAC;EACjC;EAEAW,QAAQA,CAACjC,KAA2C;IAClD;IACA,IAAI,CAACA,KAAK,CAACkC,IAAI,CAAC,GAAGlC,KAAK,CAAC;IACzB,IAAI,CAACG,IAAI,CAAC8B,QAAQ,CAACjC,KAAK,CAACiB,GAAG,CAAEC,IAAI,KAAM;MACtCnB,OAAO,EAAEoB,eAAe,CAACD,IAAI,CAACf,IAAI,CAAC;MACnCG,UAAU,EAAEtB,kBAAkB,CAACkC,IAAI,CAACZ,UAAU;KAC/C,CAAC,CAAC,CAAC;EACN;EAEA6B,GAAGA,CAACC,OAAe,EAAEC,IAA4B;IAC/C,MAAMC,MAAM,GAAGvD,aAAa,CAACqD,OAAO,CAAC;IACrC,IAAI,CAAC3B,MAAM,GAAG;MACZP,IAAI,EAAE,OAAO;MACbkC,OAAO;MACPC,IAAI;MACJxB,SAAS,EAAE,IAAI,CAACJ,MAAM,CAACI;KACxB;IAED,IAAIwB,IAAI,CAACnC,IAAI,KAAK,SAAS,EAAE;MAC3B,IAAI,CAACC,IAAI,CAACoC,SAAS,CAAC;QAAEC,IAAI,EAAEnE,OAAO,CAACoE,cAAc,CAACC;MAAE,CAAE,CAAC;IAC1D,CAAC,MAAM;MACL,IAAInE,KAAK,CAACoE,iBAAiB,CAACN,IAAI,CAACO,KAAK,CAAC,EAAE;QACvC,IAAI,CAACzC,IAAI,CAACoC,SAAS,CAAC;UAClBC,IAAI,EAAEnE,OAAO,CAACoE,cAAc,CAACC,EAAE;UAC/BG,OAAO,EAAEtE,KAAK,CAACuE,MAAM,CAACT,IAAI,CAACO,KAAK;SACjC,CAAC;QACF,IAAI,CAACzC,IAAI,CAAC4B,YAAY,CAAC,YAAY,EAAE,gBAAgB,CAAC;QACtD,IAAI,CAAC5B,IAAI,CAAC4B,YAAY,CAAC,oBAAoB,EAAE,IAAI,CAAC;MACpD,CAAC,MAAM;QACL,MAAMgB,UAAU,GAAGxE,KAAK,CAACyE,YAAY,CAACX,IAAI,CAACO,KAAK,CAAC,CAAC,CAAC,CAAC;QACpD,IAAIG,UAAU,EAAE;UACdA,UAAU,CAACE,KAAK,GAAG1E,KAAK,CAACuE,MAAM,CAACT,IAAI,CAACO,KAAK,EAAE;YAAEM,gBAAgB,EAAE;UAAI,CAAE,CAAC;UACvE,IAAI,CAAC/C,IAAI,CAACgD,eAAe,CAACJ,UAAU,EAAET,MAAM,CAAC;UAC7C,IAAI,CAACnC,IAAI,CAACoC,SAAS,CAAC;YAClBC,IAAI,EAAEnE,OAAO,CAACoE,cAAc,CAACW,KAAK;YAClCP,OAAO,EAAEE,UAAU,CAACF;WACrB,CAAC;QACJ,CAAC,MAAM;UACL;UACA,IAAI,CAAC1C,IAAI,CAACoC,SAAS,CAAC;YAAEC,IAAI,EAAEnE,OAAO,CAACoE,cAAc,CAACC;UAAE,CAAE,CAAC;QAC1D;MACF;IACF;IACA,IAAI,CAACvC,IAAI,CAACgC,GAAG,CAACG,MAAM,CAAC;EACvB;EAEAe,KAAKA,CAACxD,IAAY,EAAEgB,SAAiB,EAAEP,UAAoC;IACzE,IAAI,CAACH,IAAI,CAACmD,QAAQ,CAChBzD,IAAI,EACJS,UAAU,GAAGtB,kBAAkB,CAACsB,UAAU,CAAC,GAAGc,SAAS,EACvDrC,aAAa,CAAC8B,SAAS,CAAC,CACzB;EACH;;AAGF;AACA,OAAO,MAAM0C,cAAc,gBAAG/E,OAAO,CAACgF,UAAU,CAC9C,iDAAiD,CAClD;AAED;AACA,OAAO,MAAMC,MAAM,gBAAGjF,OAAO,CAACgF,UAAU,CAA6B,yCAAyC,CAAC;AAE/G;AACA,OAAO,MAAME,IAAI,gBAAGjF,MAAM,CAACwC,GAAG,CAACwC,MAAM,EAAG7C,MAAM,IAC5C/B,YAAY,CAAC6E,IAAI,CAAC;EAChBvD,IAAIA,CAACN,IAAI,EAAEC,MAAM,EAAEC,OAAO,EAAEC,KAAK,EAAEa,SAAS,EAAEZ,IAAI;IAChD,OAAO,IAAIL,QAAQ,CACjBvB,OAAO,CAAC0B,OAAO,EACfa,MAAM,EACNf,IAAI,EACJC,MAAM,EACNC,OAAO,EACPC,KAAK,CAAC2D,KAAK,EAAE,EACb9C,SAAS,EACTZ,IAAI,CACL;EACH,CAAC;EACDF,OAAOA,CAAC6D,SAAS,EAAEC,KAAK;IACtB,MAAMC,WAAW,GAAGD,KAAK,CAACC,WAAW;IAErC,IAAIA,WAAW,KAAK1C,SAAS,EAAE;MAC7B,OAAOwC,SAAS,EAAE;IACpB;IAEA,OAAOvF,OAAO,CAAC0B,OAAO,CAACgE,IAAI,CACzB1C,eAAe,CAAChD,OAAO,CAAC0B,OAAO,CAACe,MAAM,EAAE,EAAEgD,WAAW,CAAC,EACtDF,SAAS,CACV;EACH;CACD,CAAC,CAAC;AAEL;AACA,OAAO,MAAMI,aAAa,gBAAGxF,OAAO,CAACgF,UAAU,CAC7C,6CAA6C,CAC9C;AAED;AACA,OAAO,MAAMS,aAAa,gBAAGzF,OAAO,CAACgF,UAAU,CAC7C,6CAA6C,CAC9C;AAED;AACA,OAAO,MAAMU,gBAAgB,GAAIC,OAKhC,IAA+B;EAC9B,IAAIpE,OAAO,GAAGvB,OAAO,CAAC4F,KAAK,EAAE;EAE7B,IAAID,OAAO,CAACzC,UAAU,EAAE;IACtB3B,OAAO,GAAGvB,OAAO,CAAC6F,GAAG,CAACtE,OAAO,EAAEiE,aAAa,EAAEG,OAAO,CAACzC,UAAU,CAAC;EACnE;EAEA,IAAI,OAAOyC,OAAO,CAACG,UAAU,KAAK,QAAQ,EAAE;IAC1CvE,OAAO,GAAGnB,MAAM,CAAC2F,KAAK,CAACC,gBAAgB,CAACL,OAAO,CAACG,UAAU,CAAC,EAAE;MAC3DG,MAAM,EAAEA,CAAA,KAAM1E,OAAO;MACrB2E,MAAM,EAAGJ,UAAU,IAAK9F,OAAO,CAAC6F,GAAG,CAACtE,OAAO,EAAEkE,aAAa,EAAEK,UAAU;KACvE,CAAC;EACJ,CAAC,MAAM,IAAIH,OAAO,CAACG,UAAU,EAAE;IAC7BvE,OAAO,GAAGvB,OAAO,CAAC6F,GAAG,CAACtE,OAAO,EAAEkE,aAAa,EAAEE,OAAO,CAACG,UAAU,CAAC;EACnE;EAEA,OAAO;IACLpE,IAAI,EAAE,cAAc;IACpBG,OAAO,EAAE8D,OAAO,CAAC9D,OAAO;IACxBD,MAAM,EAAE+D,OAAO,CAAC/D,MAAM;IACtBI,OAAO,EAAE2D,OAAO,CAACzC,UAAU,GACvB,CAACyC,OAAO,CAACzC,UAAU,GAAGrD,OAAO,CAACsD,UAAU,CAACC,OAAO,MAAMvD,OAAO,CAACsD,UAAU,CAACC,OAAO,GAChF,IAAI;IACR7B;GACD;AACH,CAAC;AAED;AACA,OAAO,MAAM4E,eAAe,gBAAGlG,MAAM,CAACmG,OAAO,CAC3CnG,MAAM,CAACqF,WAAW,EACjB3D,IAAI,IAAI;EACP,IAAIjB,cAAc,IAAIiB,IAAI,EAAE;IAC1B,OAAO1B,MAAM,CAACoG,OAAO,CAAE1E,IAAiB,CAACA,IAAI,CAAC;EAChD;EACA,OAAO1B,MAAM,CAACqG,IAAI,CAAC,IAAIvG,KAAK,CAACwG,sBAAsB,EAAE,CAAC;AACxD,CAAC,CACF;AAED;AACA,OAAO,MAAMC,mBAAmB,gBAAGrG,KAAK,CAACsG,IAAI,CAC3C1B,cAAc,EACd,MAAMlF,OAAO,CAACkD,KAAK,CAAC2D,iBAAiB,EAAE,CACxC;AAED;AACA,OAAO,MAAMC,WAAW,gBAAGxG,KAAK,CAACyG,MAAM,CACrC3B,MAAM,eACNhF,MAAM,CAACmG,OAAO,cACZnG,MAAM,CAAC4G,GAAG,CAACvG,QAAQ,EAAEyE,cAAc,CAAC,EACpC,CAAC,CAAC+B,QAAQ,EAAEC,QAAQ,CAAC,KACnB9G,MAAM,CAACwG,IAAI,CAAC,MACVM,QAAQ,CAACC,SAAS,CAChBF,QAAQ,CAAChF,UAAU,CAAChC,WAAW,CAACmH,iBAAiB,CAAW,EAC5DH,QAAQ,CAAChF,UAAU,CAAChC,WAAW,CAACoH,oBAAoB,CAAW,CAChE,CACF,CACJ,CACF;AAED;AACA,OAAO,MAAMC,iBAAiB,gBAAGR,WAAW,CAACS,IAAI,cAC/CjH,KAAK,CAACkH,OAAO,CAACb,mBAAmB,CAAC,CACnC;AAED;AACA,OAAO,MAAMc,WAAW,gBAAGnH,KAAK,CAACoH,YAAY,CAACtH,MAAM,CAACwC,GAAG,CAACyC,IAAI,EAAE/E,KAAK,CAACqH,SAAS,CAAC,CAAC,CAACJ,IAAI,cACnFjH,KAAK,CAACsH,YAAY,CAACN,iBAAiB,CAAC,CACtC;AAED;AACA,OAAO,MAAMO,sBAAsB,gBAAGvH,KAAK,CAACoH,YAAY,cAACtH,MAAM,CAACwC,GAAG,CAACyC,IAAI,EAAE/E,KAAK,CAACqH,SAAS,CAAC,CAAC;AAE3F;AACA,OAAO,MAAMG,KAAK,gBAAGD,sBAAsB,CAACN,IAAI,cAC9CjH,KAAK,CAACsH,YAAY,CAACd,WAAW,CAAC,CAChC;AAED;AACA;AACA;AAEA,MAAMX,gBAAgB,gBAAG5F,MAAM,CAACwH,aAAa,CAAC/H,OAAO,CAACmG,gBAAgB,CAAC;AAEvE,MAAMnD,eAAe,GAAGA,CACtBgF,WAA4B,EAC5BlG,IAA0B,EAC1BJ,OAAgC,KAEhCI,IAAI,YAAYP,QAAQ,GACtBvB,OAAO,CAACkD,KAAK,CAAC+E,OAAO,CAACD,WAAW,EAAElG,IAAI,CAACA,IAAI,CAAC,GAC7C9B,OAAO,CAACkD,KAAK,CAACgF,cAAc,CAACF,WAAW,EAAElF,eAAe,CAAChB,IAAI,EAAEJ,OAAO,CAAC,CAAC;AAE7E,MAAMoB,eAAe,GAAGA,CAAChB,IAA0B,EAAEJ,OAAgC,MAA2B;EAC9GK,MAAM,EAAED,IAAI,CAACC,MAAM;EACnBC,OAAO,EAAEF,IAAI,CAACE,OAAO;EACrBmG,QAAQ,EAAErG,IAAI,CAACD,IAAI,KAAK,cAAc;EACtCwB,UAAU,EAAE9C,MAAM,CAAC6H,SAAS,CAC1B1G,OAAO,GACL2G,eAAe,CAACvG,IAAI,EAAEJ,OAAO,EAAEiE,aAAa,CAAC,GAC7CxF,OAAO,CAACmI,SAAS,CAACxG,IAAI,CAACJ,OAAO,EAAEiE,aAAa,CAAC,EAChD,MAAM3F,OAAO,CAACsD,UAAU,CAACC,OAAO,CACjC;EACD0C,UAAU,EAAE1F,MAAM,CAACgI,cAAc,CAC/B7G,OAAO,GACL2G,eAAe,CAACvG,IAAI,EAAEJ,OAAO,EAAEkE,aAAa,CAAC,GAC7CzF,OAAO,CAACmI,SAAS,CAACxG,IAAI,CAACJ,OAAO,EAAEkE,aAAa,CAAC;CAEnD,CAAC;AAEF,MAAMyC,eAAe,GAAGA,CACtB5G,MAA4B,EAC5BC,OAA+B,EAC/B8G,GAAsB,KAEtBjI,MAAM,CAACkI,MAAM,CACXtI,OAAO,CAACmI,SAAS,CAAC5G,OAAO,EAAE8G,GAAG,CAAC,EAC/B,MAAMrI,OAAO,CAACmI,SAAS,CAAC7G,MAAM,CAACC,OAAO,EAAE8G,GAAG,CAAC,CAC7C;AAEH;AACA,OAAO,MAAME,eAAe,gBAAGrI,IAAI,CAQjC,CAAC,EAAE,CACH0G,MAA8B,EAC9B3D,WAAgC,KAEhChD,MAAM,CAACuI,cAAc,CAAC5B,MAAM,EAAElB,gBAAgB,CAACzC,WAAW,CAAC,CAAC,CAAC","ignoreList":[]}
\ No newline at end of file
+{"version":3,"file":"tracer.js","names":["OtelApi","OtelSemConv","Cause","Context","Effect","dual","Layer","Option","EffectTracer","Resource","nanosToHrTime","recordToAttributes","unknownToAttributeValue","OtelSpanTypeId","Symbol","for","kindMap","SpanKind","INTERNAL","CLIENT","SERVER","PRODUCER","CONSUMER","getOtelParent","tracer","otelContext","context","active","getSpan","otelParent","spanContext","undefined","some","externalSpan","spanId","traceId","sampled","traceFlags","none","OtelSpan","name","links","kind","_tag","span","attributes","Map","parent","status","constructor","contextApi","traceApi","effectParent","startTime","options","root","startSpan","length","map","link","makeSpanContext","populateContext","value","trace","deleteSpan","TraceFlags","SAMPLED","attribute","key","setAttribute","set","addLinks","push","end","endTime","exit","hrTime","setStatus","code","SpanStatusCode","OK","isInterruptedOnly","cause","message","pretty","firstError","prettyErrors","stack","renderErrorCause","recordException","ERROR","event","addEvent","TracerProvider","GenericTag","Tracer","make","slice","execution","fiber","currentSpan","with","traceFlagsTag","traceStateTag","makeExternalSpan","empty","add","traceState","match","createTraceState","onNone","onSome","currentOtelSpan","flatMap","succeed","fail","NoSuchElementException","layerGlobalProvider","sync","getTracerProvider","layerTracer","effect","zip","resource","provider","getTracer","ATTR_SERVICE_NAME","ATTR_SERVICE_VERSION","layerGlobalTracer","pipe","provide","layerGlobal","unwrapEffect","setTracer","provideMerge","layerWithoutOtelTracer","layer","liftThrowable","setSpan","setSpanContext","isRemote","getOrElse","extractTraceTag","getOption","getOrUndefined","tag","orElse","withSpanContext","withParentSpan"],"sources":["../../../src/internal/tracer.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/package.json b/package.json
index 9cd610a61f501cd113dd05e6c551654c8b39471d..4b1b477d586813f2624cbf5312f8cacae9b9d74f 100644
--- a/package.json
+++ b/package.json
@@ -19,8 +19,8 @@
     "@opentelemetry/sdk-trace-web": "^2.0.0",
     "@opentelemetry/sdk-logs": "^0.203.0",
     "@opentelemetry/semantic-conventions": "^1.33.0",
-    "@effect/platform": "^0.90.6",
-    "effect": "^3.17.10"
+    "@effect/platform": "workspace:^",
+    "effect": "workspace:^"
   },
   "peerDependenciesMeta": {
     "@opentelemetry/api": {
diff --git a/src/internal/tracer.ts b/src/internal/tracer.ts
index f0eaeeedb938e778c2bdcf7682fbe214361ab6b6..dfb4bf53d7005cfc93c0969822bc4445428522c2 100644
--- a/src/internal/tracer.ts
+++ b/src/internal/tracer.ts
@@ -22,6 +22,21 @@ const kindMap = {
   "consumer": OtelApi.SpanKind.CONSUMER
 }
 
+const getOtelParent = (tracer: OtelApi.TraceAPI, otelContext: OtelApi.Context, context: Context.Context<never>) => {
+  const active = tracer.getSpan(otelContext)
+  const otelParent = active ? active.spanContext() : undefined
+  return otelParent
+    ? Option.some(
+      EffectTracer.externalSpan({
+        spanId: otelParent.spanId,
+        traceId: otelParent.traceId,
+        sampled: (otelParent.traceFlags & 1) === 1,
+        context
+      })
+    )
+    : Option.none()
+}
+
 /** @internal */
 export class OtelSpan implements EffectTracer.Span {
   readonly [OtelSpanTypeId]: typeof OtelSpanTypeId
@@ -32,20 +47,28 @@ export class OtelSpan implements EffectTracer.Span {
   readonly traceId: string
   readonly attributes = new Map<string, unknown>()
   readonly sampled: boolean
+  readonly parent: Option.Option<EffectTracer.AnySpan>
   status: EffectTracer.SpanStatus
 
   constructor(
     contextApi: OtelApi.ContextAPI,
+    traceApi: OtelApi.TraceAPI,
     tracer: OtelApi.Tracer,
     readonly name: string,
-    readonly parent: Option.Option<EffectTracer.AnySpan>,
+    effectParent: Option.Option<EffectTracer.AnySpan>,
     readonly context: Context.Context<never>,
     readonly links: Array<EffectTracer.SpanLink>,
     startTime: bigint,
-    readonly kind: EffectTracer.SpanKind
+    readonly kind: EffectTracer.SpanKind,
+    options?: EffectTracer.SpanOptions
   ) {
     this[OtelSpanTypeId] = OtelSpanTypeId
     const active = contextApi.active()
+    this.parent = effectParent._tag === "Some"
+      ? effectParent
+      : (options?.root !== true)
+      ? getOtelParent(traceApi, active, context)
+      : Option.none()
     this.span = tracer.startSpan(
       name,
       {
@@ -58,8 +81,8 @@ export class OtelSpan implements EffectTracer.Span {
           : undefined as any,
         kind: kindMap[this.kind]
       },
-      parent._tag === "Some"
-        ? populateContext(active, parent.value, context)
+      this.parent._tag === "Some"
+        ? populateContext(active, this.parent.value, context)
         : OtelApi.trace.deleteSpan(active)
     )
     const spanContext = this.span.spanContext()
@@ -143,16 +166,18 @@ export const Tracer = Context.GenericTag<OtelTracer, OtelApi.Tracer>("@effect/op
 /** @internal */
 export const make = Effect.map(Tracer, (tracer) =>
   EffectTracer.make({
-    span(name, parent, context, links, startTime, kind) {
+    span(name, parent, context, links, startTime, kind, options) {
       return new OtelSpan(
         OtelApi.context,
+        OtelApi.trace,
         tracer,
         name,
         parent,
         context,
         links.slice(),
         startTime,
-        kind
+        kind,
+        options
       )
     },
     context(execution, fiber) {
